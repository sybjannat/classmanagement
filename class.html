<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>YE-48 — Class Management</title>
    <!-- Fonts & Icons -->
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900&f[]=inter@400,500,600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        html {
            overflow-x: hidden;
        }

        body {
            background-color: #F8FAFC;
            background-image:
                linear-gradient(rgba(148, 163, 184, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(148, 163, 184, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            color: #1E293B;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* App container - hidden by default until authenticated */
        #app {
            display: none;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Auth page - shown by default */
        #authPage {
            display: flex;
            min-height: 100vh;
        }

        /* custom scroll - hidden */
        ::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
        }

        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        h1,
        h2,
        h3,
        h4,
        .satoshi {
            font-family: 'Satoshi', sans-serif;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: #0F172A;
        }

        /* clean glass card - light version */
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 28px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.03), 0 2px 8px rgba(0, 0, 0, 0.02);
            transition: all 0.2s ease;
        }

        .glass:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.08), 0 8px 20px rgba(0, 0, 0, 0.02);
            border-color: rgba(99, 102, 241, 0.2);
        }

        /* clean gradient - softer */
        .gradient-bg {
            background: linear-gradient(135deg, #6366F1, #8B5CF6, #EC4899);
            background-size: 200% 200%;
            animation: shimmer 6s ease infinite;
            border: none;
            color: white;
            font-weight: 500;
            transition: all 0.2s;
        }

        .gradient-bg:hover {
            filter: brightness(1.05);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
        }

        /* soft gradient for cards */
        .soft-gradient {
            background: linear-gradient(145deg, #FFFFFF, #F1F5F9);
        }

        @keyframes shimmer {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* subject colors - modern gradient & animated */
        .subject-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 18px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .subject-pill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }

        .subject-pill:hover::before {
            left: 100%;
        }

        .subject-pill:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .subject-physics {
            color: white;
            background: linear-gradient(135deg, #0891B2 0%, #06B6D4 50%, #22D3EE 100%);
            background-size: 200% 200%;
            border: none;
            box-shadow: 0 4px 15px rgba(8, 145, 178, 0.4);
            animation: gradient-shift 3s ease infinite;
        }

        .subject-math {
            color: white;
            background: linear-gradient(135deg, #7C3AED 0%, #8B5CF6 50%, #A78BFA 100%);
            background-size: 200% 200%;
            border: none;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
            animation: gradient-shift 3.5s ease infinite;
        }

        .subject-cse {
            color: white;
            background: linear-gradient(135deg, #059669 0%, #10B981 50%, #34D399 100%);
            background-size: 200% 200%;
            border: none;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
            animation: gradient-shift 4s ease infinite;
        }

        .subject-chemistry {
            color: white;
            background: linear-gradient(135deg, #DC2626 0%, #EF4444 50%, #F87171 100%);
            background-size: 200% 200%;
            border: none;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
            animation: gradient-shift 3.2s ease infinite;
        }

        /* inner gradient shift animation */
        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* floating animation for schedule items */
        @keyframes card-float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .schedule-item {
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .schedule-item:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .subject-english {
            color: #D97706;
            background: #FEF3C7;
            border-left: 4px solid #D97706;
        }

        /* priority badges - cleaner */
        .badge-priority-high {
            background: #FEF2F2;
            color: #DC2626;
            border: 1px solid #FECACA;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-priority-medium {
            background: #FFFBEB;
            color: #D97706;
            border: 1px solid #FDE68A;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-priority-low {
            background: #F0FDF4;
            color: #059669;
            border: 1px solid #BBF7D0;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* layout */
        /* #app is hidden by default until authenticated (see line 35-40) */

        /* sidebar - light & clean */
        .sidebar {
            width: 280px;
            transition: width 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(24px);
            border-right: 1px solid rgba(203, 213, 225, 0.4);
            padding: 28px 20px;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar.collapsed .logo span,
        .sidebar.collapsed .nav-label,
        .sidebar.collapsed .cr-badge {
            display: none;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            margin-bottom: 40px;
            padding-left: 8px;
        }

        .logo i {
            font-size: 2rem;
            background: linear-gradient(135deg, #6366F1, #EC4899);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .logo span {
            color: #0F172A;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 18px;
            border-radius: 20px;
            color: #475569;
            transition: all 0.2s;
            margin: 4px 0;
            cursor: pointer;
            font-weight: 500;
        }

        .nav-item i {
            font-size: 1.3rem;
            width: 24px;
            color: #64748B;
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            color: #4F46E5;
            position: relative;
            overflow: hidden;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #6366F1, #8B5CF6);
            border-radius: 0 4px 4px 0;
        }

        .nav-item.active i {
            color: #4F46E5;
            transform: scale(1.1);
            transition: transform 0.3s ease;
        }

        .nav-item:hover:not(.active) {
            background: rgba(241, 245, 249, 0.8);
            color: #334155;
            transform: translateX(4px);
        }

        .nav-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .cr-section {
            margin-top: auto;
            border-top: 1px solid #E2E8F0;
            padding-top: 20px;
        }

        /* topbar - clean */
        .topbar {
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid #E2E8F0;
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .search-bar {
            background: white;
            border-radius: 60px;
            padding: 10px 24px;
            width: 360px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid #E2E8F0;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.02);
        }

        .search-bar:focus-within {
            border-color: #6366F1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: #1E293B;
            width: 100%;
            outline: none;
            font-size: 0.95rem;
        }

        .search-bar input::placeholder {
            color: #94A3B8;
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 44px;
            background: linear-gradient(145deg, #6366F1, #8B5CF6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            position: relative;
            font-size: 1rem;
        }

        .cr-badge {
            position: absolute;
            bottom: -2px;
            right: -2px;
            background: white;
            color: #8B5CF6;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 40px;
            font-weight: 700;
            border: 2px solid #8B5CF6;
        }

        .logo-mobile {
            display: none;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #F3F4F6, #E5E7EB);
            border-radius: 14px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .notification-bell:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #6366F1, #8B5CF6);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .notification-bell:hover i {
            color: white !important;
        }

        .notification-bell i {
            font-size: 1.3rem;
            color: #4B5563;
            transition: all 0.3s ease;
        }

        .notification-bell:active {
            transform: scale(0.95);
        }

        .notification-bell.clicked {
            animation: bell-ring 0.5s ease;
        }

        @keyframes bell-ring {
            0% {
                transform: rotate(0);
            }

            20% {
                transform: rotate(-15deg);
            }

            40% {
                transform: rotate(15deg);
            }

            60% {
                transform: rotate(-10deg);
            }

            80% {
                transform: rotate(10deg);
            }

            100% {
                transform: rotate(0);
            }
        }

        .red-dot {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, #EF4444, #F97316);
            border-radius: 50%;
            border: 2.5px solid white;
            animation: dot-pulse 1.5s ease-in-out infinite;
            box-shadow: 0 3px 10px rgba(239, 68, 68, 0.6);
            z-index: 10;
        }

        @keyframes dot-pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.4);
                opacity: 0.85;
            }
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #EF4444, #F97316);
            color: white;
            border-radius: 10px;
            border: 2px solid white;
            font-size: 0.7rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
            animation: badge-bounce 2s ease-in-out infinite;
            z-index: 10;
            padding: 0 5px;
        }

        @keyframes badge-bounce {

            0%,
            100% {
                transform: scale(1) translateY(0);
            }

            50% {
                transform: scale(1.15) translateY(-3px);
            }
        }

        /* main content */
        .main-content {
            flex: 1;
            padding: 32px 40px;
            max-width: 1440px;
            margin: 0 0 0 280px;
            width: calc(100% - 280px);
            overflow-y: auto;
        }

        /* grid & cards */
        .grid-dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 28px;
            margin-top: 32px;
        }

        .pulse-card {
            background: white;
            border-radius: 32px;
            padding: 24px;
            border: 1px solid #F1F5F9;
            transition: all 0.25s;
            cursor: pointer;
            animation: fadeUp 0.4s ease forwards;
            opacity: 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
        }

        .pulse-card h3 {
            font-size: 1.2rem;
            margin-bottom: 16px;
            color: #1E293B;
        }

        @keyframes fadeUp {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .live-pulse {
            position: relative;
            color: #059669;
            font-weight: 600;
            font-size: 0.85rem;
            background: #D1FAE5;
            padding: 4px 12px;
            border-radius: 40px;
        }

        .live-pulse::after {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #059669;
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        /* hero - clean */
        .hero-wave {
            background: linear-gradient(145deg, #EEF2FF, #F5F3FF);
            border-radius: 48px;
            padding: 48px 40px;
            margin-bottom: 40px;
            border: 1px solid #E0E7FF;
            position: relative;
            overflow: hidden;
        }

        /* mobile bottom nav */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            backdrop-filter: blur(24px);
            border-top: 1px solid rgba(226, 232, 240, 0.8);
            padding: 16px 24px;
            justify-content: space-around;
            z-index: 100;
            box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.08);
        }

        .bottom-nav i {
            font-size: 1.5rem;
            color: #94A3B8;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            padding: 10px;
            border-radius: 16px;
        }

        .bottom-nav i:hover {
            transform: translateY(-3px);
        }

        .bottom-nav i.active {
            color: #6366F1;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .bottom-nav i.active::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: linear-gradient(135deg, #6366F1, #8B5CF6);
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(99, 102, 241, 0.6);
        }

        /* FAB for CR - clean */
        .fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 56px;
            height: 56px;
            border-radius: 56px;
            background: linear-gradient(145deg, #6366F1, #8B5CF6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
            cursor: pointer;
            transition: all 0.2s;
            z-index: 90;
            border: none;
        }

        .fab:hover {
            transform: scale(1.05) rotate(90deg);
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.4);
        }

        /* mobile */
        @media (max-width: 900px) {
            .sidebar {
                display: none;
            }

            .bottom-nav {
                display: flex;
            }

            .main-content {
                padding: 20px;
                margin-bottom: 80px;
            }

            .grid-dashboard {
                grid-template-columns: 1fr;
            }

            .search-bar {
                width: 200px;
            }

            .topbar {
                padding: 0 16px;
            }
        }

        /* notes masonry */
        .notes-masonry {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .subject-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 700;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }

        .subject-pill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }

        .subject-pill:hover::before {
            left: 100%;
        }

        .subject-pill:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        /* routine table - clean */
        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 16px;
            margin: 24px 0;
        }

        .day-col {
            background: white;
            border-radius: 28px;
            padding: 20px 12px;
            min-height: 400px;
            border: 1px solid #F1F5F9;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.02);
        }

        .today-col {
            border: 2px solid #6366F1;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
        }

        /* modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(6px);
            z-index: 200;
            display: none;
            place-items: center;
        }

        .modal-content {
            max-width: 500px;
            width: 90%;
            padding: 32px;
            background: white;
            border-radius: 40px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.08);
            border: 1px solid #F1F5F9;
        }

        /* Modern Delete Confirmation Popup */
        .delete-confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 300;
            display: none;
            place-items: center;
            animation: fadeIn 0.2s ease;
        }

        .delete-confirm-overlay.show {
            display: grid;
        }

        .delete-confirm-overlay.hiding {
            animation: fadeOut 0.2s ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        @keyframes pulse-alert {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }

        @keyframes pulse-join {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
            }
        }

        .delete-confirm-modal {
            background: white;
            border-radius: 28px;
            padding: 48px;
            max-width: 420px;
            width: 90%;
            text-align: center;
            box-shadow:
                0 25px 50px -12px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(0, 0, 0, 0.05);
            animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .delete-confirm-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #DC2626, #EF4444, #DC2626);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .delete-confirm-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 28px;
            background: linear-gradient(135deg, #FEE2E2, #FECACA);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 30px rgba(220, 38, 38, 0.25);
            position: relative;
        }

        .delete-confirm-icon::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px dashed #DC2626;
            opacity: 0.3;
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .delete-confirm-icon i {
            font-size: 42px;
            color: #DC2626;
            position: relative;
            z-index: 1;
        }

        .delete-confirm-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: #0F172A;
            margin-bottom: 12px;
            font-family: 'Satoshi', sans-serif;
            letter-spacing: -0.02em;
        }

        .delete-confirm-message {
            color: #64748B;
            font-size: 1.05rem;
            line-height: 1.7;
            margin-bottom: 36px;
        }

        .delete-confirm-buttons {
            display: flex;
            gap: 16px;
        }

        .delete-confirm-buttons button {
            flex: 1;
            padding: 16px 28px;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            position: relative;
            overflow: hidden;
        }

        .delete-confirm-cancel {
            background: linear-gradient(135deg, #F8FAFC, #F1F5F9);
            color: #475569;
            border: 2px solid #E2E8F0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .delete-confirm-cancel:hover {
            background: linear-gradient(135deg, #F1F5F9, #E2E8F0);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }

        .delete-confirm-delete {
            background: linear-gradient(135deg, #DC2626 0%, #EF4444 50%, #DC2626 100%);
            background-size: 200% 100%;
            color: white;
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.4);
        }

        .delete-confirm-delete:hover {
            background-position: 100% 0;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(220, 38, 38, 0.5);
        }

        .delete-confirm-delete:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
        }

        /* Modern Toast Notifications */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 400;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            border-radius: 16px;
            background: white;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            max-width: 400px;
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: auto;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.hide {
            transform: translateX(120%);
            opacity: 0;
        }

        .toast-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-icon i {
            font-size: 20px;
            color: white;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 700;
            font-size: 0.95rem;
            color: #0F172A;
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 0.85rem;
            color: #64748B;
        }

        .toast-close {
            background: none;
            border: none;
            color: #94A3B8;
            cursor: pointer;
            padding: 4px;
            font-size: 14px;
            transition: color 0.2s;
            pointer-events: auto;
        }

        .toast-close:hover {
            color: #475569;
        }

        /* Toast types */
        .toast-success .toast-icon {
            background: linear-gradient(135deg, #10B981, #34D399);
        }

        .toast-error .toast-icon {
            background: linear-gradient(135deg, #EF4444, #F87171);
        }

        .toast-warning .toast-icon {
            background: linear-gradient(135deg, #F59E0B, #FBBF24);
        }

        .toast-info .toast-icon {
            background: linear-gradient(135deg, #3B82F6, #60A5FA);
        }

        /* utility */
        .text-secondary {
            color: #64748B;
        }

        .mt-4 {
            margin-top: 20px;
        }

        .mb-2 {
            margin-bottom: 10px;
        }

        .flex {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .font-bold {
            font-weight: 600;
        }

        .text-sm {
            font-size: 0.9rem;
        }

        /* ========== RESPONSIVE STYLES ========== */
        .dashboard-grid {
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr !important;
            }
        }

        .stats-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        @media (max-width: 900px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        @media (max-width: 500px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }

            .stats-grid>div {
                padding: 12px !important;
                border-radius: 16px !important;
            }

            .stats-grid>div>div:first-child {
                font-size: 1.5rem !important;
            }

            .stats-grid>div i {
                font-size: 1.2rem !important;
                margin-bottom: 4px !important;
                display: block !important;
            }

            .stats-grid>div>span:last-child,
            .stats-grid>div .stat-label {
                font-size: 0.65rem !important;
            }
        }

        /* Tablet and below */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px !important;
            }

            .sidebar .logo span,
            .sidebar nav .nav-item span,
            .sidebar .role-badge {
                display: none;
            }

            .sidebar .logo {
                justify-content: center;
            }

            .main-content {
                margin-left: 80px !important;
            }
        }

        /* Fix overflow for medium screens (760px - 1020px) */
        @media (min-width: 761px) and (max-width: 1020px) {

            html,
            body {
                overflow-x: hidden !important;
                max-width: 100vw !important;
            }

            #app {
                max-width: 100% !important;
                overflow-x: hidden !important;
            }

            .main-content {
                overflow-x: hidden !important;
                max-width: 100% !important;
                padding: 16px !important;
            }

            .notice-card,
            .notice-card-vertical,
            [class*="card"] {
                max-width: 100% !important;
                overflow: hidden !important;
                box-sizing: border-box !important;
            }

            .notice-card-vertical {
                min-height: auto !important;
            }
        }

        /* Large mobile and below (max-width: 768px) */
        @media (max-width: 768px) {
            .sidebar {
                width: 100% !important;
                height: auto !important;
                position: fixed !important;
                bottom: 0 !important;
                top: auto !important;
                left: 0 !important;
                flex-direction: row !important;
                justify-content: space-around;
                padding: 10px !important;
                z-index: 1000;
                border-radius: 20px 20px 0 0;
            }

            .sidebar .logo,
            .sidebar .role-badge,
            .sidebar .theme-toggle {
                display: none !important;
            }

            .logo-mobile {
                display: flex !important;
            }

            .sidebar nav {
                flex-direction: row !important;
                gap: 0 !important;
            }

            .sidebar .nav-item {
                padding: 12px !important;
            }

            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                padding: 16px !important;
            }

            .hero-wave,
            [class*="hero"] {
                padding: 24px !important;
            }

            h1,
            .satoshi {
                font-size: 1.5rem !important;
            }

            .grid-dashboard {
                grid-template-columns: 1fr !important;
            }
        }

        /* Small mobile (max-width: 480px) */
        @media (max-width: 480px) {
            .main-content {
                padding: 12px !important;
            }

            .pulse-card,
            [class*="card"] {
                padding: 16px !important;
                border-radius: 16px !important;
            }

            .schedule-item {
                padding: 12px !important;
                border-radius: 12px !important;
            }

            .stats-grid,
            .grid-dashboard,
            [class*="grid"] {
                grid-template-columns: 1fr !important;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .flex {
                flex-direction: column;
                align-items: flex-start;
            }

            .flex[style*="justify-content: space-between"] {
                flex-direction: row !important;
                align-items: center !important;
            }

            .flex[style*="gap:"][style*="align-items: center"] {
                flex-direction: row !important;
            }

            /* Keep filter options in one line on mobile */
            .filter-container {
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 8px;
            }

            .filter-container::-webkit-scrollbar {
                height: 4px;
            }

            .filter-container::-webkit-scrollbar-thumb {
                background: #6366F1;
                border-radius: 4px;
            }

            .filter-container span {
                flex-shrink: 0 !important;
                white-space: nowrap;
                transition: none !important;
            }

            .filter-container span:hover {
                transform: none !important;
                box-shadow: none !important;
            }

            /* Notice card - priority and NEW in one line, mark as read right aligned */
            .notice-card-vertical .badge-row-mobile {
                flex-wrap: nowrap !important;
                display: flex !important;
            }

            .notice-card-vertical .mark-read-mobile {
                margin-left: auto !important;
                display: block !important;
            }

            .mobile-title {
                display: none !important;
            }

            @media (max-width: 480px) {
                .desktop-title {
                    display: none !important;
                }

                .mobile-title {
                    display: inline !important;
                }
            }

            .flex.flex-row {
                flex-direction: row !important;
                align-items: center !important;
            }

            .badge-priority-high,
            [class*="badge"] {
                font-size: 0.7rem !important;
                padding: 4px 8px !important;
            }

            /* Notice cards - smaller on mobile */
            .notice-card {
                padding: 16px !important;
                border-radius: 20px !important;
            }

            .notice-card h3 {
                font-size: 1.1rem !important;
            }

            .notice-card p {
                font-size: 0.85rem !important;
            }

            .modal-content {
                padding: 20px !important;
                border-radius: 20px !important;
            }

            input,
            select,
            textarea {
                font-size: 14px !important;
            }

            button {
                padding: 10px 16px !important;
                font-size: 0.9rem !important;
            }
        }

        /* Extra responsive improvements */
        @media (max-width: 600px) {
            .topbar {
                padding: 8px 12px !important;
                gap: 8px !important;
            }

            .notification-bell {
                width: 38px !important;
                height: 38px !important;
            }

            .notification-bell i {
                font-size: 1rem !important;
            }

            .notification-badge {
                min-width: 18px !important;
                height: 18px !important;
                font-size: 0.6rem !important;
            }

            #authButtonContainer button {
                padding: 6px 12px !important;
                font-size: 0.85rem !important;
            }

            #authButtonContainer>div {
                margin-right: 8px !important;
            }
        }

        @media (max-width: 400px) {
            .logo-mobile span {
                font-size: 1rem !important;
            }

            .notification-bell {
                width: 34px !important;
                height: 34px !important;
                border-radius: 10px !important;
            }
        }

        /* Modal responsive styles */
        @media (max-width: 500px) {

            #authPage>div,
            #profileModal>div {
                padding: 24px !important;
                border-radius: 20px !important;
                width: 95% !important;
                max-width: 95% !important;
            }

            #authPage h2,
            #profileModal h2 {
                font-size: 1.3rem !important;
            }

            #authPage input,
            #profileModal input {
                padding: 12px 14px !important;
                font-size: 0.9rem !important;
            }

            #authPage button,
            #profileModal button {
                padding: 12px !important;
                font-size: 0.9rem !important;
            }
        }

        /* Dashboard greeting responsive */
        @media (max-width: 600px) {
            [class*="hero"] {
                padding: 24px !important;
                border-radius: 20px !important;
            }

            [class*="hero"] h1,
            [class*="hero"] .satoshi {
                font-size: 1.5rem !important;
            }

            [class*="hero"] p {
                font-size: 0.95rem !important;
            }
        }

        /* Keep header elements horizontal */
        @media (max-width: 500px) {
            #authButtonContainer {
                flex-direction: row !important;
                align-items: center !important;
                gap: 8px !important;
            }

            #authButtonContainer>* {
                margin-right: 0 !important;
                flex-shrink: 0;
            }
        }

        /* Modern Notice Card Styles */
        .notice-card-modern {
            position: relative;
        }

        .notice-card-modern:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12) !important;
        }

        /* Mobile styles (< 480px) */
        @media (max-width: 480px) {
            .notice-card-modern {
                border-radius: 20px !important;
            }

            .notice-card-modern>div:first-child {
                padding: 12px 16px !important;
                flex-wrap: wrap;
                gap: 8px;
                border-radius: 20px 20px 0 0 !important;
            }

            .notice-card-modern>div:first-child span:first-child {
                font-size: 0.7rem !important;
                padding: 3px 10px !important;
            }

            .notice-card-modern>div:last-child {
                padding: 16px !important;
            }

            .notice-card-modern h3 {
                font-size: 1.1rem !important;
            }

            .notice-card-modern p {
                font-size: 0.9rem !important;
                margin-bottom: 16px !important;
            }

            .notice-card-modern a {
                padding: 10px 20px !important;
                font-size: 0.85rem !important;
            }

            .notice-card-footer {
                flex-direction: column !important;
                gap: 12px;
                align-items: flex-start !important;
            }

            .notice-card-footer .mark-read {
                width: 100%;
                text-align: center;
                background: #EEF2FF;
                padding: 10px;
                border-radius: 12px;
            }
        }

        /* Desktop styles (> 480px) */
        @media (min-width: 481px) {
            .notice-card-modern {
                max-width: 100%;
            }

            .notice-card-modern>div:first-child {
                padding: 16px 24px !important;
            }

            .notice-card-modern>div:last-child {
                padding: 24px !important;
            }

            .notice-card-footer {
                flex-direction: row !important;
            }
        }

        /* Notice cards responsive */
        @media (max-width: 600px) {
            [style*="border-radius: 28px"] {
                padding: 16px !important;
                border-radius: 20px !important;
            }

            [style*="border-radius: 28px"] h3 {
                font-size: 1.1rem !important;
            }
        }

        /* Remove hover animation from filter pills */
        .filter-container span {
            transition: none !important;
        }

        .filter-container span:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* Notice card link button - center on larger screens */
        @media screen and (min-width: 481px) {
            div.notice-link-container {
                text-align: center !important;
                width: 100%;
            }

            div.notice-link-container a {
                margin: 0 auto;
                display: inline-block !important;
            }

            /* Vertical layout for notice cards on larger screens */
            .notice-card-vertical {
                display: flex !important;
                flex-direction: column !important;
                justify-content: space-between !important;
                min-height: 200px;
            }

            .notice-card-vertical .notice-link-container {
                margin-top: auto;
                margin-bottom: auto;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- SIDEBAR (desktop) - Clean version -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <i class="fas fa-scroll"></i>
                <span class="satoshi">YE-48</span>
            </div>
            <nav>
                <div class="nav-item active" data-page="dashboard"><i class="fas fa-home"></i> <span
                        class="nav-label">Dashboard</span></div>

                <div class="nav-item" data-page="notices"><i class="fas fa-bell"></i> <span
                        class="nav-label">Notices</span></div>
                <div class="nav-item" data-page="notes"><i class="fas fa-folder"></i> <span
                        class="nav-label">Notes</span></div>
                <div class="nav-item" data-page="routine"><i class="fas fa-clipboard-list"></i> <span
                        class="nav-label">Class Test</span></div>
                <div class="nav-item" data-page="members"><i class="fas fa-user-cog"></i> <span
                        class="nav-label">Account</span></div>
            </nav>
            <div class="cr-section">
                <div class="nav-item" data-page="cr-mode"><i class="fas fa-user-cog"></i> <span class="nav-label">CR
                        mode</span></div>
            </div>
        </aside>

        <!-- RIGHT PANEL -->
        <div style="flex:1; display: flex; flex-direction: column; width: 100%;">
            <!-- TOP BAR - Clean -->
            <header class="topbar">
                <div class="flex" style="align-items: center; gap: 16px;">
                    <div class="logo-mobile" style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-scroll" style="font-size: 1.5rem; color: #6366F1;"></i>
                        <span class="satoshi" style="font-size: 1.2rem; font-weight: 700; color: #0F172A;">YE-48</span>
                    </div>
                    <i class="fas fa-bars" style="font-size: 1.5rem; display: none; color: #475569;"
                        id="menuToggle"></i>
                </div>
                <div class="flex" id="authButtonContainer">
                    <div class="notification-bell" onclick="currentPage='notices';renderNotices();">
                        <i class="far fa-bell"></i>
                        <span class="notification-badge" id="unreadBadge" style="display: none;">0</span>
                    </div>
                </div>
            </header>

            <!-- MAIN DYNAMIC CONTENT -->
            <main class="main-content" id="mainContent">
                <!-- Dashboard by default -->
            </main>
        </div>

        <!-- Mobile bottom nav - Clean -->
        <div class="bottom-nav">
            <i class="fas fa-home active" data-page="dashboard"></i>
            <i class="fas fa-calendar-alt" data-page="routine"></i>
            <i class="fas fa-bell" data-page="notices"></i>
            <i class="fas fa-folder" data-page="notes"></i>
            <i class="fas fa-user" data-page="members"></i>
        </div>



        <!-- modal overlay -->
        <div class="modal-overlay" id="modalOverlay">
            <div class="modal-content" id="modalInner">
                <!-- dynamic form -->
            </div>
        </div>

        <!-- Modern Delete Confirmation Popup -->
        <div class="delete-confirm-overlay" id="deleteConfirmOverlay">
            <div class="delete-confirm-modal">
                <div class="delete-confirm-icon">
                    <i class="fas fa-trash-alt"></i>
                </div>
                <h3 class="delete-confirm-title">Delete Forever?</h3>
                <p class="delete-confirm-message" id="deleteConfirmMessage">This action cannot be undone. Once you
                    delete this item, it's gone forever.</p>
                <div class="delete-confirm-buttons">
                    <button class="delete-confirm-cancel" onclick="closeDeleteConfirm()">Keep It</button>
                    <button class="delete-confirm-delete" id="deleteConfirmBtn"><i class="fas fa-trash-alt"></i>
                        Delete</button>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
    </div>

    <script>
        // ==================== SUPABASE CLIENT ====================
        const SUPABASE_URL = 'https://igfpnaboighqrivtniji.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnZnBuYWJvaWdocXJpdnRuaWppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NDE1NDcsImV4cCI6MjA4NzExNzU0N30.x214dTL53lmJ15tsKkcKLIdjfbuvJVPkNH_QG4NxhEY';

        function isSupabaseConfigured() {
            return SUPABASE_URL.includes('supabase.co') && SUPABASE_ANON_KEY.startsWith('eyJ');
        }

        const supabaseClient = {
            url: SUPABASE_URL,
            key: SUPABASE_ANON_KEY,

            async request(endpoint, options = {}) {
                const url = `${this.url}/rest/v1/${endpoint}`;
                const headers = {
                    'apikey': this.key,
                    'Authorization': `Bearer ${this.key}`,
                    'Content-Type': 'application/json',
                    'Prefer': options.prefer || 'return=representation'
                };

                try {
                    const response = await fetch(url, {
                        method: options.method || 'GET',
                        headers: { ...headers, ...options.headers },
                        body: options.body ? JSON.stringify(options.body) : null
                    });

                    const text = await response.text();

                    // Handle empty responses
                    if (!text || text === '') {
                        return [];
                    }

                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError, 'Response text:', text);
                        // If response is not JSON, but status is OK, return empty array
                        if (response.ok) {
                            return [];
                        }
                        throw new Error('Invalid JSON response: ' + text.substring(0, 100));
                    }

                    if (!response.ok) {
                        // Check for Supabase error format
                        const errorMsg = data.message || (data.error ? data.error : 'Request failed with status ' + response.status);
                        throw new Error(errorMsg);
                    }

                    return data;
                } catch (error) {
                    console.error('Supabase request error:', error);
                    throw error;
                }
            },

            async getSubjects() { return this.request('subjects?order=created_at'); },
            async addSubject(subject) { return this.request('subjects', { method: 'POST', body: subject }); },
            async updateSubject(id, updates) { return this.request(`subjects?id=eq.${id}`, { method: 'PATCH', body: updates }); },
            async deleteSubject(id) { return this.request(`subjects?id=eq.${id}`, { method: 'DELETE' }); },

            async getNotes() { return this.request('notes?order=created_at.desc'); },
            async addNote(note) { return this.request('notes', { method: 'POST', body: note }); },
            async updateNote(id, updates) { return this.request(`notes?id=eq.${id}`, { method: 'PATCH', body: updates }); },
            async deleteNote(id) { return this.request(`notes?id=eq.${id}`, { method: 'DELETE' }); },

            async getNotices() { return this.request('notices?order=created_at.desc'); },
            async addNotice(notice) { return this.request('notices', { method: 'POST', body: notice }); },
            async updateNotice(id, updates) { return this.request(`notices?id=eq.${id}`, { method: 'PATCH', body: updates }); },
            async deleteNotice(id) { return this.request(`notices?id=eq.${id}`, { method: 'DELETE' }); },

            // User authentication methods
            async getUserByStudentId(studentId) { return this.request(`users?student_id=eq.${studentId}&select=*`); },
            async createUser(userData) { return this.request('users', { method: 'POST', body: userData }); },
            async updateUser(id, updates) { return this.request(`users?id=eq.${id}`, { method: 'PATCH', body: updates }); },
            async getNoticeReadStatus(noticeId, userId) {
                if (noticeId) {
                    return this.request(`notice_read_status?notice_id=eq.${noticeId}&user_id=eq.${userId}&select=*`);
                } else {
                    return this.request(`notice_read_status?user_id=eq.${userId}&select=*`);
                }
            },
            async markNoticeRead(noticeId, userId) { return this.request('notice_read_status', { method: 'POST', body: { notice_id: noticeId, user_id: userId } }); },

            async getClassTests() { return this.request('class_tests?order=date'); },
            async addClassTest(test) { return this.request('class_tests', { method: 'POST', body: test }); },
            async updateClassTest(id, updates) { return this.request(`class_tests?id=eq.${id}`, { method: 'PATCH', body: updates }); },
            async deleteClassTest(id) { return this.request(`class_tests?id=eq.${id}`, { method: 'DELETE' }); },

            async getTodaysRoutine() { return this.request('todays_routine?order=slot_number'); },
            async deleteTodaysRoutine(id) { return this.request(`todays_routine?id=eq.${id}`, { method: 'DELETE' }); },

            async getWebsiteSettings() { const settings = await this.request('website_settings?limit=1'); return settings[0] || null; },
            async updateWebsiteSettings(id, updates) { return this.request(`website_settings?id=eq.${id}`, { method: 'PATCH', body: updates }); },

            async getMembers() { return this.request('members?order=created_at'); },
            async addMember(member) { return this.request('members', { method: 'POST', body: member }); },
            async deleteMember(id) { return this.request(`members?id=eq.${id}`, { method: 'DELETE' }); },

            // Clear all data from Supabase
            async clearAllData() {
                const tables = ['notice_read_status', 'subjects', 'notes', 'notices', 'class_tests', 'todays_routine', 'members', 'website_settings', 'users'];
                for (const table of tables) {
                    try {
                        // First get all records
                        const data = await this.request(`${table}?select=id`);
                        if (data && Array.isArray(data)) {
                            // Delete each record by ID
                            for (const item of data) {
                                try {
                                    await this.request(`${table}?id=eq.${item.id}`, { method: 'DELETE' });
                                } catch (e) {
                                    console.error(`Error deleting ${table} item ${item.id}:`, e);
                                }
                            }
                        }
                    } catch (error) {
                        console.error(`Error clearing ${table}:`, error);
                    }
                }
            }
        };

        window.supabaseClient = supabaseClient;
        window.isSupabaseConfigured = isSupabaseConfigured;
    </script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({ duration: 600, once: true, easing: 'ease-out' });

        // ---------- Modern Delete Confirmation ----------
        let deleteConfirmCallback = null;

        function showDeleteConfirm(message, onConfirm) {
            const overlay = document.getElementById('deleteConfirmOverlay');
            const messageEl = document.getElementById('deleteConfirmMessage');
            const deleteBtn = document.getElementById('deleteConfirmBtn');

            messageEl.textContent = message || 'Are you sure you want to delete this item? This action cannot be undone.';
            deleteConfirmCallback = onConfirm;

            // Remove any existing onclick handler and add new one
            deleteBtn.onclick = null;
            deleteBtn.onclick = () => {
                if (deleteConfirmCallback) {
                    deleteConfirmCallback();
                }
                closeDeleteConfirm();
            };

            overlay.classList.add('show');
        }

        function closeDeleteConfirm() {
            const overlay = document.getElementById('deleteConfirmOverlay');
            overlay.classList.remove('show');
            overlay.classList.add('hiding');
            setTimeout(() => {
                overlay.classList.remove('hiding');
            }, 200);
            deleteConfirmCallback = null;
        }

        // Close on overlay click
        document.getElementById('deleteConfirmOverlay').addEventListener('click', function (e) {
            if (e.target === this) {
                closeDeleteConfirm();
            }
        });

        // Close on Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeDeleteConfirm();
            }
        });

        // ---------- Toast Notifications ----------
        function showToast(options) {
            const { type = 'success', title, message, duration = 4000 } = options;
            const container = document.getElementById('toastContainer');

            const icons = {
                success: 'fa-check',
                error: 'fa-times',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${icons[type]}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(toast);

            // Animate in
            setTimeout(() => toast.classList.add('show'), 10);

            // Auto remove
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 400);
            }, duration);
        }

        // ---------- High Alert Notification System ----------
        let notificationPermission = Notification.permission;

        // Request notification permission
        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                notificationPermission = await Notification.requestPermission();
            }
        }

        // Check and send high alert for class tests
        function checkClassTestAlerts() {
            const testSchedule = JSON.parse(localStorage.getItem('classTests')) || [];
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();

            // Only check at 7pm (19:00)
            if (currentHour === 19 && currentMinute === 0) {
                testSchedule.forEach((test, index) => {
                    const testDate = new Date(test.date.split('/').reverse().join('-'));
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const daysUntil = Math.ceil((testDate - today) / (1000 * 60 * 60 * 24));

                    // If test is tomorrow (1 day before)
                    if (daysUntil === 1) {
                        // Check if already notified today
                        const notifiedKey = `notified_${test.date}_${test.subject}`;
                        const todayKey = `notified_date_${new Date().toDateString()}`;

                        if (!localStorage.getItem(notifiedKey) || localStorage.getItem(todayKey) !== notifiedKey) {
                            sendHighAlert(test);
                            localStorage.setItem(notifiedKey, 'true');
                            localStorage.setItem(todayKey, notifiedKey);
                        }
                    }
                });
            }
        }

        // Send high alert notification
        function sendHighAlert(test) {
            const message = `Tomorrow's class test: ${getCourseTitle(test.subject)} at ${test.time.split(' - ')[0]} in ${test.venue}`;

            // 1. Vibration
            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500, 200, 1000]);
            }

            // 2. Push Notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('🔔 Class Test Alert!', {
                    body: message,
                    icon: 'https://cdn-icons-png.flaticon.com/512/2921/2921222.png',
                    badge: 'https://cdn-icons-png.flaticon.com/512/2921/2921222.png',
                    tag: 'class-test-alert',
                    requireInteraction: true,
                    vibrate: [500, 200, 500, 200, 1000]
                });
            }

            // 3. Play sound
            playAlertSound();

            // 4. Show toast
            showToast({
                type: 'warning',
                title: '🔔 Class Test Tomorrow!',
                message: `${getCourseTitle(test.subject)} - ${test.time.split(' - ')[0]}`
            });
        }

        // Play alert sound
        function playAlertSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Alert pattern sound
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.2);
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.4);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.6);
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.8);

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.2);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1.2);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        // Play strong alert sound for high priority
        function playHighPrioritySound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Create multiple oscillators for richer sound
                const osc1 = audioContext.createOscillator();
                const osc2 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                osc1.connect(gainNode);
                osc2.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Urgent alarm pattern
                osc1.frequency.setValueAtTime(1000, audioContext.currentTime);
                osc1.frequency.setValueAtTime(800, audioContext.currentTime + 0.15);
                osc1.frequency.setValueAtTime(1000, audioContext.currentTime + 0.3);
                osc1.frequency.setValueAtTime(800, audioContext.currentTime + 0.45);
                osc1.frequency.setValueAtTime(1200, audioContext.currentTime + 0.6);

                osc2.frequency.setValueAtTime(500, audioContext.currentTime);
                osc2.frequency.setValueAtTime(400, audioContext.currentTime + 0.15);
                osc2.frequency.setValueAtTime(500, audioContext.currentTime + 0.3);
                osc2.frequency.setValueAtTime(400, audioContext.currentTime + 0.45);
                osc2.frequency.setValueAtTime(600, audioContext.currentTime + 0.6);

                gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);

                osc1.start(audioContext.currentTime);
                osc1.stop(audioContext.currentTime + 0.8);
                osc2.start(audioContext.currentTime);
                osc2.stop(audioContext.currentTime + 0.8);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        // Check and send high priority notice alerts
        function checkNoticeAlerts() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();

            // Check at 8am (08:00) for high priority notices
            if (currentHour === 8 && currentMinute === 0) {
                const unreadHighPriority = notices.filter(n => n.priority === 'high' && !isNoticeReadByUser(n.id));

                unreadHighPriority.forEach(notice => {
                    const notifiedKey = `notified_notice_${notice.id}`;
                    const todayKey = `notified_notice_date_${new Date().toDateString()}`;

                    if (!localStorage.getItem(notifiedKey) || localStorage.getItem(todayKey) !== notifiedKey) {
                        sendHighPriorityAlert(notice);
                        localStorage.setItem(notifiedKey, 'true');
                        localStorage.setItem(todayKey, notifiedKey);
                    }
                });
            }
        }

        // Send high priority notice alert
        function sendHighPriorityAlert(notice) {
            // 1. Stronger Vibration pattern
            if (navigator.vibrate) {
                navigator.vibrate([1000, 300, 1000, 300, 1000, 300, 2000]);
            }

            // 2. Push Notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('🚨 URGENT: ' + notice.title, {
                    body: notice.description || 'High priority notice from CR',
                    icon: 'https://cdn-icons-png.flaticon.com/512/2921/2921222.png',
                    badge: 'https://cdn-icons-png.flaticon.com/512/2921/2921222.png',
                    tag: 'high-priority-notice',
                    requireInteraction: true,
                    urgency: 'critical',
                    vibrate: [1000, 300, 1000, 300, 1000, 300, 2000]
                });
            }

            // 3. Play strong sound
            playHighPrioritySound();

            // 4. Show toast
            showToast({
                type: 'error',
                title: '🚨 URGENT Notice!',
                message: notice.title
            });
        }

        // Combined alert check function
        function checkAllAlerts() {
            checkClassTestAlerts();
            checkNoticeAlerts();
        }

        // Start alert checking interval (check every minute)
        setInterval(checkAllAlerts, 60000);
        // Also check on page load
        requestNotificationPermission();

        // Function to send push notification with vibration and sound for live updates
        let audioContextInstance = null;
        let audioInitialized = false;

        function sendPushNotification(title, body, icon = null) {
            // 1. Browser Push Notification (works without user gesture)
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    const notification = new Notification(title, {
                        body: body,
                        icon: icon || 'https://cdn-icons-png.flaticon.com/512/2921/2921222.png',
                        badge: 'https://cdn-icons-png.flaticon.com/512/2921/2921222.png',
                        tag: 'live-update',
                        requireInteraction: true
                    });

                    notification.onclick = function () {
                        window.focus();
                        this.close();
                    };
                } catch (e) {
                    console.log('Push notification error:', e);
                }
            }

            // 2. Device Vibration and Sound - only if user has interacted with page
            // (Browser security requires user gesture for these)
            if (audioInitialized) {
                // Try vibration if allowed
                if ('vibrate' in navigator) {
                    try { navigator.vibrate([500, 200, 500, 200, 500]); } catch (e) { }
                }
                // Play sound
                playNotificationSound();
            }
        }

        // Function to play notification sound
        function playNotificationSound() {
            try {
                // Create or reuse audio context
                if (!audioContextInstance) {
                    audioContextInstance = new (window.AudioContext || window.webkitAudioContext)();
                }

                const audioContext = audioContextInstance;

                // Resume if suspended (required after page load without user gesture)
                if (audioContext.state === 'suspended') {
                    audioContext.resume().catch(e => console.log('Audio resume error:', e));
                }

                // Create a soft notification sound
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Set sound parameters for a soft, gentle tone
                oscillator.frequency.value = 440; // A4 note - softer, pleasant tone
                oscillator.type = 'sine'; // sine wave is much softer than square

                // Volume envelope - soft start and fade
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime); // Lower volume (0.15 instead of 0.5)
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);

                // Play sound
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);

                // Play a second softer beep
                setTimeout(() => {
                    if (audioContext.state === 'suspended') return;
                    const osc2 = audioContext.createOscillator();
                    const gain2 = audioContext.createGain();
                    osc2.connect(gain2);
                    gain2.connect(audioContext.destination);
                    osc2.frequency.value = 520; // Slightly higher but still soft
                    osc2.type = 'sine';
                    gain2.gain.setValueAtTime(0.15, audioContext.currentTime);
                    gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    osc2.start(audioContext.currentTime);
                    osc2.stop(audioContext.currentTime + 0.4);
                }, 150);
            } catch (e) {
                console.log('Audio play error:', e);
            }
        }

        // Initialize audio context on first user interaction
        function initAudioOnInteraction() {
            if (audioInitialized) return;
            try {
                if (!audioContextInstance) {
                    audioContextInstance = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContextInstance.state === 'suspended') {
                    audioContextInstance.resume().then(() => {
                        audioInitialized = true;
                    }).catch(e => { });
                } else {
                    audioInitialized = true;
                }
            } catch (e) {
                console.log('Audio init error:', e);
            }
        }

        // ---------- STATE ----------
        // Check localStorage for saved CR mode state - with error handling for Safari/Apple devices
        let savedCRMode = false;
        try {
            savedCRMode = localStorage.getItem('crMode') === 'true';
        } catch (e) {
            console.warn('localStorage not available:', e);
        }
        // Check for logged in user - with error handling for Safari/Apple devices
        let currentUser = null;
        try {
            currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        } catch (e) {
            console.warn('localStorage not available:', e);
            currentUser = null;
        }
        if (!currentUser) {
            currentUser = { name: 'Student', role: 'student', avatar: 'S', studentId: '' };
        }

        // Apply saved CR mode if it was enabled
        if (savedCRMode) {
            currentUser.role = 'cr';
        }

        // Track which notices have been read by the current user
        let userReadNotices = new Set();

        // Load user-specific notice read status from Supabase
        async function loadUserReadNotices() {
            if (!currentUser || !currentUser.id || !USE_SUPABASE) return;
            try {
                const readStatus = await supabaseClient.getNoticeReadStatus(null, currentUser.id);
                // Clear existing set and reload from Supabase for proper sync
                userReadNotices.clear();
                if (readStatus && Array.isArray(readStatus)) {
                    readStatus.forEach(status => {
                        userReadNotices.add(status.notice_id);
                    });
                }
                console.log('Loaded read status for user:', userReadNotices.size, 'notices read');
            } catch (e) {
                console.log('Could not load read status:', e);
            }
        }

        // Check if notice is read by current user
        function isNoticeReadByUser(noticeId) {
            return userReadNotices.has(noticeId);
        }

        // Mark notice as read for current user
        async function markNoticeAsRead(noticeId) {
            if (!currentUser || !currentUser.id) return;
            // Check if already marked as read
            if (userReadNotices.has(noticeId)) return;
            userReadNotices.add(noticeId);
            if (USE_SUPABASE) {
                try {
                    await supabaseClient.markNoticeRead(noticeId, currentUser.id);
                } catch (e) {
                    // Ignore duplicate key errors (already marked)
                    if (!e.message.includes('duplicate key')) {
                        console.log('Could not mark as read in Supabase:', e);
                    }
                }
            }
        }

        let currentTerm = 'Level 3 Term 2';
        let archivedTerms = [];
        let previousTermSubjects = []; // Store previous term subjects for reference
        let unreadNotices = true;

        // Load current term and archived terms from localStorage
        function loadTermData() {
            const savedTerm = localStorage.getItem('currentTerm');
            const savedArchived = localStorage.getItem('archivedTerms');
            const savedPrevSubjects = localStorage.getItem('previousTermSubjects');

            if (savedTerm) currentTerm = savedTerm;
            if (savedArchived) archivedTerms = JSON.parse(savedArchived);
            if (savedPrevSubjects) previousTermSubjects = JSON.parse(savedPrevSubjects);
        }

        // Save term data to localStorage
        function saveTermData() {
            localStorage.setItem('currentTerm', currentTerm);
            localStorage.setItem('archivedTerms', JSON.stringify(archivedTerms));
            localStorage.setItem('previousTermSubjects', JSON.stringify(previousTermSubjects));
        }

        // Promote to next term function
        function promoteToNextTerm() {
            // Store current subjects as previous term subjects before clearing
            previousTermSubjects = [...subjects];

            // Determine next term
            let nextTerm = currentTerm;
            if (currentTerm.includes('Term 1')) {
                nextTerm = currentTerm.replace('Term 1', 'Term 2');
            } else if (currentTerm.includes('Term 2')) {
                const levelMatch = currentTerm.match(/Level (\d+)/);
                if (levelMatch) {
                    const nextLevel = parseInt(levelMatch[1]) + 1;
                    nextTerm = currentTerm.replace(/Level \d+/, 'Level ' + nextLevel).replace('Term 2', 'Term 1');
                }
            }

            // Archive current term
            archivedTerms.push(currentTerm);

            // Clear subjects for new term
            subjects = [];

            // Update current term
            currentTerm = nextTerm;

            // Save to localStorage
            saveTermData();

            // Save to Supabase if available
            if (USE_SUPABASE) {
                saveSubjects();
                // Save term data to a separate table or as website settings
                try {
                    supabaseClient.request('term_data', {
                        method: 'POST',
                        body: {
                            current_term: currentTerm,
                            archived_terms: JSON.stringify(archivedTerms),
                            previous_subjects: JSON.stringify(previousTermSubjects)
                        }
                    }).catch(e => console.log('Could not save term data to Supabase:', e));
                } catch (e) { }
            }

            // Close modal and refresh
            document.getElementById('termModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';

            showToast({ type: 'success', title: 'Promoted!', message: 'Now in ' + currentTerm });
            renderMembers();
        }

        // ---------- DATA MANAGEMENT WITH SUPABASE ----------
        // Check if Supabase is configured
        const USE_SUPABASE = typeof supabaseClient !== 'undefined' && isSupabaseConfigured && isSupabaseConfigured();

        console.log('Supabase config check:', {
            clientExists: typeof supabaseClient !== 'undefined',
            isConfigured: typeof isSupabaseConfigured !== 'undefined' ? isSupabaseConfigured() : false,
            USE_SUPABASE
        });

        // Data arrays
        let notices = [];
        let notes = [];
        let subjects = [];
        let todaysRoutine = [];
        let classTests = [];
        let websiteSettings = { logoIcon: 'fa-scroll', websiteName: 'YE-48' };
        let members = [];

        // Initialize data from Supabase or localStorage
        async function initializeData() {
            if (USE_SUPABASE) {
                try {
                    // Load from Supabase
                    const [noticesData, notesData, subjectsData, routineData, testsData, settingsData, membersData] = await Promise.all([
                        supabaseClient.getNotices(),
                        supabaseClient.getNotes(),
                        supabaseClient.getSubjects(),
                        supabaseClient.getTodaysRoutine(),
                        supabaseClient.getClassTests(),
                        supabaseClient.getWebsiteSettings(),
                        supabaseClient.getMembers()
                    ]);

                    console.log('Supabase loaded - Routine:', routineData);

                    notices = (noticesData || []).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                    // Load user's read notice status
                    await loadUserReadNotices();
                    notes = notesData || [];
                    // Convert Supabase subject objects to string format for localStorage
                    subjects = (subjectsData || []).map(s => {
                        let str = s.name || '';
                        if (s.teacher) str += ' (' + s.teacher + ')';
                        return str;
                    });
                    todaysRoutine = routineData || [];
                    classTests = (testsData || []).map(t => ({
                        id: t.id,
                        subject: t.subject,
                        date: t.date,
                        time: t.time,
                        venue: t.venue,
                        chapters: t.chapter || t.chapters || '',
                        notes: t.notes
                    }));
                    websiteSettings = settingsData || { logoIcon: 'fa-scroll', websiteName: 'YE-48' };
                    members = membersData || [];

                    // Save to localStorage in string format
                    localStorage.setItem('subjects', JSON.stringify(subjects));
                    localStorage.setItem('todaysRoutine', JSON.stringify(todaysRoutine));
                    localStorage.setItem('classTests', JSON.stringify(classTests));

                    console.log('Data loaded from Supabase, todaysRoutine:', todaysRoutine);
                } catch (error) {
                    console.error('Error loading from Supabase:', error);
                    // Fallback to localStorage
                    loadFromLocalStorage();
                }
            } else {
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            notices = JSON.parse(localStorage.getItem('notices')) || [];
            notes = JSON.parse(localStorage.getItem('notes')) || [];
            subjects = JSON.parse(localStorage.getItem('subjects')) || [];
            todaysRoutine = JSON.parse(localStorage.getItem('todaysRoutine')) || [];
            classTests = JSON.parse(localStorage.getItem('classTests')) || [];
            websiteSettings = JSON.parse(localStorage.getItem('websiteSettings')) || { logoIcon: 'fa-scroll', websiteName: 'YE-48' };
            members = ['Aarav Sharma', 'Vivaan Gupta', 'Aditya Kumar', 'Ananya Singh', 'Diya Patel', 'Ishaan Roy', 'Sai Krishna', 'John Mathew', 'Meera Nair', 'Rohan Joshi', 'Priya Shah', 'Karthik Iyer'];

            // Load term data
            loadTermData();
        }

        // Polling function to check for real-time updates from Supabase
        let lastDataHash = {
            notices: '',
            notes: '',
            todaysRoutine: '',
            classTests: ''
        };

        function getDataHash(data) {
            return JSON.stringify(data);
        }

        async function pollForUpdates() {
            if (!USE_SUPABASE || !navigator.onLine) return;

            try {
                const [noticesData, notesData, routineData, testsData] = await Promise.all([
                    supabaseClient.getNotices(),
                    supabaseClient.getNotes(),
                    supabaseClient.getTodaysRoutine(),
                    supabaseClient.getClassTests()
                ]);

                const newNotices = (noticesData || []).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                const newNotes = notesData || [];
                const newRoutine = routineData || [];
                const newTests = testsData || [];

                let dataChanged = false;
                let updateType = '';

                // Check if notices changed
                if (getDataHash(newNotices) !== lastDataHash.notices) {
                    const newNoticeCount = newNotices.length - notices.length;
                    notices = newNotices;
                    lastDataHash.notices = getDataHash(newNotices);
                    localStorage.setItem('notices', JSON.stringify(notices));
                    dataChanged = true;
                    updateType = 'notice';
                    console.log('New notices detected from Supabase!');

                    // Send notification for new notices
                    if (newNoticeCount > 0 && newNotices[0]) {
                        sendPushNotification(
                            '📢 New Notice Posted!',
                            newNotices[0].title + (newNoticeCount > 1 ? ` (+${newNoticeCount - 1} more)` : '')
                        );
                    }
                }

                // Check if notes changed
                if (getDataHash(newNotes) !== lastDataHash.notes) {
                    const newNotesCount = newNotes.length - notes.length;
                    notes = newNotes;
                    lastDataHash.notes = getDataHash(newNotes);
                    localStorage.setItem('notes', JSON.stringify(notes));
                    dataChanged = true;
                    updateType = 'notes';
                    console.log('Notes changed from Supabase!');

                    // Send notification for notes changes
                    if (newNotesCount > 0) {
                        sendPushNotification(
                            '📚 New Study Notes Added!',
                            newNotesCount + ' new note' + (newNotesCount > 1 ? 's' : '') + ' available'
                        );
                    } else if (newNotesCount < 0) {
                        sendPushNotification(
                            '📚 Study Notes Updated',
                            Math.abs(newNotesCount) + ' note' + (Math.abs(newNotesCount) > 1 ? 's' : '') + ' removed'
                        );
                    }
                }

                // Check if routine changed
                if (getDataHash(newRoutine) !== lastDataHash.todaysRoutine) {
                    todaysRoutine = newRoutine;
                    lastDataHash.todaysRoutine = getDataHash(newRoutine);
                    localStorage.setItem('todaysRoutine', JSON.stringify(todaysRoutine));
                    dataChanged = true;
                    updateType = 'routine';
                    console.log('New routine detected from Supabase!');

                    // Send notification for routine update
                    sendPushNotification(
                        '📅 Today\'s Routine Updated!',
                        'Check the updated class schedule for today'
                    );
                }

                // Check if class tests changed
                if (getDataHash(newTests) !== lastDataHash.classTests) {
                    const newTestsCount = newTests.length - classTests.length;
                    classTests = newTests;
                    lastDataHash.classTests = getDataHash(newTests);
                    localStorage.setItem('classTests', JSON.stringify(classTests));
                    dataChanged = true;
                    updateType = 'classtest';
                    console.log('New class tests detected from Supabase!');

                    // Send notification for new class tests
                    if (newTestsCount > 0) {
                        sendPushNotification(
                            '📝 New Class Test Scheduled!',
                            newTestsCount + ' new class test' + (newTestsCount > 1 ? 's' : '') + ' added'
                        );
                    }
                }

                // Reload user's read notice status
                if (currentUser && currentUser.id) {
                    await loadUserReadNotices();
                }

                // Update unread notification badge
                updateUnreadBadge();

                // Update UI if data changed and user is on the dashboard
                if (dataChanged && currentPage === 'dashboard') {
                    renderDashboard();
                } else if (dataChanged && currentPage === 'notices') {
                    renderNotices();
                } else if (dataChanged && currentPage === 'notes') {
                    renderNotes();
                } else if (dataChanged && currentPage === 'routine') {
                    renderRoutine();
                } else if (dataChanged && currentPage === 'classtest') {
                    renderClassTests();
                }
            } catch (error) {
                console.error('Error polling for updates:', error);
            }
        }

        // Start polling interval (every 10 seconds)
        let pollInterval;
        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(pollForUpdates, 10000); // Check every 10 seconds
        }

        // Stop polling
        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        // Function to update unread notification badge
        function updateUnreadBadge() {
            const unreadCount = notices.filter(n => !isNoticeReadByUser(n.id)).length;
            const badge = document.getElementById('unreadBadge');
            const dot = document.getElementById('unreadDot');
            if (badge) {
                if (unreadCount > 0) {
                    badge.style.display = 'flex';
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    if (dot) dot.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                    if (dot) dot.style.display = 'none';
                }
            }
        }

        // Save functions - save to both Supabase and localStorage
        async function saveNotices() {
            localStorage.setItem('notices', JSON.stringify(notices));
            if (USE_SUPABASE) {
                try {
                    // Delete existing and re-insert
                    const existing = await supabaseClient.getNotices();
                    console.log('Existing notices in Supabase:', existing);
                    if (existing && existing.length > 0) {
                        for (const n of existing) { await supabaseClient.deleteNotice(n.id); }
                    }
                    for (const n of notices) {
                        await supabaseClient.addNotice({
                            title: n.title, description: n.description, priority: n.priority,
                            link: n.link || '', pinned: n.pinned || false, read: n.read || false, expiry: n.expiry || '',
                            created_at: n.created_at || new Date().toISOString()
                        });
                    }
                    console.log('Notices saved to Supabase');
                } catch (e) {
                    console.error('Error saving notices:', e);
                    alert('Error saving to Supabase: ' + e.message);
                }
            } else {
                console.log('Supabase not enabled, saving to localStorage only');
            }
        }

        async function saveNotes() {
            localStorage.setItem('notes', JSON.stringify(notes));
            if (USE_SUPABASE) {
                try {
                    const existing = await supabaseClient.getNotes();
                    if (existing && existing.length > 0) {
                        for (const n of existing) { await supabaseClient.deleteNote(n.id); }
                    }
                    for (const n of notes) {
                        await supabaseClient.addNote({
                            subject: n.subject, title: n.title, description: n.desc || n.description || '',
                            link: n.link || '', type: n.type || 'telegram', date: n.date || ''
                        });
                    }
                    console.log('Notes saved to Supabase');
                } catch (e) { console.error('Error saving notes:', e); }
            }
        }

        async function saveSubjects() {
            localStorage.setItem('subjects', JSON.stringify(subjects));
            if (USE_SUPABASE) {
                try {
                    const existing = await supabaseClient.getSubjects();
                    if (existing && existing.length > 0) {
                        for (const s of existing) { await supabaseClient.deleteSubject(s.id); }
                    }
                    for (const s of subjects) {
                        // Parse subject string to extract name, code, and teacher
                        let name = s, code = '', teacher = '';
                        // Check if it has a code prefix (e.g., "MATH101 - Algebra")
                        const codeMatch = s.match(/^([A-Za-z0-9]+)\s*-\s*(.+)$/);
                        if (codeMatch) {
                            code = codeMatch[1];
                            name = codeMatch[2];
                        }
                        // Check for teacher in parentheses (e.g., "Algebra (Mr. Smith)")
                        const teacherMatch = name.match(/^(.+)\s*\(([^)]+)\)$/);
                        if (teacherMatch) {
                            name = teacherMatch[1];
                            teacher = teacherMatch[2];
                        }
                        if (name) {
                            await supabaseClient.addSubject({ name: name, teacher: teacher || '', color: '' });
                        }
                    }
                    console.log('Subjects saved to Supabase');
                } catch (e) { console.error('Error saving subjects:', e); }
            }
        }

        // Edit subject - open modal with subject data
        function editSubject(index) {
            const subject = subjects[index];
            if (!subject) return;

            // Parse subject to get code, name, and teacher
            let name = subject, code = '', teacher = '';
            const codeMatch = subject.match(/^([A-Za-z0-9]+)\s*-\s*(.+)$/);
            if (codeMatch) {
                code = codeMatch[1];
                name = codeMatch[2];
            }
            const teacherMatch = name.match(/^(.+)\s*\(([^)]+)\)$/);
            if (teacherMatch) {
                name = teacherMatch[1];
                teacher = teacherMatch[2];
            }

            // Store editing index
            window.editingSubjectIndex = index;

            // Open subject modal with pre-filled data
            openModal('subject');

            // Fill in the form
            setTimeout(() => {
                document.getElementById('newSubjectCode').value = code;
                document.getElementById('newSubjectName').value = name;
                document.getElementById('newSubjectTeacher').value = teacher;
                // Change button text to indicate update
                const btn = document.querySelector('#subjectModal button[type="submit"]');
                if (btn) btn.textContent = 'Update Subject';
            }, 100);
        }

        // Delete subject
        function deleteSubject(index) {
            showDeleteConfirm(
                'Are you sure you want to delete this subject?',
                () => {
                    subjects.splice(index, 1);
                    saveSubjects();
                    localStorage.setItem('subjects', JSON.stringify(subjects));
                    renderMembers();
                    showToast({ type: 'success', title: 'Deleted!', message: 'Subject has been removed.' });
                }
            );
        }

        async function saveTodaysRoutine() {
            localStorage.setItem('todaysRoutine', JSON.stringify(todaysRoutine));
            console.log('Saving todaysRoutine to Supabase, data:', todaysRoutine);
            if (USE_SUPABASE) {
                try {
                    const existing = await supabaseClient.getTodaysRoutine();
                    console.log('Existing routine in Supabase:', existing);
                    if (existing && existing.length > 0) {
                        for (const r of existing) { await supabaseClient.deleteTodaysRoutine(r.id); }
                    }
                    for (let i = 0; i < todaysRoutine.length; i++) {
                        const r = todaysRoutine[i];
                        await supabaseClient.request('todays_routine', {
                            method: 'POST',
                            body: { slot_number: i + 1, subject: r.subject, time: r.time || '', venue: r.venue || '', online: r.online || false, meeting_link: r.meetingLink || '' }
                        });
                    }
                    console.log('Routine saved to Supabase');
                } catch (e) { console.error('Error saving routine:', e); }
            }
        }

        async function saveClassTests() {
            localStorage.setItem('classTests', JSON.stringify(classTests));
            if (USE_SUPABASE) {
                try {
                    const existing = await supabaseClient.getClassTests();
                    const existingMap = new Map(existing.map(t => [t.id, t]));

                    // Create a key for matching: subject + date + time
                    const existingKeys = new Set(existing.map(t => `${t.subject}|${t.date}|${t.time || ''}`));

                    // Delete items that exist in DB but not in local (match by subject+date+time)
                    const localKeys = new Set(classTests.map(t => `${t.subject}|${t.date}|${t.time || ''}`));
                    for (const t of existing) {
                        const key = `${t.subject}|${t.date}|${t.time || ''}`;
                        if (!localKeys.has(key)) {
                            await supabaseClient.deleteClassTest(t.id);
                        }
                    }

                    // Add or update items
                    for (const t of classTests) {
                        const key = `${t.subject}|${t.date}|${t.time || ''}`;
                        if (t.id && existingMap.has(t.id)) {
                            // Update by ID
                            const remote = existingMap.get(t.id);
                            if (remote && (t.subject !== remote.subject || t.date !== remote.date || t.time !== remote.time || t.venue !== remote.venue || (t.chapters || t.chapter) !== remote.chapter || t.notes !== remote.notes)) {
                                await supabaseClient.updateClassTest(t.id, {
                                    subject: t.subject, date: t.date, time: t.time || '', venue: t.venue || '', chapter: t.chapters || t.chapter || '', notes: t.notes || ''
                                });
                            }
                        } else if (!existingKeys.has(key)) {
                            // Add new (no matching ID and no matching subject+date+time)
                            const result = await supabaseClient.addClassTest({
                                subject: t.subject, date: t.date, time: t.time || '', venue: t.venue || '', chapter: t.chapters || t.chapter || '', notes: t.notes || ''
                            });
                            // Capture the returned ID
                            if (result && result[0] && result[0].id) {
                                t.id = result[0].id;
                            }
                        }
                    }
                    console.log('Class tests saved to Supabase');
                    // Update localStorage with any new IDs
                    localStorage.setItem('classTests', JSON.stringify(classTests));
                } catch (e) { console.error('Error saving class tests:', e); }
            }
        }

        async function saveWebsiteSettings() {
            localStorage.setItem('websiteSettings', JSON.stringify(websiteSettings));
            if (USE_SUPABASE) {
                try {
                    const settings = await supabaseClient.getWebsiteSettings();
                    if (settings && settings.id) {
                        await supabaseClient.updateWebsiteSettings(settings.id, websiteSettings);
                    }
                    console.log('Settings saved to Supabase');
                } catch (e) { console.error('Error saving settings:', e); }
            }
        }

        // Visitor tracking
        const today = new Date().toLocaleDateString();
        let visitorData = JSON.parse(localStorage.getItem('visitorData')) || { date: '', count: 0 };
        if (visitorData.date !== today) {
            visitorData = { date: today, count: 1 };
        } else {
            visitorData.count++;
        }
        localStorage.setItem('visitorData', JSON.stringify(visitorData));
        const visitorsToday = visitorData.count;

        // Filter state
        let currentNoteFilter = 'all';
        let currentNoteSearch = '';
        let currentNoticeFilter = 'all';

        // Global filter functions
        function setNoteFilter(subject) {
            currentNoteFilter = subject;
            renderNotes();
        }

        function setNoticeFilter(type) {
            currentNoticeFilter = type;
            renderNotices();
        }

        function searchNotes(query) {
            currentNoteSearch = query.toLowerCase();
            renderNotes();
        }

        // Update todaysRoutine before rendering dashboard
        function loadTodaysRoutine() {
            if (USE_SUPABASE) {
                // Already loaded in initializeData
            } else {
                todaysRoutine = JSON.parse(localStorage.getItem('todaysRoutine')) || [];
            }
        }

        // Card header gradient colors (shuffled for new cards)
        const cardColors = [
            { start: '#0891B2', end: '#06B6D4' },  // Cyan
            { start: '#7C3AED', end: '#8B5CF6' },  // Purple
            { start: '#059669', end: '#10B981' },  // Green
            { start: '#DC2626', end: '#EF4444' },  // Red
            { start: '#D97706', end: '#F59E0B' },  // Amber
            { start: '#4F46E5', end: '#6366F1' },  // Indigo
            { start: '#DB2777', end: '#F472B6' },  // Pink
            { start: '#2563EB', end: '#3B82F6' },  // Blue
        ];

        function getCardColor(index) {
            return cardColors[index % cardColors.length];
        }

        // Extract course title from full subject string (removes code and teacher)
        function getCourseTitle(fullSubject) {
            if (!fullSubject) return '';
            // Remove course code (e.g., "PHY101 - " or "PHY 101 - ") - more flexible matching
            let title = fullSubject.replace(/^[A-Za-z0-9\s]+ - /, '');
            // Remove teacher name (e.g., " (Dr. Rahman)")
            title = title.replace(/ \([^)]+\)$/, '');
            return title;
        }

        // Delete class test
        function deleteTest(index) {
            showDeleteConfirm(
                'Are you sure you want to delete this class test?',
                () => {
                    const testSchedule = JSON.parse(localStorage.getItem('classTests')) || [];
                    testSchedule.splice(index, 1);
                    localStorage.setItem('classTests', JSON.stringify(testSchedule));
                    // Update global classTests array and save to Supabase
                    classTests = testSchedule;
                    saveClassTests();
                    setTimeout(() => {
                        reRenderCurrentPage();
                    }, 250);
                    showToast({
                        type: 'success',
                        title: 'Deleted!',
                        message: 'Class test has been removed successfully.'
                    });
                }
            );
        }

        // Edit class test - open modal with data
        function editTest(index) {
            const testSchedule = JSON.parse(localStorage.getItem('classTests')) || [];
            const test = testSchedule[index];
            openModal('ct');
            // Pre-fill the form after modal opens
            setTimeout(() => {
                document.getElementById('ctSubjectModal').value = test.subject;
                document.getElementById('ctDateModal').value = test.date;
                document.getElementById('ctTimeModal').value = test.time;
                document.getElementById('ctVenueModal').value = test.venue;
                document.getElementById('ctSyllabusModal').value = test.chapters;
                // Change button text
                const btn = document.querySelector('#ctForm button[type=\"submit\"]');
                if (btn) btn.innerHTML = '<i class="fas fa-save"></i> Update CT';
                // Store the index for updating
                window.editingTestIndex = index;
            }, 100);
        }

        // Delete study note
        function deleteNote(index) {
            showDeleteConfirm(
                'Are you sure you want to delete this note?',
                () => {
                    const noteToDelete = notes[index];
                    notes.splice(index, 1);
                    localStorage.setItem('notes', JSON.stringify(notes));
                    // Also delete from Supabase if using Supabase
                    if (USE_SUPABASE && noteToDelete && noteToDelete.id && String(noteToDelete.id).includes('-')) {
                        supabaseClient.deleteNote(noteToDelete.id).catch(e => console.error('Error deleting from Supabase:', e));
                    }
                    setTimeout(() => {
                        reRenderCurrentPage();
                    }, 250);
                    showToast({
                        type: 'success',
                        title: 'Deleted!',
                        message: 'Note has been removed successfully.'
                    });
                }
            );
        }

        // Delete notice
        function deleteNoticeItem(noticeId) {
            showDeleteConfirm(
                'Are you sure you want to delete this notice?',
                () => {
                    // Convert noticeId to string for comparison
                    const idStr = String(noticeId);
                    notices = notices.filter(n => String(n.id) !== idStr);
                    localStorage.setItem('notices', JSON.stringify(notices));
                    // Also delete from Supabase if using Supabase
                    if (USE_SUPABASE && noticeId.toString().includes('-')) {
                        supabaseClient.deleteNotice(noticeId).catch(e => console.error('Error deleting from Supabase:', e));
                    }
                    setTimeout(() => {
                        reRenderCurrentPage();
                    }, 250);
                    showToast({
                        type: 'success',
                        title: 'Deleted!',
                        message: 'Notice has been removed successfully.'
                    });
                }
            );
        }

        // Clear all database (localStorage and Supabase)
        async function clearAllDatabase() {
            // Show custom confirmation modal
            document.getElementById('clearDbModal').style.display = 'flex';
        }

        function confirmClearDatabase() {
            // Close modal
            document.getElementById('clearDbModal').style.display = 'none';

            // Show loading indicator
            showToast({
                type: 'info',
                title: 'Clearing...',
                message: 'Deleting all data'
            });

            (async () => {
                try {
                    // Clear Supabase data if using Supabase
                    if (USE_SUPABASE) {
                        await supabaseClient.clearAllData();
                    }

                    // Clear localStorage
                    localStorage.clear();

                    // Reload the page
                    setTimeout(() => {
                        location.reload();
                    }, 1000);

                    showToast({
                        type: 'success',
                        title: 'Cleared!',
                        message: 'All data has been deleted'
                    });
                } catch (error) {
                    console.error('Error clearing database:', error);
                    // Still clear localStorage even if Supabase fails
                    localStorage.clear();
                    location.reload();
                }
            })();
        }

        function cancelClearDatabase() {
            document.getElementById('clearDbModal').style.display = 'none';
        }

        // Copy notice link for sharing
        function copyNoticeLink(noticeId, noticeTitle) {
            const notice = notices.find(n => n.id === noticeId);
            if (notice && notice.link) {
                // Create a shareable URL with the link parameter
                const baseUrl = window.location.href.split('?')[0];
                const shareUrl = `${baseUrl}?link=${encodeURIComponent(notice.link)}&title=${encodeURIComponent(noticeTitle)}`;

                navigator.clipboard.writeText(shareUrl).then(() => {
                    showToast({
                        type: 'success',
                        title: 'Link Copied!',
                        message: 'Share this link with others. When opened, it will ask to open the link in browser.'
                    });
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast({
                        type: 'success',
                        title: 'Link Copied!',
                        message: 'Share this link with others.'
                    });
                });
            }
        }

        // Edit study note - open modal with data
        function editNote(index) {
            const note = notes[index];
            openModal('note');
            // Pre-fill the form after modal opens
            setTimeout(() => {
                document.getElementById('noteSubjectModal').value = note.subject;
                document.getElementById('noteTitleModal').value = note.title;
                document.getElementById('noteDescModal').value = note.desc;
                // Change button text
                const btn = document.querySelector('#noteForm button[type=\"submit\"]');
                if (btn) btn.innerHTML = '<i class="fas fa-save"></i> Update Note';
                // Store the index for updating
                window.editingNoteIndex = index;
            }, 100);
        }

        // Save class test (add or update)
        function saveClassTest() {
            const s = document.getElementById('ctSubject').value;
            const d = document.getElementById('ctDate').value;
            const t = document.getElementById('ctTime').value;
            const v = document.getElementById('ctVenue').value;
            const sy = document.getElementById('ctSyllabus').value;

            if (d && t && v && sy) {
                const testSchedule = JSON.parse(localStorage.getItem('classTests')) || [];

                if (window.editingTestIndex !== undefined && window.editingTestIndex !== null) {
                    // Update existing
                    testSchedule[window.editingTestIndex] = { subject: s, date: d, time: t, venue: v, chapters: sy };
                    window.editingTestIndex = null;
                } else {
                    // Add new
                    testSchedule.push({ subject: s, date: d, time: t, venue: v, chapters: sy });
                }

                localStorage.setItem('classTests', JSON.stringify(testSchedule));
                // Update global classTests array and save to Supabase
                classTests = testSchedule;
                saveClassTests();
                document.getElementById('ctModal').style.display = 'none';
                alert(window.editingTestIndex !== null ? 'CT updated!' : 'CT scheduled: ' + s + ' on ' + d);
                // Refresh the current page
                location.reload();
            } else {
                alert('Please fill all fields');
            }
        }

        // Save note (add or update)
        function saveNote() {
            const subject = document.getElementById('noteSubjectModal').value;
            const title = document.getElementById('noteTitleModal').value;
            const desc = document.getElementById('noteDescModal').value;

            if (subject && title && desc) {
                if (window.editingNoteIndex !== undefined && window.editingNoteIndex !== null) {
                    // Update existing
                    notes[window.editingNoteIndex] = { ...notes[window.editingNoteIndex], subject, title, desc };
                    window.editingNoteIndex = null;
                } else {
                    // Add new
                    const newNote = {
                        id: Date.now(),
                        subject: subject,
                        title: title,
                        date: new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }),
                        desc: desc,
                        link: '#',
                        type: 'telegram'
                    };
                    notes.unshift(newNote);
                }

                localStorage.setItem('notes', JSON.stringify(notes));
                document.getElementById('modalOverlay').style.display = 'none';
                alert('Note saved!');
                renderNotes();
            } else {
                alert('Please fill all required fields');
            }
        }

        // ---------- RENDER FUNCTIONS ----------
        function renderDashboard() {
            const now = new Date();
            const hour = now.getHours();
            const greeting = hour < 12 ? 'Morning' : hour < 18 ? 'Afternoon' : 'Evening';
            const userName = currentUser && currentUser.name ? currentUser.name : '';
            const unreadNoticesCount = notices.filter(n => !isNoticeReadByUser(n.id)).length;
            const isCR = currentUser.role === 'cr';

            const html = `
            <!-- Hero Section -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 30px; padding: 40px; margin-bottom: 40px; position: relative; overflow: hidden; box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);">
                <div style="position: absolute; top: -50%; right: -10%; width: 300px; height: 300px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                <div style="position: absolute; bottom: -30%; left: -5%; width: 200px; height: 200px; background: rgba(255,255,255,0.08); border-radius: 50%;"></div>
                <div style="position: relative; z-index: 1;">
                    <h1 class="satoshi" style="font-size: 2.5rem; color: white; margin-bottom: 10px; animation: fadeInUp 0.8s ease;">Good ${greeting}, ${userName}! <i class="fas fa-sun" style="color: #FFD700;"></i></h1>
                    <p style="font-size: 1.2rem; color: rgba(255,255,255,0.9); margin-bottom: 0;">Here's what's happening in our class today.</p>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px;" class="stats-grid">
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 24px; border-radius: 24px; color: white; box-shadow: 0 10px 30px rgba(245, 87, 108, 0.3); animation: fadeInUp 0.5s ease forwards; animation-delay: 0.1s; opacity: 0; text-align: center;">
                    <i class="fas fa-book-open" style="font-size: 2.5rem; margin-bottom: 10px; display: block;"></i>
                    <div style="font-size: 3rem; font-weight: 700;">${notes.length}</div>
                    <div style="font-size: 1rem; opacity: 0.9;">Study Notes</div>
                </div>
                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 24px; border-radius: 24px; color: white; box-shadow: 0 10px 30px rgba(0, 242, 254, 0.3); animation: fadeInUp 0.5s ease forwards; animation-delay: 0.2s; opacity: 0; text-align: center;">
                    <i class="fas fa-bell" style="font-size: 2.5rem; margin-bottom: 10px; display: block;"></i>
                    <div style="font-size: 3rem; font-weight: 700;">${unreadNoticesCount}</div>
                    <div style="font-size: 1rem; opacity: 0.9;">Unread Notices</div>
                </div>
                <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 24px; border-radius: 24px; color: white; box-shadow: 0 10px 30px rgba(56, 249, 215, 0.3); animation: fadeInUp 0.5s ease forwards; animation-delay: 0.3s; opacity: 0; text-align: center;">
                    <i class="fas fa-calendar-alt" style="font-size: 2.5rem; margin-bottom: 10px; display: block;"></i>
                    <div style="font-size: 3rem; font-weight: 700;">${todaysRoutine.length}</div>
                    <div style="font-size: 1rem; opacity: 0.9;">Today's Classes</div>
                </div>
                <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 24px; border-radius: 24px; color: white; box-shadow: 0 10px 30px rgba(250, 112, 154, 0.3); animation: fadeInUp 0.5s ease forwards; animation-delay: 0.4s; opacity: 0; text-align: center;">
                    <i class="fas fa-users" style="font-size: 2.5rem; margin-bottom: 10px; display: block;"></i>
                    <div style="font-size: 3rem; font-weight: 700;">${visitorsToday}</div>
                    <div style="font-size: 1rem; opacity: 0.9;">Visitors Today</div>
                </div>
            </div>
            
            <!-- Main Content Grid -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;" class="dashboard-grid">
                
                <!-- Left Column -->
                <div style="display: flex; flex-direction: column; gap: 30px;">
                    
                    <!-- Today's Schedule -->
                    <div style="background: white; border-radius: 30px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); animation: fadeInUp 0.6s ease forwards; animation-delay: 0.2s; opacity: 0;">
                        <div class="flex" style="justify-content: space-between; margin-bottom: 24px;">
                            <h3 style="font-size: 1.4rem; color: #1E293B; margin: 0;"><span style="background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;"><i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>Today's Schedule</span></h3>
                            <span style="background: #EEF2FF; color: #6366F1; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">${todaysRoutine.length} classes</span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            ${todaysRoutine.length === 0 ? `
                            <div style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <i class="fas fa-calendar-plus" style="font-size: 3rem; color: #94A3B8; margin-bottom: 12px;"></i>
                                <span style="color: #94A3B8; font-size: 1.1rem;">No routine posted yet</span>
                            </div>
                            ` : todaysRoutine.slice(0, 4).map((cls, i) => {
                const colors = [['#667eea', '#764ba2'], ['#f093fb', '#f5576c'], ['#4facfe', '#00f2fe'], ['#43e97b', '#38f9d7']];
                const c = colors[i % 4];

                // Check if class is online and within 5 minutes of starting
                const now = new Date();
                const [startTime] = (cls.time || '').split(' - ');
                let isJoinable = false;
                let meetingLink = '';

                if (cls.online && startTime) {
                    const [hours, minutes] = startTime.split(':').map(Number);
                    const classTime = new Date();
                    classTime.setHours(hours, minutes, 0, 0);
                    const diffMinutes = (classTime - now) / (1000 * 60);
                    // Show join button if within 5 minutes before to 10 minutes after start
                    isJoinable = diffMinutes <= 5 && diffMinutes >= -10;
                    meetingLink = cls.meetingLink || '';
                }

                return `
                            <div style="padding: 18px 22px; border-radius: 20px; background: linear-gradient(135deg, ${c[0]}, ${c[1]}); color: white; position: relative; overflow: hidden; animation: slideIn 0.5s ease forwards; animation-delay: ${0.3 + i * 0.1}s; opacity: 0; transform: translateX(-20px);">
                                <div style="position: absolute; top: -15px; right: -15px; width: 60px; height: 60px; background: rgba(255,255,255,0.15); border-radius: 50%;"></div>
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 14px; align-items: center;">
                                        <div style="background: rgba(255,255,255,0.25); padding: 12px; border-radius: 14px;"><i class="fas fa-book" style="font-size: 1.2rem;"></i></div>
                                        <div>
                                            <span style="font-weight: 700; font-size: 1.05rem; display: block;">${getCourseTitle(cls.subject) || 'Class ' + (i + 1)}</span>
                                            <span style="opacity: 0.85; font-size: 0.9rem;"><i class="far fa-clock" style="margin-right: 5px;"></i>${cls.time || 'Time not set'}</span>
                                        </div>
                                    </div>
                                    ${isJoinable && meetingLink ? `
                                    <a href="${meetingLink}" target="_blank" style="background: linear-gradient(135deg, #10B981, #34D399); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; text-decoration: none; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); animation: pulse-join 1.5s infinite;">
                                        <i class="fas fa-video" style="margin-right: 6px;"></i>Join Now
                                    </a>
                                    ` : `
                                    <span style="background: rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; white-space: nowrap; min-width: 120px; text-align: center; display: inline-flex; align-items: center; justify-content: center;">${cls.online ? '<i class="fas fa-laptop" style="margin-right:5px;"></i>Online' : (cls.venue ? '<i class="fas fa-building" style="margin-right:5px;"></i>' + cls.venue : '')}</span>
                                    `}
                                </div>
                            </div>
                            `;
            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Upcoming Class Tests -->
                    ${(() => {
                    const testSchedule = JSON.parse(localStorage.getItem('classTests')) || [];
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const upcomingTests = testSchedule
                        .map((test, idx) => ({
                            ...test,
                            originalIndex: idx,
                            testDate: new Date(test.date.split('/').reverse().join('-'))
                        }))
                        .filter(t => t.testDate >= today)
                        .sort((a, b) => a.testDate - b.testDate)
                        .slice(0, 3);

                    if (upcomingTests.length === 0) return '';

                    return `
                    <div style="background: white; border-radius: 30px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); animation: fadeInUp 0.6s ease forwards; animation-delay: 0.25s; opacity: 0;">
                        <div class="flex" style="justify-content: space-between; margin-bottom: 24px;">
                            <h3 style="font-size: 1.4rem; color: #1E293B; margin: 0;"><span style="background: linear-gradient(135deg, #EF4444, #F97316); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;"><i class="fas fa-file-alt" style="margin-right: 8px;"></i><span class="desktop-title">Upcoming Class Tests</span><span class="mobile-title" style="display:none;">Upcoming CT</span></span></h3>
                            <span style="background: #FEE2E2; color: #EF4444; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">${upcomingTests.length} upcoming</span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 14px;">
                            ${upcomingTests.map((test, i) => {
                        const daysUntil = Math.ceil((test.testDate - today) / (1000 * 60 * 60 * 24));
                        const isUrgent = daysUntil <= 3;
                        return `
                            <div style="padding: 18px 22px; border-radius: 20px; background: ${isUrgent ? 'linear-gradient(135deg, #FEE2E2, #FECACA)' : 'linear-gradient(135deg, #FEF3C7, #FDE68A)'}; border: 1px solid ${isUrgent ? '#FECACA' : '#FDE68A'}; position: relative; overflow: hidden;">
                                ${isUrgent ? `
                                <div style="position: absolute; top: 8px; right: 8px; width: 12px; height: 12px; background: #EF4444; border-radius: 50%; animation: pulse 1.5s infinite;"></div>
                                ` : ''}
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 14px; align-items: center;">
                                        <div style="background: ${isUrgent ? 'rgba(239, 68, 68, 0.2)' : 'rgba(217, 119, 6, 0.2)'}; padding: 12px; border-radius: 14px;"><i class="fas fa-file-alt" style="font-size: 1.2rem; color: ${isUrgent ? '#EF4444' : '#D97706'};"></i></div>
                                        <div>
                                            <span style="font-weight: 700; font-size: 1.05rem; display: block; color: #1E293B;">${getCourseTitle(test.subject)}</span>
                                            <span style="opacity: 0.7; font-size: 0.9rem; color: #64748B;"><i class="far fa-calendar-alt" style="margin-right: 5px;"></i>${test.date} at ${test.time.split(' - ')[0]}</span>
                                        </div>
                                    </div>
                                    <span style="background: ${isUrgent ? '#EF4444' : '#D97706'}; color: white; padding: 8px 16px; border-radius: 16px; font-size: 0.8rem; font-weight: 600; white-space: nowrap; min-width: 85px; text-align: center; display: inline-flex; align-items: center; justify-content: center;">${daysUntil === 0 ? 'Today' : daysUntil === 1 ? 'Tomorrow' : daysUntil + ' days'}</span>
                                </div>
                            </div>
                                `;
                    }).join('')}
                        </div>
                    </div>
                        `;
                })()}
                    
                    <!-- Notices -->
                    <div style="background: white; border-radius: 30px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); animation: fadeInUp 0.6s ease forwards; animation-delay: 0.3s; opacity: 0;">
                        <div class="flex" style="justify-content: space-between; margin-bottom: 24px;">
                            <h3 style="font-size: 1.4rem; color: #1E293B; margin: 0;"><span style="background: linear-gradient(135deg, #f093fb, #f5576c); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;"><i class="fas fa-bullhorn" style="margin-right: 8px;"></i>Recent Notices</span></h3>
                            ${unreadNoticesCount > 0 ? `<span style="background: linear-gradient(135deg, #f5576c, #fa709a); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">${unreadNoticesCount} new</span>` : ''}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 14px;">
                            ${notices.length === 0 ? `
                            <div style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <i class="fas fa-bullhorn" style="font-size: 3rem; color: #94A3B8; margin-bottom: 12px;"></i>
                                <span style="color: #94A3B8; font-size: 1.1rem;">No notices yet</span>
                            </div>
                            ` : notices.slice(0, 3).map(n => `
                            <div style="padding: 18px; border-radius: 20px; background: ${n.priority === 'high' ? 'linear-gradient(135deg, #FEF2F2, #FEE2E2)' : 'linear-gradient(135deg, #f8fafc, #f1f5f9)'}; border-left: 4px solid ${n.priority === 'high' ? '#EF4444' : '#6366F1'}; animation: fadeInUp 0.5s ease forwards;">
                                <div class="flex" style="justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 600; color: #1E293B; font-size: 1rem;">${n.title}</span>
                                    ${n.priority === 'high' ? `<span style="background: #EF4444; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">URGENT</span>` : ''}
                                </div>
                                <p style="color: #64748B; font-size: 0.9rem; margin: 0; line-height: 1.5;">${n.description || n.desc || ''}</p>
                            </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Right Column -->
                <div style="display: flex; flex-direction: column; gap: 30px;">
                    
                    <!-- Recent Notes -->
                    <div style="background: white; border-radius: 30px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); animation: fadeInUp 0.6s ease forwards; animation-delay: 0.4s; opacity: 0;">
                        <div class="flex" style="justify-content: space-between; margin-bottom: 24px;">
                            <h3 style="font-size: 1.4rem; color: #1E293B; margin: 0;"><span style="background: linear-gradient(135deg, #43e97b, #38f9d7); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;"><i class="fas fa-sticky-note" style="margin-right: 8px;"></i>Recent Notes</span></h3>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${notes.length === 0 ? `
                            <div style="text-align: center; padding: 30px 20px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <i class="fas fa-file-alt" style="font-size: 2.5rem; color: #94A3B8; margin-bottom: 8px;"></i>
                                <span style="color: #94A3B8; font-size: 1rem;">No notes yet</span>
                            </div>
                            ` : notes.slice(0, 5).map(n => `
                            <div class="flex" onclick="currentPage='notes'; renderNotes(); setTimeout(() => { const el = document.getElementById('note-${n.id}'); if(el) el.scrollIntoView({behavior: 'smooth', block: 'center'}); }, 100);" style="justify-content: space-between; align-items: center; padding: 14px 16px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 16px; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateX(5px)';this.style.boxShadow='0 4px 15px rgba(0,0,0,0.1)'">
                                <div class="flex" style="gap: 12px; align-items: center;">
                                    <span style="background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; padding: 8px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: 600;">${getCourseTitle(n.subject)}</span>
                                    <span style="color: #1E293B; font-weight: 500; font-size: 0.95rem;">${n.title}</span>
                                </div>
                                <i class="fas fa-chevron-right" style="color: #94A3B8; font-size: 0.8rem;"></i>
                            </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    ${isCR ? `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 30px; padding: 30px; color: white; box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4); animation: fadeInUp 0.6s ease forwards; animation-delay: 0.5s; opacity: 0;">
                        <h3 style="font-size: 1.3rem; margin-bottom: 20px;"><i class="fas fa-bolt" style="margin-right: 8px;"></i>Quick Actions</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <button onclick="openModal('ct')" style="background: rgba(255,255,255,0.2); border: none; padding: 14px 20px; border-radius: 16px; color: white; font-size: 1rem; font-weight: 500; cursor: pointer; text-align: left; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)';this.style.transform='scale(1.02)'">
                                <i class="fas fa-file-alt" style="margin-right: 10px;"></i> Add Class Test
                            </button>
                            <button onclick="openModal('note')" style="background: rgba(255,255,255,0.2); border: none; padding: 14px 20px; border-radius: 16px; color: white; font-size: 1rem; font-weight: 500; cursor: pointer; text-align: left; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)';this.style.transform='scale(1.02)'">
                                <i class="fas fa-book" style="margin-right: 10px;"></i> Add Study Note
                            </button>
                            <button onclick="openModal('routine')" style="background: rgba(255,255,255,0.2); border: none; padding: 14px 20px; border-radius: 16px; color: white; font-size: 1rem; font-weight: 500; cursor: pointer; text-align: left; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)';this.style.transform='scale(1.02)'">
                                <i class="fas fa-calendar" style="margin-right: 10px;"></i> Post Today's Routine
                            </button>
                            <button onclick="openModal('notice')" style="background: rgba(255,255,255,0.2); border: none; padding: 14px 20px; border-radius: 16px; color: white; font-size: 1rem; font-weight: 500; cursor: pointer; text-align: left; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)';this.style.transform='scale(1.02)'">
                                <i class="fas fa-bullhorn" style="margin-right: 10px;"></i> Post Notice
                            </button>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
            
            <style>
                @keyframes fadeInUp {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                @keyframes slideIn {
                    from { opacity: 0; transform: translateX(-20px); }
                    to { opacity: 1; transform: translateX(0); }
                }
            </style>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }

        function renderRoutine() {
            // Load test schedule from localStorage or initialize as empty
            let testSchedule = JSON.parse(localStorage.getItem('classTests')) || [];

            // Sort by upcoming date (nearest date first)
            testSchedule.sort((a, b) => {
                const dateA = new Date(a.date.split('/').reverse().join('-'));
                const dateB = new Date(b.date.split('/').reverse().join('-'));
                return dateA - dateB;
            });

            // Show empty state if no tests scheduled
            if (testSchedule.length === 0) {
                document.getElementById('mainContent').innerHTML = `
                <div style="margin-bottom: 32px;">
                    <div style="margin-bottom: 32px;">
                        <h1 class="satoshi" style="font-size: 2rem; margin-bottom: 8px;">Class Test Schedule</h1>
                        <p class="text-secondary">Upcoming class tests and exam schedule</p>
                    </div>
                    
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 24px; border: 1px solid #F1F5F9;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #FEE2E2, #FECACA); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                            <i class="fas fa-calendar-times" style="font-size: 2rem; color: #EF4444;"></i>
                        </div>
                        <h3 style="margin-bottom: 8px; color: #1E293B;">No Class Tests Scheduled</h3>
                        <p class="text-secondary" style="margin-bottom: 24px;">No upcoming class tests. CR can add new schedules.</p>
                    </div>
                </div>
                `;
                return;
            }

            document.getElementById('mainContent').innerHTML = `
            <div style="margin-bottom: 32px;">
                <div style="margin-bottom: 32px;">
                    <h1 class="satoshi" style="font-size: 2rem; margin-bottom: 8px;">Class Test Schedule</h1>
                    <p class="text-secondary">Upcoming class tests and exam schedule</p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px;">
                    ${testSchedule.map((test, index) => {
                const testDate = new Date(test.date.split('/').reverse().join('-'));
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const daysUntil = Math.ceil((testDate - today) / (1000 * 60 * 60 * 24));
                const isUpcoming = daysUntil >= 0 && daysUntil <= 3;
                return `
                        <div style="background: white; border-radius: 24px; overflow: hidden; border: ${isUpcoming ? '2px solid #EF4444' : '1px solid #F1F5F9'}; transition: all 0.3s; ${isUpcoming ? 'box-shadow: 0 8px 30px rgba(239, 68, 68, 0.25);' : ''}" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(0,0,0,0.1)'">
                            <div style="background: linear-gradient(135deg, ${getCardColor(index).start}, ${getCardColor(index).end}); padding: 28px; padding-top: 36px; color: white; position: relative;">
                                ${isUpcoming ? `
                                <div style="position: absolute; top: 8px; left: 8px; width: 32px; height: 32px; background: #EF4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: pulse-alert 1.5s ease-in-out infinite; box-shadow: 0 2px 10px rgba(239, 68, 68, 0.6); z-index: 10;">
                                    <i class="fas fa-bell" style="font-size: 14px; color: white;"></i>
                                </div>
                                ` : ''}
                                <div style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.25); padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; backdrop-filter: blur(4px);">
                                    TEST #${index + 1}
                                </div>
                                <span style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 30px; font-weight: 700; font-size: 1.1rem; backdrop-filter: blur(4px);">${getCourseTitle(test.subject)}</span>
                            </div>
                            
                            <div style="padding: 24px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div style="background: linear-gradient(135deg, #EEF2FF, #E0E7FF); padding: 16px; border-radius: 16px;">
                                        <i class="fas fa-calendar-alt" style="color: #4F46E5; font-size: 1.2rem; margin-bottom: 8px; display: block;"></i>
                                        <span style="color: #64748B; font-size: 0.75rem; display: block; margin-bottom: 4px;">DATE</span>
                                        <span style="font-weight: 700; color: #1E293B;">${test.date}</span>
                                    </div>
                                    <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); padding: 16px; border-radius: 16px;">
                                        <i class="fas fa-clock" style="color: #D97706; font-size: 1.2rem; margin-bottom: 8px; display: block;"></i>
                                        <span style="color: #64748B; font-size: 0.75rem; display: block; margin-bottom: 4px;">TIME</span>
                                        <span style="font-weight: 700; color: #1E293B;">${test.time.split(' - ')[0]}</span>
                                    </div>
                                    <div style="background: linear-gradient(135deg, #D1FAE5, #A7F3D0); padding: 16px; border-radius: 16px;">
                                        <i class="fas fa-map-marker-alt" style="color: #059669; font-size: 1.2rem; margin-bottom: 8px; display: block;"></i>
                                        <span style="color: #64748B; font-size: 0.75rem; display: block; margin-bottom: 4px;">VENUE</span>
                                        <span style="font-weight: 700; color: #1E293B;">${test.venue}</span>
                                    </div>
                                    <div style="background: linear-gradient(135deg, #EDE9FE, #DDD6FE); padding: 16px; border-radius: 16px;">
                                        <i class="fas fa-book" style="color: #7C3AED; font-size: 1.2rem; margin-bottom: 8px; display: block;"></i>
                                        <span style="color: #64748B; font-size: 0.75rem; display: block; margin-bottom: 4px;">SYLLABUS</span>
                                        <span style="font-weight: 700; color: #1E293B;">${test.chapters}</span>
                                    </div>
                                </div>
                                ${currentUser.role === 'cr' ? `
                                <div style="padding-top: 20px; display: flex; gap: 12px;">
                                    <button onclick="editTest(${index})" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;"><i class="fas fa-edit"></i> Edit</button>
                                    <button onclick="deleteTest(${index})" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #DC2626, #EF4444); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;"><i class="fas fa-trash"></i> Delete</button>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `}).join('')}
                </div>
            </div>
        `;
        }

        function renderNotices() {
            const unreadCount = notices.filter(n => !isNoticeReadByUser(n.id)).length;
            const badge = document.getElementById('unreadBadge');
            const dot = document.getElementById('unreadDot');
            if (badge) {
                if (unreadCount > 0) {
                    badge.style.display = 'flex';
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    if (dot) dot.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                    if (dot) dot.style.display = 'none';
                }
            }

            // Show empty state if no notices
            if (notices.length === 0) {
                document.getElementById('mainContent').innerHTML = `
                <div style="margin-bottom: 32px;">
                    <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h1 class="satoshi" style="font-size: 2rem;">Notices & Announcements</h1>
                    </div>
                    
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 24px; border: 1px solid #F1F5F9;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #E0E7FF, #C7D2FE); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                            <i class="fas fa-bullhorn" style="font-size: 2rem; color: #6366F1;"></i>
                        </div>
                        <h3 style="margin-bottom: 8px; color: #1E293B;">No Notices Posted</h3>
                        <p class="text-secondary" style="margin-bottom: 24px;">No notices yet. CR can post new announcements.</p>
                    </div>
                </div>
                `;
                return;
            }

            document.getElementById('mainContent').innerHTML = `
            <div style="margin-bottom: 32px;">
                <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h1 class="satoshi" style="font-size: 2rem;">Notices & Announcements</h1>
                </div>
                
                <div class="flex flex-row filter-container" style="gap: 16px; margin: 24px 0; flex-wrap: wrap; flex-direction: row;">
                    <span class="gradient-bg" onclick="setNoticeFilter('all')" style="padding: 8px 16px; border-radius: 40px; cursor: pointer; background: ${currentNoticeFilter === 'all' ? 'linear-gradient(135deg, #6366F1, #8B5CF6)' : 'linear-gradient(135deg, #E0E7FF, #C7D2FE)'}; color: ${currentNoticeFilter === 'all' ? 'white' : '#6366F1'}; font-size: 0.85rem;">All (${notices.length})</span>
                    <span onclick="setNoticeFilter('high')" style="padding: 8px 16px; border-radius: 40px; background: ${currentNoticeFilter === 'high' ? 'linear-gradient(135deg, #DC2626, #EF4444)' : 'white'}; border: 1px solid ${currentNoticeFilter === 'high' ? '#DC2626' : '#E2E8F0'}; color: ${currentNoticeFilter === 'high' ? 'white' : '#6B7280'}; cursor: pointer; font-size: 0.85rem;">Urgent (${notices.filter(n => n.priority === 'high').length})</span>
                    <span onclick="setNoticeFilter('unread')" style="padding: 8px 16px; border-radius: 40px; background: ${currentNoticeFilter === 'unread' ? 'linear-gradient(135deg, #059669, #10B981)' : 'white'}; border: 1px solid ${currentNoticeFilter === 'unread' ? '#059669' : '#E2E8F0'}; color: ${currentNoticeFilter === 'unread' ? 'white' : '#6B7280'}; cursor: pointer; font-size: 0.85rem;">Unread (${notices.filter(n => !isNoticeReadByUser(n.id)).length})</span>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    ${(currentNoticeFilter === 'all' ? notices : currentNoticeFilter === 'unread' ? notices.filter(n => !isNoticeReadByUser(n.id)) : notices.filter(n => n.priority === currentNoticeFilter)).sort((a, b) => b.id - a.id).map(n => `
                        <div class="notice-card-modern" style="background: white; border-radius: 24px; overflow: hidden; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); transition: all 0.3s ease; ${!isNoticeReadByUser(n.id) ? 'transform: translateY(-2px);' : ''}">
                            <!-- Colorful header based on priority -->
                            <div style="background: ${n.priority === 'high' ? 'linear-gradient(135deg, #EF4444, #F87171)' : n.priority === 'medium' ? 'linear-gradient(135deg, #F59E0B, #FBBF24)' : 'linear-gradient(135deg, #10B981, #34D399)'}; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center;">
                                <div class="flex" style="gap: 10px; align-items: center;">
                                    <span style="background: rgba(255,255,255,0.25); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; color: white; backdrop-filter: blur(4px);">
                                        <i class="fas fa-exclamation-triangle" style="margin-right: 6px;"></i>${n.priority} priority
                                    </span>
                                    ${!isNoticeReadByUser(n.id) ? '<span style="background: white; color: #EF4444; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;">NEW</span>' : ''}
                                </div>
                                ${currentUser.role === 'cr' ? `
                                <span style="color: white; cursor: pointer; opacity: 0.9;" onclick="deleteNoticeItem('${n.id}')">
                                    <i class="fas fa-trash"></i>
                                </span>
                                ` : ''}
                            </div>
                            
                            <!-- Card body -->
                            <div style="padding: 24px;">
                                <h3 style="margin-bottom: 12px; font-size: 1.25rem; font-weight: 700; color: #1E293B; line-height: 1.4;">${n.title}</h3>
                                <p style="color: #64748B; margin-bottom: 20px; line-height: 1.6; font-size: 0.95rem;">${n.description || n.desc || ''}</p>
                                
                                ${n.link ? `
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <a href="${n.link}" target="_blank" style="display: inline-flex; align-items: center; gap: 10px; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; padding: 12px 28px; border-radius: 25px; text-decoration: none; font-weight: 600; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); transition: all 0.3s ease;">
                                        <i class="fas fa-external-link-alt"></i> Open Link
                                    </a>
                                </div>
                                ` : ''}
                                
                                <!-- Footer -->
                                <div class="notice-card-footer flex" style="justify-content: space-between; padding-top: 12px; border-top: 1px solid #F1F5F9;">
                                    <div class="flex" style="gap: 8px; align-items: center;">
                                        <i class="far fa-bell" style="color: #94A3B8; font-size: 0.85rem;"></i>
                                        <span style="color: #94A3B8; font-size: 0.8rem;">Posted by CR</span>
                                    </div>
                                    ${!isNoticeReadByUser(n.id) ? `
                                        <span style="color: #6366F1; cursor: pointer; font-size: 0.9rem; font-weight: 600;" class="mark-read" data-id="${n.id}">
                                            <i class="far fa-check-circle" style="margin-right: 6px;"></i>Mark as read
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

            // Add mark as read functionality
            document.querySelectorAll('.mark-read').forEach(el => {
                // Handle both click and touch events for better mobile support
                const handleMarkAsRead = function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const noticeId = this.getAttribute('data-id');
                    console.log('Marking notice as read, ID:', noticeId);
                    if (noticeId) {
                        markNoticeAsRead(noticeId);
                        renderNotices();
                    }
                };
                el.addEventListener('click', handleMarkAsRead);
                el.addEventListener('touchend', handleMarkAsRead);
            });
        }

        function renderNotes() {
            const subjectCounts = subjects.map(s => ({
                name: s,
                count: notes.filter(n => n.subject === s).length
            })).filter(s => s.count > 0);

            // Show empty state if no notes
            if (notes.length === 0) {
                document.getElementById('mainContent').innerHTML = `
                <div style="margin-bottom: 32px;">
                    <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h1 class="satoshi" style="font-size: 2rem;">Study Notes</h1>
                        </div>
                        ${currentUser.role === 'cr' ? `
                            <button class="gradient-bg" style="padding: 12px 28px; border-radius: 40px; border: none; display: flex; align-items: center; gap: 8px;" id="addNoteBtn">
                                <i class="fas fa-plus"></i> Add note
                            </button>
                        ` : ''}
                    </div>
                    
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 24px; border: 1px solid #F1F5F9;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #EDE9FE, #DDD6FE); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                            <i class="fas fa-book-open" style="font-size: 2rem; color: #8B5CF6;"></i>
                        </div>
                        <h3 style="margin-bottom: 8px; color: #1E293B;">No Study Notes</h3>
                        <p class="text-secondary" style="margin-bottom: 24px;">No notes shared yet. CR can add new study materials.</p>
                    </div>
                </div>
                `;
                return;
            }

            document.getElementById('mainContent').innerHTML = `
            <div style="margin-bottom: 32px;">
                <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h1 class="satoshi" style="font-size: 2rem;">Study Notes</h1>
                    </div>
                    ${currentUser.role === 'cr' ? `
                        <button class="gradient-bg" style="padding: 12px 28px; border-radius: 40px; border: none; display: flex; align-items: center; gap: 8px;" id="addNoteBtn">
                            <i class="fas fa-plus"></i> Add note
                        </button>
                    ` : ''}
                </div>
                
                <!-- Archived Terms -->
                ${archivedTerms.length > 0 ? `
                <div style="margin-bottom: 24px;">
                    <h4 style="margin-bottom: 12px; color: #64748B; font-size: 0.9rem;">Previous Terms</h4>
                    <div class="flex" style="gap: 12px; flex-wrap: wrap;">
                        ${archivedTerms.map(t => `
                            <span onclick="alert('Viewing archived notes from ${t}')" style="background: #F1F5F9; color: #64748B; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid #E2E8F0;">${t}</span>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <!-- Subject Filter Pills -->
                <div class="flex flex-row filter-container" style="gap: 8px; flex-wrap: wrap; margin-bottom: 32px; flex-direction: row;">
                    <span class="subject-pill subject-all" onclick="setNoteFilter('all')" style="padding: 8px 16px; background: ${currentNoteFilter === 'all' ? 'linear-gradient(135deg, #6366F1, #8B5CF6)' : 'white'}; color: ${currentNoteFilter === 'all' ? 'white' : '#6366F1'}; border: 2px solid #6366F1; cursor: pointer; border-radius: 30px; font-size: 0.85rem;">All</span>
                    ${subjectCounts.map(s => `
                        <span class="subject-pill subject-${getCourseTitle(s.name).toLowerCase()}" onclick="setNoteFilter('${s.name}')" style="padding: 8px 16px; background: ${currentNoteFilter === s.name ? 'linear-gradient(135deg, #6366F1, #8B5CF6)' : 'white'}; color: ${currentNoteFilter === s.name ? 'white' : '#6366F1'}; border: 2px solid #6366F1; cursor: pointer; border-radius: 30px; font-size: 0.85rem;">${getCourseTitle(s.name)} <span style="opacity: 0.8; font-size: 0.8em;">(${s.count})</span></span>
                    `).join('')}
                </div>
                
            </div>
            
            <!-- Notes Grid - Modern Card Layout -->
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px;">
                ${((currentNoteFilter === 'all' ? notes : notes.filter(n => n.subject === currentNoteFilter)).filter(n => !currentNoteSearch || n.title.toLowerCase().includes(currentNoteSearch) || (n.description && n.description.toLowerCase().includes(currentNoteSearch)))).map((n, index) => `
                    <div id="note-${n.id}" style="background: white; border-radius: 24px; overflow: hidden; border: 1px solid #F1F5F9; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(0,0,0,0.1)'">
                        <div style="background: linear-gradient(135deg, ${getCardColor(index).start}, ${getCardColor(index).end}); padding: 50px 28px 28px; color: white; position: relative;">
                            <div style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.25); padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; backdrop-filter: blur(4px);">
                                ${getCourseTitle(n.subject)}
                            </div>
                            <h4 style="margin-bottom: 8px; font-size: 1.3rem; font-weight: 700; color: white;">${n.title}</h4>
                        </div>
                        
                        <div style="padding: 24px;">
                            <p class="text-secondary" style="font-size:0.95rem; margin-bottom: 20px; line-height: 1.6;">${n.desc || n.description || ''}</p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div style="background: linear-gradient(135deg, #EEF2FF, #E0E7FF); padding: 14px; border-radius: 14px;">
                                    <i class="fas fa-calendar-alt" style="color: #4F46E5; font-size: 1rem; margin-bottom: 6px; display: block;"></i>
                                    <span style="color: #64748B; font-size: 0.7rem; display: block;">DATE</span>
                                    <span style="font-weight: 700; color: #1E293B; font-size: 0.9rem;">${n.date}</span>
                                </div>
                                <div style="background: linear-gradient(135deg, #D1FAE5, #A7F3D0); padding: 14px; border-radius: 14px;">
                                    <i class="fas fa-link" style="color: #059669; font-size: 1rem; margin-bottom: 6px; display: block;"></i>
                                    <span style="color: #64748B; font-size: 0.7rem; display: block;">SOURCE</span>
                                    <span style="font-weight: 700; color: #1E293B; font-size: 0.9rem;">${n.type === 'telegram' ? 'Telegram' : 'Drive'}</span>
                                </div>
                            </div>
                            
                            <a href="${n.link}" target="_blank" style="display: block; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; padding: 14px; border-radius: 16px; text-decoration: none; font-weight: 600; text-align: center; margin-top: 20px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'">
                                Open Note <i class="fas fa-external-link-alt" style="margin-left: 8px;"></i>
                            </a>
                            ${currentUser.role === 'cr' ? `
                            <div style="display: flex; gap: 12px; margin-top: 16px;">
                                <button onclick="editNote(${index})" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;"><i class="fas fa-edit"></i> Edit</button>
                                <button onclick="deleteNote(${index})" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #DC2626, #EF4444); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;"><i class="fas fa-trash"></i> Delete</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

            if (currentUser.role === 'cr') {
                document.getElementById('addNoteBtn')?.addEventListener('click', () => openModal('note'));
            }
        }

        function renderMembers() {
            const isCR = currentUser.role === 'cr';
            document.getElementById('mainContent').innerHTML = `
            <div style="margin-bottom: 32px;">
                <h1 class="satoshi" style="font-size: 2rem; margin-bottom: 8px;">Account & Settings</h1>
                <p class="text-secondary">Switch between modes</p>
            </div>
            
            <!-- CR Mode Switch -->
            <div style="background: white; border-radius: 24px; padding: 32px; border: 1px solid #F1F5F9;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background: linear-gradient(135deg, #EEF2FF, #E0E7FF); border-radius: 16px;">
                    <div class="flex" style="gap: 16px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #6366F1, #8B5CF6); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user-cog" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 4px;">CR Mode</h4>
                            <span class="text-secondary" style="font-size: 0.9rem;">${isCR ? 'Currently active' : 'Enable to manage class'}</span>
                        </div>
                    </div>
                    <div onclick="if(!${isCR}) { document.getElementById('crAuthModal').style.display='flex'; } else { currentUser.role='student'; localStorage.setItem('crMode', 'false'); renderMembers(); }" style="width: 60px; height: 32px; background: ${isCR ? 'linear-gradient(135deg, #6366F1, #8B5CF6)' : '#E2E8F0'}; border-radius: 20px; position: relative; cursor: pointer; transition: all 0.3s;">
                        <div style="width: 26px; height: 26px; background: white; border-radius: 50%; position: absolute; top: 3px; ${isCR ? 'right: 3px' : 'left: 3px'}; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                    </div>
                </div>
            </div>

            <!-- Current Subjects Section - Only for CR -->
            ${isCR ? `
            <div style="background: white; border-radius: 24px; padding: 32px; border: 1px solid #F1F5F9; margin-top: 24px;">
                <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 1.2rem;">Current Subjects</h3>
                    <button onclick="window.editingSubjectIndex = null; openModal('subject')" style="padding: 8px 16px; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; border: none; border-radius: 20px; font-size: 0.85rem; cursor: pointer; font-weight: 600;"><i class="fas fa-plus" style="margin-right: 6px;"></i>Add</button>
                </div>
                <div id="subjectsList" style="display: flex; flex-direction: column; gap: 12px;">
                    ${subjects.length === 0 ? '<p class="text-secondary" style="text-align: center; padding: 20px;">No subjects added yet</p>' : subjects.map((s, i) => `
                    <div class="flex" style="justify-content: space-between; align-items: center; padding: 16px; background: #F8FAFC; border-radius: 12px;">
                        <div>
                            <span style="font-weight: 600; color: #1E293B;">${getCourseTitle(s)}</span>
                            ${s.includes('(') ? `<span class="text-secondary" style="font-size: 0.85rem; display: block;">${s.match(/\(([^)]+)\)$/)[1]}</span>` : ''}
                        </div>
                        <div class="flex" style="gap: 8px;">
                            <button onclick="editSubject(${i})" style="padding: 8px 12px; background: white; border: 1px solid #E2E8F0; border-radius: 8px; cursor: pointer; color: #6366F1;"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteSubject(${i})" style="padding: 8px 12px; background: white; border: 1px solid #E2E8F0; border-radius: 8px; cursor: pointer; color: #EF4444;"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <!-- CR Auth Modal -->
            <div id="crAuthModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; padding: 40px; border-radius: 24px; max-width: 400px; width: 90%;">
                    <h3 style="margin-bottom: 8px; text-align: center;">Enter CR Password</h3>
                    <p class="text-secondary" style="text-align: center; margin-bottom: 24px;">Authentication required to enable CR mode</p>
                    <input type="password" id="crPassword" oninput="document.getElementById('passwordError').style.display='none'" placeholder="Enter password" style="width: 100%; padding: 14px 18px; border: 1px solid #E2E8F0; border-radius: 12px; font-size: 1rem; margin-bottom: 16px; box-sizing: border-box;">
                    <div id="passwordError" style="display: none; background: #FEF2F2; border: 1px solid #EF4444; color: #DC2626; padding: 10px 14px; border-radius: 8px; margin-bottom: 16px; font-size: 0.85rem; text-align: center;">
                        <span style="font-weight: 600;">⚠️ Incorrect Password</span>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="document.getElementById('crAuthModal').style.display='none'" style="flex: 1; padding: 14px; border: 1px solid #E2E8F0; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6B7280;">Cancel</button>
                        <button onclick="const p=document.getElementById('crPassword').value; if(p==='admin123'){currentUser.role='cr';localStorage.setItem('crMode', 'true');document.getElementById('crAuthModal').style.display='none';document.getElementById('passwordError').style.display='none';renderMembers();}else{document.getElementById('passwordError').style.display='block';}" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">Verify</button>
                    </div>
                </div>
            </div>
            
            ${isCR ? `
            <!-- CR Controls -->
            <div style="margin-top: 32px;">
                <h3 style="margin-bottom: 20px; font-size: 1.2rem;">CR Controls</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                    <div onclick="openModal('note')" style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #F1F5F9; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #10B981, #34D399); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <i class="fas fa-plus" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <h4 style="margin-bottom: 4px;">Add Study Notes</h4>
                        <span class="text-secondary" style="font-size: 0.9rem;">Upload new study materials</span>
                    </div>
                    
                    <div onclick="openModal('notice')" style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #F1F5F9; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #F59E0B, #FBBF24); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <i class="fas fa-bullhorn" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <h4 style="margin-bottom: 4px;">Post Notice</h4>
                        <span class="text-secondary" style="font-size: 0.9rem;">Create class announcements</span>
                    </div>
                    
                    <div onclick="openModal('subject')" style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #F1F5F9; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #06B6D4, #22D3EE); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <i class="fas fa-book-medical" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <h4 style="margin-bottom: 4px;">Add New Subjects</h4>
                        <span class="text-secondary" style="font-size: 0.9rem;">Create new subject cards</span>
                    </div>
                    
                    <div onclick="openModal('routine')" style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #F1F5F9; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #F97316, #FB923C); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <i class="fas fa-calendar-plus" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <h4 style="margin-bottom: 4px;">Post Today's Routine</h4>
                        <span class="text-secondary" style="font-size: 0.9rem;">Update class schedule</span>
                    </div>
                    
                    <div onclick="openModal('ct')" style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #F1F5F9; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #EF4444, #F87171); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <i class="fas fa-file-alt" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <h4 style="margin-bottom: 4px;">New Class Test Schedule</h4>
                        <span class="text-secondary" style="font-size: 0.9rem;">Add CT schedule</span>
                    </div>
                    
                    <div onclick="clearAllDatabase()" style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #FEE2E2; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #DC2626, #EF4444); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <i class="fas fa-trash-alt" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <h4 style="margin-bottom: 4px; color: #DC2626;">Clear Database</h4>
                        <span class="text-secondary" style="font-size: 0.9rem;">Erase all data</span>
                    </div>
                </div>
            </div>
            
            <!-- Subject Modal -->
            <div id="subjectModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
                <div style="background: white; padding: 0; border-radius: 24px; max-width: 480px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #10B981, #34D399); padding: 24px 32px; text-align: center;">
                        <h3 style="margin-bottom: 4px; color: white; font-size: 1.4rem;">Add New Subject</h3>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Create a new subject card</p>
                    </div>
                    <div style="padding: 28px 32px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Course Title</label>
                            <input type="text" id="newSubjectName" placeholder="e.g., Physics, Mathematics, CSE" style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; transition: border-color 0.2s;" onfocus="this.style.borderColor='#10B981'" onblur="this.style.borderColor='#D1FAE5'">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Course Code</label>
                            <input type="text" id="newSubjectCode" placeholder="e.g., PHY101, MTH201" style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; transition: border-color 0.2s;" onfocus="this.style.borderColor='#10B981'" onblur="this.style.borderColor='#D1FAE5'">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Course Teacher</label>
                            <input type="text" id="newSubjectTeacher" placeholder="e.g., Dr. Rahman, Prof. Smith" style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; transition: border-color 0.2s;" onfocus="this.style.borderColor='#10B981'" onblur="this.style.borderColor='#D1FAE5'">
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="const s=document.getElementById('newSubjectName').value; const c=document.getElementById('newSubjectCode').value; const t=document.getElementById('newSubjectTeacher').value; if(s){const fullName = c ? c + ' - ' + s : s; if(window.editingSubjectIndex !== null && window.editingSubjectIndex !== undefined) { subjects[window.editingSubjectIndex] = fullName + (t ? ' (' + t + ')' : ''); window.editingSubjectIndex = null; } else { subjects.push(fullName + (t ? ' (' + t + ')' : '')); } saveSubjects(); document.getElementById('modalOverlay').style.display='none'; showToast({type:'success',title:window.editingSubjectIndex !== null ? 'Updated!' : 'Added!',message:'Subject ' + (window.editingSubjectIndex !== null ? 'updated' : 'added')}); renderMembers();}else{alert('Please enter a subject name');}"ourse title');}" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10B981, #34D399); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3); transition: all 0.2s;">Add Subject</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Routine Modal -->
            <div id="routineModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
                <div style="background: white; padding: 0; border-radius: 24px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); scrollbar-width: none; -ms-overflow-style: none; -webkit-scrollbar-width: none;">
                <style>#routineModal > div::-webkit-scrollbar { display: none !important; width: 0 !important; }</style>
                    <div style="background: linear-gradient(135deg, #6366F1, #8B5CF6); padding: 24px 32px; border-radius: 24px 24px 0 0;">
                        <h3 style="margin-bottom: 4px; text-align: center; color: white; font-size: 1.5rem;">Post Today's Routine</h3>
                        <p style="text-align: center; margin-bottom: 0; color: rgba(255,255,255,0.9); font-size: 0.9rem;">Classes: 8:00 AM - 2:50 PM (50 min each)</p>
                    </div>
                    
                    <div style="padding: 24px;">
                    <div id="routineSlots" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                        <!-- Slot 1 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #E0E7FF;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(59, 130, 246, 0.15)';this.style.borderColor='#3B82F6'">
                            <div style="background: linear-gradient(90deg, #3B82F6, #60A5FA); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #3B82F6; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">1</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">First Class</span>
                                    </div>
                                    <input type="time" id="slot1time" value="08:00" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #1E40AF; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot1subject" style="flex: 1; padding: 10px 12px; border: 1.5px solid #E0E7FF; border-radius: 10px; font-size: 0.85rem; background: #F8FAFC; color: #1E40AF; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot1venue" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #E0E7FF; border-radius: 10px; font-size: 0.85rem; background: #F8FAFC; color: #1E40AF; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #EFF6FF; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #BFDBFE;">
                                        <input type="checkbox" id="slot1online" onchange="toggleOnlineLink(this, 'slot1venue')" style="accent-color: #3B82F6; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #3B82F6; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 2 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #EDE9FE;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(139, 92, 246, 0.15)';this.style.borderColor='#8B5CF6'">
                            <div style="background: linear-gradient(90deg, #8B5CF6, #A78BFA); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #8B5CF6; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">2</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Second Class</span>
                                    </div>
                                    <input type="time" id="slot2time" value="08:50" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #6D28D9; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot2subject" style="flex: 1; padding: 10px 12px; border: 1.5px solid #EDE9FE; border-radius: 10px; font-size: 0.85rem; background: #F8FAFC; color: #6D28D9; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot2venue" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #EDE9FE; border-radius: 10px; font-size: 0.85rem; background: #F8FAFC; color: #6D28D9; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #F5F3FF; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #DDD6FE;">
                                        <input type="checkbox" id="slot2online" onchange="toggleOnlineLink(this, 'slot2venue')" style="accent-color: #8B5CF6; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #8B5CF6; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 3 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #FEF3C7;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(245, 158, 11, 0.15)';this.style.borderColor='#F59E0B'">
                            <div style="background: linear-gradient(90deg, #F59E0B, #FBBF24); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #F59E0B; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">3</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Third Class</span>
                                    </div>
                                    <input type="time" id="slot3time" value="09:50" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #B45309; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot3subject" style="flex: 1; padding: 10px 12px; border: 1.5px solid #FEF3C7; border-radius: 10px; font-size: 0.85rem; background: #FFFBEB; color: #B45309; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot3venue" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #FEF3C7; border-radius: 10px; font-size: 0.85rem; background: #FFFBEB; color: #B45309; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #FEF3C7; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #FDE68A;">
                                        <input type="checkbox" id="slot3online" onchange="toggleOnlineLink(this, 'slot3venue')" style="accent-color: #F59E0B; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #F59E0B; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 4 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #D1FAE5;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(16, 185, 129, 0.15)';this.style.borderColor='#10B981'">
                            <div style="background: linear-gradient(90deg, #10B981, #34D399); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #10B981; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">4</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Fourth Class</span>
                                    </div>
                                    <input type="time" id="slot4time" value="10:40" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #047857; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot4subject" style="flex: 1; padding: 10px 12px; border: 1.5px solid #D1FAE5; border-radius: 10px; font-size: 0.85rem; background: #ECFDF5; color: #047857; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot4venue" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #D1FAE5; border-radius: 10px; font-size: 0.85rem; background: #ECFDF5; color: #047857; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #D1FAE5; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #A7F3D0;">
                                        <input type="checkbox" id="slot4online" onchange="toggleOnlineLink(this, 'slot4venue')" style="accent-color: #10B981; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #10B981; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 5 (Break at 11:20 AM) -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #FEE2E2;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(239, 68, 68, 0.15)';this.style.borderColor='#EF4444'">
                            <div style="background: linear-gradient(90deg, #EF4444, #F87171); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #EF4444; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">5</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Fifth Class</span>
                                    </div>
                                    <input type="time" id="slot5time" value="11:30" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #B91C1C; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot5subject" style="flex: 1; padding: 10px 12px; border: 1.5px solid #FEE2E2; border-radius: 10px; font-size: 0.85rem; background: #FEF2F2; color: #B91C1C; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot5venue" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #FEE2E2; border-radius: 10px; font-size: 0.85rem; background: #FEF2F2; color: #B91C1C; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #FEE2E2; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #FECACA;">
                                        <input type="checkbox" id="slot5online" onchange="toggleOnlineLink(this, 'slot5venue')" style="accent-color: #EF4444; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #EF4444; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 6 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #DCFCE7;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(34, 197, 94, 0.15)';this.style.borderColor='#22C55E'">
                            <div style="background: linear-gradient(90deg, #22C55E, #4ADE80); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #22C55E; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">6</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Sixth Class</span>
                                    </div>
                                    <input type="time" id="slot6time" value="12:20" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #15803D; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot6subject" style="flex: 1; padding: 10px 12px; border: 1.5px solid #DCFCE7; border-radius: 10px; font-size: 0.85rem; background: #F0FDF4; color: #15803D; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot6venue" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #DCFCE7; border-radius: 10px; font-size: 0.85rem; background: #F0FDF4; color: #15803D; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #DCFCE7; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #BBF7D0;">
                                        <input type="checkbox" id="slot6online" onchange="toggleOnlineLink(this, 'slot6venue')" style="accent-color: #22C55E; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #22C55E; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 7 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #FEF3C7;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(245, 158, 11, 0.15)';this.style.borderColor='#F59E0B'">
                            <div style="background: linear-gradient(90deg, #F59E0B, #FBBF24); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #F59E0B; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">7</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Seventh Class</span>
                                    </div>
                                    <input type="time" id="slot7time" value="13:10" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #B45309; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot7subject" style="flex: 1; padding: 10px 12px; border: 1.5px solid #FEF3C7; border-radius: 10px; font-size: 0.85rem; background: #FFFBEB; color: #B45309; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot7venue" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #FEF3C7; border-radius: 10px; font-size: 0.85rem; background: #FFFBEB; color: #B45309; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #FEF3C7; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #FDE68A;">
                                        <input type="checkbox" id="slot7online" onchange="toggleOnlineLink(this, 'slot7venue')" style="accent-color: #F59E0B; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #F59E0B; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 8 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #FEF9C3;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(234, 179, 8, 0.15)';this.style.borderColor='#EAB308'">
                            <div style="background: linear-gradient(90deg, #EAB308, #FACC15); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #EAB308; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">8</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Eighth Class</span>
                                    </div>
                                    <input type="time" id="slot8time" value="14:00" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #A16207; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot8subject" style="flex: 1; padding: 10px 12px; border: 1.5px solid #FEF9C3; border-radius: 10px; font-size: 0.85rem; background: #FEFCE8; color: #A16207; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot8venue" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #FEF9C3; border-radius: 10px; font-size: 0.85rem; background: #FEFCE8; color: #A16207; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #FEF9C3; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #FEF08A;">
                                        <input type="checkbox" id="slot8online" onchange="toggleOnlineLink(this, 'slot8venue')" style="accent-color: #EAB308; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #EAB308; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 9 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #F3E8FF;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(168, 85, 247, 0.15)';this.style.borderColor='#A855F7'">
                            <div style="background: linear-gradient(90deg, #A855F7, #C084FC); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #A855F7; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">9</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Ninth Class</span>
                                    </div>
                                    <input type="time" id="slot9time" value="14:50" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #7E22CE; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot9subject" style="flex: 1; padding: 10px 12px; border: 1.5px solid #F3E8FF; border-radius: 10px; font-size: 0.85rem; background: #FAF5FF; color: #7E22CE; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot9venue" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #F3E8FF; border-radius: 10px; font-size: 0.85rem; background: #FAF5FF; color: #7E22CE; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #F3E8FF; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #E9D5FF;">
                                        <input type="checkbox" id="slot9online" onchange="toggleOnlineLink(this, 'slot9venue')" style="accent-color: #A855F7; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #A855F7; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; padding: 0 24px 24px;">
                        <button onclick="document.getElementById('routineModal').style.display='none'" style="flex: 1; padding: 14px; border: 1px solid #E2E8F0; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #64748B; transition: all 0.2s;">Cancel</button>
                        <button onclick="const routine=[];for(let i=1;i<=9;i++){const s=document.getElementById('slot'+i+'subject');const t=document.getElementById('slot'+i+'time');const v=document.getElementById('slot'+i+'venue');const o=document.getElementById('slot'+i+'online');if(s&&s.value){routine.push({subject:s.value,time:t?t.value:'--:--',venue:v?v.value:'',online:o?o.checked:false})}}localStorage.setItem('todaysRoutine',JSON.stringify(routine));loadTodaysRoutine();document.getElementById('routineModal').style.display='none';alert('Routine posted for today!');renderDashboard();" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #F97316, #FB923C); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 14px rgba(249, 115, 22, 0.4); transition: all 0.2s;">Post Routine</button>
                    </div>
                </div>
            </div>
            
            <!-- CT Schedule Modal -->
            <div id="ctModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
                <div style="background: white; padding: 0; border-radius: 24px; max-width: 480px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #EF4444, #F87171); padding: 24px 32px; text-align: center;">
                        <h3 style="margin-bottom: 4px; color: white; font-size: 1.4rem;">New Class Test Schedule</h3>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Add a CT schedule for your class</p>
                    </div>
                    <div style="padding: 28px 32px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Select Subject</label>
                            <select id="ctSubject" style="width: 100%; padding: 12px 16px; border: 2px solid #FEE2E2; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; background: white; color: #991B1B;">
                                ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                            </select>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Date</label>
                            <input type="date" id="ctDate" style="width: 100%; padding: 12px 16px; border: 2px solid #FEE2E2; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; color: #991B1B;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Time</label>
                            <input type="text" id="ctTime" placeholder="e.g., 10:00 AM - 12:00 PM" style="width: 100%; padding: 12px 16px; border: 2px solid #FEE2E2; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; color: #991B1B;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Venue</label>
                            <input type="text" id="ctVenue" placeholder="e.g., LH201" style="width: 100%; padding: 12px 16px; border: 2px solid #FEE2E2; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; color: #991B1B;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Syllabus</label>
                            <input type="text" id="ctSyllabus" placeholder="e.g., Ch 1-5" style="width: 100%; padding: 12px 16px; border: 2px solid #FEE2E2; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; color: #991B1B;">
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="document.getElementById('ctModal').style.display='none'" style="flex: 1; padding: 12px; border: 2px solid #FEE2E2; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6B7280;">Cancel</button>
                            <button onclick="saveClassTest()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #EF4444, #F87171); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);">Add CT</button>
                        </div>
                    </div>
                </div>
            </div>
            

            ` : ''}
        `;
        }

        function renderSyllabus() {
            document.getElementById('mainContent').innerHTML = `
            <h1 class="satoshi" style="font-size: 2rem; margin-bottom: 24px;">Course Syllabus</h1>
            <div style="background: white; border-radius: 32px; padding: 32px; border: 1px solid #F1F5F9;">
                <div style="margin-bottom: 20px;">
                    <div class="flex" style="justify-content: space-between; padding: 20px; background: #F8FAFC; border-radius: 24px; margin-bottom: 12px;">
                        <div><span style="font-weight: 600;">Physics (PHY101)</span><br><span class="text-secondary">Units 1-5</span></div>
                        <i class="fas fa-chevron-down" style="color: #94A3B8;"></i>
                    </div>
                    <div class="flex" style="justify-content: space-between; padding: 20px; background: #F8FAFC; border-radius: 24px; margin-bottom: 12px;">
                        <div><span style="font-weight: 600;">Mathematics (MTH101)</span><br><span class="text-secondary">Calculus & Algebra</span></div>
                        <i class="fas fa-chevron-down" style="color: #94A3B8;"></i>
                    </div>
                    <div class="flex" style="justify-content: space-between; padding: 20px; background: #F8FAFC; border-radius: 24px;">
                        <div><span style="font-weight: 600;">CSE (CSE101)</span><br><span class="text-secondary">Programming Fundamentals</span></div>
                        <i class="fas fa-chevron-down" style="color: #94A3B8;"></i>
                    </div>
                </div>
                <div style="margin-top: 24px; text-align: center;">
                    <a href="#" style="color: #4F46E5; text-decoration: none;">Download complete syllabus PDF →</a>
                </div>
            </div>
        `;
        }

        function renderCalendar() {
            document.getElementById('mainContent').innerHTML = `
            <h1 class="satoshi" style="font-size: 2rem; margin-bottom: 24px;">Exam Calendar</h1>
            <div style="display: grid; grid-template-columns: 1fr 300px; gap: 24px;">
                <div style="background: white; border-radius: 32px; padding: 32px; border: 1px solid #F1F5F9;">
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 16px;">
                        ${['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(d => `<div style="text-align: center; font-weight: 600; color: #64748B;">${d}</div>`).join('')}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
                        ${Array.from({ length: 35 }, (_, i) => `
                            <div style="aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 20px; ${i === 15 ? 'background: #EEF2FF; color: #4F46E5; font-weight:600;' : ''}">
                                ${i + 1}
                                ${i === 15 ? '<div style="width: 6px; height: 6px; background: #4F46E5; border-radius: 6px; margin-top: 2px;"></div>' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div style="background: white; border-radius: 32px; padding: 24px; border: 1px solid #F1F5F9;">
                    <h3 style="margin-bottom: 20px;">Upcoming Exams</h3>
                    <div style="padding: 16px; background: #F8FAFC; border-radius: 20px; margin-bottom: 12px;">
                        <span style="font-weight: 600;">Physics Mid-term</span>
                        <div class="flex" style="justify-content: space-between; margin-top: 8px;">
                            <span class="text-secondary">Mar 15</span>
                            <span style="color: #DC2626;">in 5 days</span>
                        </div>
                    </div>
                    <div style="padding: 16px; background: #F8FAFC; border-radius: 20px;">
                        <span style="font-weight: 600;">Math Quiz</span>
                        <div class="flex" style="justify-content: space-between; margin-top: 8px;">
                            <span class="text-secondary">Mar 18</span>
                            <span style="color: #D97706;">in 8 days</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        }

        function renderCRMode() {
            // Check if user is authenticated as CR
            if (currentUser.role !== 'cr') {
                document.getElementById('mainContent').innerHTML = `
                <div style="margin-bottom: 32px;">
                    <h1 class="satoshi" style="font-size: 2rem; margin-bottom: 8px;">CR Mode</h1>
                    <p class="text-secondary">Authentication required to access CR settings</p>
                </div>

                <div style="background: white; border-radius: 28px; padding: 40px; border: 1px solid #F1F5F9; max-width: 400px; margin: 0 auto; text-align: center;">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #FEE2E2, #FECACA); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                        <i class="fas fa-lock" style="font-size: 2rem; color: #DC2626;"></i>
                    </div>
                    <h3 style="margin-bottom: 12px; color: #1E293B;">Authentication Required</h3>
                    <p class="text-secondary" style="margin-bottom: 24px;">Enter CR password to access settings</p>
                    <input type="password" id="crPasswordInput" oninput="document.getElementById('crAuthError').style.display='none'" placeholder="Enter password" style="width: 100%; padding: 14px 18px; border: 2px solid #E2E8F0; border-radius: 12px; font-size: 1rem; margin-bottom: 16px; box-sizing: border-box;">
                    <div id="crAuthError" style="display: none; background: #FEF2F2; border: 1px solid #EF4444; color: #DC2626; padding: 10px 14px; border-radius: 8px; margin-bottom: 16px; font-size: 0.85rem; text-align: center;">
                        Incorrect password. Please try again.
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="document.getElementById('crPasswordInput').value='';currentPage='dashboard';renderDashboard();" style="flex: 1; padding: 14px; border: 1px solid #E2E8F0; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6B7280;">Cancel</button>
                        <button onclick="const p=document.getElementById('crPasswordInput').value; if(p==='admin123'){currentUser.role='cr';localStorage.setItem('crMode', 'true');document.getElementById('crAuthError').style.display='none';renderCRMode();showToast({type:'success',title:'Welcome!',message:'CR mode enabled'});}else{document.getElementById('crAuthError').style.display='block';}" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-sign-in-alt" style="margin-right: 8px;"></i>Login
                        </button>
                    </div>
                </div>
                `;
                return;
            }

            const iconOptions = [
                { value: 'fa-scroll', label: 'Scroll' },
                { value: 'fa-book', label: 'Book' },
                { value: 'fa-graduation-cap', label: 'Graduation' },
                { value: 'fa-school', label: 'School' },
                { value: 'fa-university', label: 'University' },
                { value: 'fa-users', label: 'Users' },
                { value: 'fa-layer-group', label: 'Layer' },
                { value: 'fa-star', label: 'Star' },
                { value: 'fa-heart', label: 'Heart' },
                { value: 'fa-gem', label: 'Gem' }
            ];

            document.getElementById('mainContent').innerHTML = `
            <div style="margin-bottom: 32px;">
                <div class="flex" style="justify-content: space-between; align-items: center;">
                    <div>
                        <h1 class="satoshi" style="font-size: 2rem; margin-bottom: 8px;">CR Mode Settings</h1>
                        <p class="text-secondary">Manage your class website settings</p>
                    </div>
                    <button onclick="currentUser.role='student';renderCRMode();showToast({type:'info',title:'Logged out',message:'CR mode disabled'});" style="padding: 10px 20px; background: #F1F5F9; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; color: #64748B;">
                        <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i>Logout
                    </button>
                </div>
            </div>

            <!-- Logo Settings Card -->
            <div style="background: white; border-radius: 28px; padding: 32px; border: 1px solid #F1F5F9; margin-bottom: 24px;">
                <h3 style="font-size: 1.3rem; margin-bottom: 20px; color: #1E293B;"><i class="fas fa-palette" style="margin-right: 10px; color: #6366F1;"></i>Website Branding</h3>
                
                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Website Name</label>
                    <input type="text" id="websiteNameInput" value="${websiteSettings.websiteName}" 
                        style="width: 100%; padding: 14px 18px; border: 2px solid #E2E8F0; border-radius: 14px; font-size: 1rem; transition: all 0.2s;"
                        onfocus="this.style.borderColor='#6366F1';this.style.boxShadow='0 0 0 4px rgba(99,102,241,0.1)'"
                        onblur="this.style.borderColor='#E2E8F0';this.style.boxShadow='none'">
                </div>

                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #374151;">Logo Icon</label>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
                        ${iconOptions.map(icon => `
                            <div onclick="selectLogoIcon('${icon.value}')" 
                                style="padding: 16px; border-radius: 16px; cursor: pointer; text-align: center; border: 2px solid ${websiteSettings.logoIcon === icon.value ? '#6366F1' : '#E2E8F0'}; background: ${websiteSettings.logoIcon === icon.value ? '#EEF2FF' : '#F8FAFC'}; transition: all 0.2s;"
                                onmouseover="this.style.borderColor='#6366F1'"
                                onmouseout="this.style.borderColor='${websiteSettings.logoIcon === icon.value ? '#6366F1' : '#E2E8F0'}'">
                                <i class="fas ${icon.value}" style="font-size: 1.5rem; color: ${websiteSettings.logoIcon === icon.value ? '#6366F1' : '#64748B'};"></i>
                                <div style="font-size: 0.75rem; margin-top: 6px; color: #64748B;">${icon.label}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <button onclick="saveWebsiteSettings()" 
                    style="padding: 14px 32px; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; border: none; border-radius: 14px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 20px rgba(99,102,241,0.4)'"
                    onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
                    <i class="fas fa-save" style="margin-right: 8px;"></i>Save Changes
                </button>
            </div>

            <!-- Preview Card -->
            <div style="background: white; border-radius: 28px; padding: 32px; border: 1px solid #F1F5F9;">
                <h3 style="font-size: 1.3rem; margin-bottom: 20px; color: #1E293B;"><i class="fas fa-eye" style="margin-right: 10px; color: #6366F1;"></i>Preview</h3>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 24px; display: flex; align-items: center; gap: 16px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 14px; border-radius: 14px;">
                        <i class="fas ${websiteSettings.logoIcon}" style="font-size: 1.8rem; color: white;"></i>
                    </div>
                    <span class="satoshi" style="font-size: 1.5rem; font-weight: 700; color: white;">${websiteSettings.websiteName}</span>
                </div>
            </div>
            `;
        }

        function selectLogoIcon(icon) {
            websiteSettings.logoIcon = icon;
            renderCRMode();
        }

        function saveWebsiteSettings() {
            const newName = document.getElementById('websiteNameInput').value.trim();
            if (newName) {
                websiteSettings.websiteName = newName;
                localStorage.setItem('websiteSettings', JSON.stringify(websiteSettings));
                updateLogoDisplay();
                showToast({
                    type: 'success',
                    title: 'Saved!',
                    message: 'Website branding has been updated.'
                });
            }
        }

        function updateLogoDisplay() {
            // Update sidebar logo
            const sidebarLogo = document.querySelector('.sidebar .logo i');
            const sidebarLogoText = document.querySelector('.sidebar .logo span');
            if (sidebarLogo) sidebarLogo.className = `fas ${websiteSettings.logoIcon}`;
            if (sidebarLogoText) sidebarLogoText.textContent = websiteSettings.websiteName;

            // Update mobile logo
            const mobileLogo = document.querySelector('.logo-mobile i');
            const mobileLogoText = document.querySelector('.logo-mobile span');
            if (mobileLogo) mobileLogo.className = `fas ${websiteSettings.logoIcon}`;
            if (mobileLogoText) mobileLogoText.textContent = websiteSettings.websiteName;

            // Update page title
            document.title = `${websiteSettings.websiteName} — Class Management`;
        }

        // Initialize logo on page load
        // Update header based on login status
        function updateHeaderAuth() {
            const container = document.getElementById('authButtonContainer');
            if (!container) return;

            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                if (user.studentId) {
                    const initial = user.name ? user.name.charAt(0).toUpperCase() : 'U';
                    container.innerHTML = `
                        <div class="notification-bell" onclick="currentPage='notices';renderNotices();">
                            <i class="far fa-bell"></i>
                            <span class="notification-badge" id="unreadBadge" style="display: none;">0</span>
                        </div>
                        <div onclick="showProfileModal()"
                            style="width: 44px; height: 44px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.1rem; cursor: pointer; margin-right: 12px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s ease;">
                            ${initial}
                        </div>`;
                }
            }
        }

        window.addEventListener('DOMContentLoaded', function () {
            updateLogoDisplay();
            updateHeaderAuth();
        });

        // Toggle online link for room input
        function toggleOnlineLink(checkbox, venueId) {
            const venueInput = document.getElementById(venueId);
            if (checkbox.checked) {
                // Store original placeholder
                venueInput.setAttribute('data-placeholder', venueInput.getAttribute('placeholder') || 'Room');
                venueInput.setAttribute('placeholder', 'Meeting Link (e.g., meet.google.com/...)');
                venueInput.style.borderColor = '#8B5CF6';
                venueInput.style.background = '#F5F3FF';
            } else {
                // Restore original placeholder
                const placeholder = venueInput.getAttribute('data-placeholder') || 'Room';
                venueInput.setAttribute('placeholder', placeholder);
                venueInput.style.borderColor = '';
                venueInput.style.background = '';
            }
        }

        // modal for CR
        function openModal(type) {
            const overlay = document.getElementById('modalOverlay');
            const inner = document.getElementById('modalInner');
            if (type === 'note') {
                inner.innerHTML = `
                <div style="background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                    <div style="background: linear-gradient(135deg, #10B981, #34D399); padding: 24px 32px; text-align: center;">
                        <h2 style="margin-bottom: 4px; color: white; font-size: 1.4rem;">Add New Note</h2>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Upload study materials for your class</p>
                    </div>
                    <form id="noteForm" style="display: flex; flex-direction: column; gap: 16px; padding: 28px 32px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Select Subject</label>
                            <select id="noteSubjectModal" style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; background: white; color: #065F46; font-size: 0.95rem; outline: none;">
                                <option value="">Choose a subject</option>
                                ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Note Title</label>
                            <input type="text" id="noteTitleModal" placeholder="e.g., Chapter 1 Summary" 
                                style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; background: white; color: #1E293B; font-size: 0.95rem; outline: none; box-sizing: border-box;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Short Description</label>
                            <textarea id="noteDescModal" placeholder="Brief description of the note content" rows="3"
                                style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; background: white; color: #1E293B; font-size: 0.95rem; outline: none; resize: none; box-sizing: border-box;"></textarea>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Share Link</label>
                            <input type="text" id="noteLinkModal" placeholder="Telegram or Google Drive link" 
                                style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; background: white; color: #1E293B; font-size: 0.95rem; outline: none; box-sizing: border-box;">
                        </div>
                        
                        <div style="display: flex; gap: 12px; margin-top: 8px;">
                            <button type="button" style="flex: 1; padding: 12px; border: 2px solid #E2E8F0; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6B7280;" id="closeModal">
                                Cancel
                            </button>
                            <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10B981, #34D399); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);">
                                Publish Note
                            </button>
                        </div>
                    </form>
                </div>
            `;
            } else if (type === 'notice') {
                inner.innerHTML = `
                <div style="background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                    <div style="background: linear-gradient(135deg, #F59E0B, #FBBF24); padding: 24px 32px; text-align: center;">
                        <h2 style="margin-bottom: 4px; color: white; font-size: 1.4rem;">Post Notice</h2>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Create class announcements</p>
                    </div>
                    <form id="noticeForm" style="display: flex; flex-direction: column; gap: 16px; padding: 28px 32px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Notice Title</label>
                            <input type="text" id="noticeTitleModal" placeholder="e.g., Exam Schedule, Class Cancelled" 
                                style="width: 100%; padding: 12px 16px; border: 2px solid #FEF3C7; border-radius: 12px; background: white; color: #1E293B; font-size: 0.95rem; outline: none; box-sizing: border-box;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Notice Content</label>
                            <textarea id="noticeDescModal" placeholder="Write your notice message here..." rows="4"
                                style="width: 100%; padding: 12px 16px; border: 2px solid #FEF3C7; border-radius: 12px; background: white; color: #1E293B; font-size: 0.95rem; outline: none; resize: none; box-sizing: border-box;"></textarea>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Priority</label>
                            <select id="noticePriorityModal" style="width: 100%; padding: 12px 16px; border: 2px solid #FEF3C7; border-radius: 12px; background: white; color: #92400E; font-size: 0.95rem; outline: none;">
                                <option value="">Select priority</option>
                                <option value="high">🔴 High Priority</option>
                                <option value="medium">🟡 Medium Priority</option>
                                <option value="low">🟢 Low Priority</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Link (Optional)</label>
                            <input type="url" id="noticeLinkModal" placeholder="https://zoom.us/j/..." 
                                style="width: 100%; padding: 12px 16px; border: 2px solid #FEF3C7; border-radius: 12px; background: white; color: #1E293B; font-size: 0.95rem; outline: none; box-sizing: border-box;">
                        </div>
                        
                        <div style="display: flex; gap: 12px; margin-top: 8px;">
                            <button type="button" style="flex: 1; padding: 12px; border: 2px solid #E2E8F0; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6B7280;" id="closeModal">
                                Cancel
                            </button>
                            <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #F59E0B, #FBBF24); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3);">
                                Post Notice
                            </button>
                        </div>
                    </form>
                </div>
            `;
            } else if (type === 'routine') {
                inner.innerHTML = `
                <div style="background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-height: 90vh; overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none; -webkit-scrollbar-width: none;">
                    <style>#routineModalContent::-webkit-scrollbar, .routine-content::-webkit-scrollbar { display: none !important; }</style>
                    <div style="background: linear-gradient(135deg, #6366F1, #8B5CF6); padding: 24px 32px; border-radius: 24px 24px 0 0;">
                        <h3 style="margin-bottom: 4px; text-align: center; color: white; font-size: 1.5rem;">Post Today's Routine</h3>
                        <p style="text-align: center; margin-bottom: 0; color: rgba(255,255,255,0.9); font-size: 0.9rem;">Classes: 8:00 AM - 2:50 PM (50 min each)</p>
                    </div>
                    
                    <div style="padding: 24px;">
                    <div id="routineSlots" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                        <!-- Slot 1 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #E0E7FF;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(59, 130, 246, 0.15)';this.style.borderColor='#3B82F6'">
                            <div style="background: linear-gradient(90deg, #3B82F6, #60A5FA); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #3B82F6; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">1</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">First Class</span>
                                    </div>
                                    <input type="time" id="slot1timeModal" value="08:00" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #1E40AF; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot1subjectModal" style="flex: 1; padding: 10px 12px; border: 1.5px solid #E0E7FF; border-radius: 10px; font-size: 0.85rem; background: #F8FAFC; color: #1E40AF; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot1venueModal" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #E0E7FF; border-radius: 10px; font-size: 0.85rem; background: #F8FAFC; color: #1E40AF; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #EFF6FF; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #BFDBFE;">
                                        <input type="checkbox" id="slot1onlineModal" onchange="toggleOnlineLink(this, 'slot1venueModal')" style="accent-color: #3B82F6; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #3B82F6; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 2 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #EDE9FE;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(139, 92, 246, 0.15)';this.style.borderColor='#8B5CF6'">
                            <div style="background: linear-gradient(90deg, #8B5CF6, #A78BFA); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #8B5CF6; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">2</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Second Class</span>
                                    </div>
                                    <input type="time" id="slot2timeModal" value="08:50" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #6D28D9; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot2subjectModal" style="flex: 1; padding: 10px 12px; border: 1.5px solid #EDE9FE; border-radius: 10px; font-size: 0.85rem; background: #F8FAFC; color: #6D28D9; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot2venueModal" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #EDE9FE; border-radius: 10px; font-size: 0.85rem; background: #F8FAFC; color: #6D28D9; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #F5F3FF; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #DDD6FE;">
                                        <input type="checkbox" id="slot2onlineModal" onchange="toggleOnlineLink(this, 'slot2venueModal')" style="accent-color: #8B5CF6; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #8B5CF6; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 3 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #FEF3C7;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(245, 158, 11, 0.15)';this.style.borderColor='#F59E0B'">
                            <div style="background: linear-gradient(90deg, #F59E0B, #FBBF24); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #F59E0B; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">3</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Third Class</span>
                                    </div>
                                    <input type="time" id="slot3timeModal" value="09:50" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #B45309; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot3subjectModal" style="flex: 1; padding: 10px 12px; border: 1.5px solid #FEF3C7; border-radius: 10px; font-size: 0.85rem; background: #FFFBEB; color: #B45309; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot3venueModal" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #FEF3C7; border-radius: 10px; font-size: 0.85rem; background: #FFFBEB; color: #B45309; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #FEF3C7; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #FDE68A;">
                                        <input type="checkbox" id="slot3onlineModal" onchange="toggleOnlineLink(this, 'slot3venueModal')" style="accent-color: #F59E0B; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #F59E0B; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 4 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #D1FAE5;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(16, 185, 129, 0.15)';this.style.borderColor='#10B981'">
                            <div style="background: linear-gradient(90deg, #10B981, #34D399); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #10B981; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">4</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Fourth Class</span>
                                    </div>
                                    <input type="time" id="slot4timeModal" value="10:40" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #047857; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot4subjectModal" style="flex: 1; padding: 10px 12px; border: 1.5px solid #D1FAE5; border-radius: 10px; font-size: 0.85rem; background: #ECFDF5; color: #047857; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot4venueModal" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #D1FAE5; border-radius: 10px; font-size: 0.85rem; background: #ECFDF5; color: #047857; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #D1FAE5; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #A7F3D0;">
                                        <input type="checkbox" id="slot4onlineModal" onchange="toggleOnlineLink(this, 'slot4venueModal')" style="accent-color: #10B981; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #10B981; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 5 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #FEE2E2;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(239, 68, 68, 0.15)';this.style.borderColor='#EF4444'">
                            <div style="background: linear-gradient(90deg, #EF4444, #F87171); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #EF4444; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">5</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Fifth Class</span>
                                    </div>
                                    <input type="time" id="slot5timeModal" value="11:30" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #B91C1C; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot5subjectModal" style="flex: 1; padding: 10px 12px; border: 1.5px solid #FEE2E2; border-radius: 10px; font-size: 0.85rem; background: #FEF2F2; color: #B91C1C; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot5venueModal" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #FEE2E2; border-radius: 10px; font-size: 0.85rem; background: #FEF2F2; color: #B91C1C; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #FEE2E2; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #FECACA;">
                                        <input type="checkbox" id="slot5onlineModal" onchange="toggleOnlineLink(this, 'slot5venueModal')" style="accent-color: #EF4444; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #EF4444; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 6 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #DCFCE7;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(34, 197, 94, 0.15)';this.style.borderColor='#22C55E'">
                            <div style="background: linear-gradient(90deg, #22C55E, #4ADE80); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #22C55E; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">6</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Sixth Class</span>
                                    </div>
                                    <input type="time" id="slot6timeModal" value="12:20" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #15803D; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot6subjectModal" style="flex: 1; padding: 10px 12px; border: 1.5px solid #DCFCE7; border-radius: 10px; font-size: 0.85rem; background: #F0FDF4; color: #15803D; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot6venueModal" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #DCFCE7; border-radius: 10px; font-size: 0.85rem; background: #F0FDF4; color: #15803D; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #DCFCE7; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #BBF7D0;">
                                        <input type="checkbox" id="slot6onlineModal" onchange="toggleOnlineLink(this, 'slot6venueModal')" style="accent-color: #22C55E; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #22C55E; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 7 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #FEF3C7;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(245, 158, 11, 0.15)';this.style.borderColor='#F59E0B'">
                            <div style="background: linear-gradient(90deg, #F59E0B, #FBBF24); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #F59E0B; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">7</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Seventh Class</span>
                                    </div>
                                    <input type="time" id="slot7timeModal" value="13:10" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #B45309; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot7subjectModal" style="flex: 1; padding: 10px 12px; border: 1.5px solid #FEF3C7; border-radius: 10px; font-size: 0.85rem; background: #FFFBEB; color: #B45309; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot7venueModal" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #FEF3C7; border-radius: 10px; font-size: 0.85rem; background: #FFFBEB; color: #B45309; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #FEF3C7; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #FDE68A;">
                                        <input type="checkbox" id="slot7onlineModal" onchange="toggleOnlineLink(this, 'slot7venueModal')" style="accent-color: #F59E0B; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #F59E0B; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 8 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #FEF9C3;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(234, 179, 8, 0.15)';this.style.borderColor='#EAB308'">
                            <div style="background: linear-gradient(90deg, #EAB308, #FACC15); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #EAB308; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">8</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Eighth Class</span>
                                    </div>
                                    <input type="time" id="slot8timeModal" value="14:00" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #A16207; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot8subjectModal" style="flex: 1; padding: 10px 12px; border: 1.5px solid #FEF9C3; border-radius: 10px; font-size: 0.85rem; background: #FEFCE8; color: #A16207; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot8venueModal" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #FEF9C3; border-radius: 10px; font-size: 0.85rem; background: #FEFCE8; color: #A16207; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #FEF9C3; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #FEF08A;">
                                        <input type="checkbox" id="slot8onlineModal" onchange="toggleOnlineLink(this, 'slot8venueModal')" style="accent-color: #EAB308; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #EAB308; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slot 9 -->
                        <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #F3E8FF;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(168, 85, 247, 0.15)';this.style.borderColor='#A855F7'">
                            <div style="background: linear-gradient(90deg, #A855F7, #C084FC); padding: 12px 18px;">
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 12px; align-items: center;">
                                        <span style="background: white; color: #A855F7; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">9</span>
                                        <span style="color: white; font-weight: 600; font-size: 0.95rem;">Ninth Class</span>
                                    </div>
                                    <input type="time" id="slot9timeModal" value="14:50" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #7E22CE; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                </div>
                            </div>
                            <div style="padding: 16px;">
                                <div class="flex" style="gap: 10px;">
                                    <select id="slot9subjectModal" style="flex: 1; padding: 10px 12px; border: 1.5px solid #F3E8FF; border-radius: 10px; font-size: 0.85rem; background: #FAF5FF; color: #7E22CE; font-weight: 500;">
                                        <option value="">Select Subject</option>
                                        ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                    </select>
                                    <input type="text" id="slot9venueModal" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #F3E8FF; border-radius: 10px; font-size: 0.85rem; background: #FAF5FF; color: #7E22CE; font-weight: 500;">
                                    <label class="flex" style="gap: 5px; cursor: pointer; background: #F3E8FF; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #E9D5FF;">
                                        <input type="checkbox" id="slot9onlineModal" onchange="toggleOnlineLink(this, 'slot9venueModal')" style="accent-color: #A855F7; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #A855F7; font-weight: 600;">Online</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button type="button" style="flex: 1; padding: 14px; border: 1px solid #E2E8F0; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #64748B;" id="closeModal">
                            Cancel
                        </button>
                        <button type="button" id="postRoutineBtn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #F97316, #FB923C); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 14px rgba(249, 115, 22, 0.4);">
                            Post Routine
                        </button>
                    </div>
                    </div>
                </div>
            `;
            } else if (type === 'subject') {
                inner.innerHTML = `
                <div style="background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                    <div style="background: linear-gradient(135deg, #10B981, #34D399); padding: 24px 32px; text-align: center;">
                        <h2 style="margin-bottom: 4px; color: white; font-size: 1.4rem;">Add New Subject</h2>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Create a new subject card</p>
                    </div>
                    <div style="padding: 28px 32px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Course Title</label>
                            <input type="text" id="newSubjectNameModal" placeholder="e.g., Physics, Mathematics" style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Course Code</label>
                            <input type="text" id="newSubjectCodeModal" placeholder="e.g., PHY101" style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Course Teacher</label>
                            <input type="text" id="newSubjectTeacherModal" placeholder="e.g., Dr. Rahman" style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box;">
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button type="button" onclick="document.getElementById('modalOverlay').style.display='none'" style="flex: 1; padding: 12px; border: 2px solid #D1FAE5; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6B7280;">
                                Cancel
                            </button>
                            <button type="button" onclick="const s=document.getElementById('newSubjectNameModal').value; const c=document.getElementById('newSubjectCodeModal').value; const t=document.getElementById('newSubjectTeacherModal').value; if(s){const fullName = c ? c + ' - ' + s : s; if(window.editingSubjectIndex !== null && window.editingSubjectIndex !== undefined) { subjects[window.editingSubjectIndex] = fullName + (t ? ' (' + t + ')' : ''); window.editingSubjectIndex = null; } else { subjects.push(fullName + (t ? ' (' + t + ')' : '')); } saveSubjects(); document.getElementById('modalOverlay').style.display='none'; showToast({type:'success',title:window.editingSubjectIndex !== null ? 'Updated!' : 'Added!',message:'Subject ' + (window.editingSubjectIndex !== null ? 'updated' : 'added')}); renderMembers();}else{alert('Please enter a subject name');}");}else{alert('Please enter course title');}" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10B981, #34D399); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);">
                                Add Subject
                            </button>
                        </div>
                    </div>
                </div>
            `;
            } else if (type === 'term') {
                inner.innerHTML = `
                <div style="background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                    <div style="background: linear-gradient(135deg, #8B5CF6, #A78BFA); padding: 24px 32px; text-align: center;">
                        <h2 style="margin-bottom: 4px; color: white; font-size: 1.4rem;">Promote to Next Term</h2>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Move to next level</p>
                    </div>
                    <div style="padding: 28px 32px; text-align: center;">
                        <div style="background: #F5F3FF; padding: 20px; border-radius: 16px; margin-bottom: 20px;">
                            <p style="color: #6B7280; margin-bottom: 8px; font-size: 0.9rem;">Current Term</p>
                            <p style="color: #7C3AED; font-weight: 700; font-size: 1.2rem;">Level 3 Term 2</p>
                        </div>
                        <div style="background: #ECFDF5; padding: 20px; border-radius: 16px; margin-bottom: 20px;">
                            <p style="color: #6B7280; margin-bottom: 8px; font-size: 0.9rem;">Next Term</p>
                            <p style="color: #059669; font-weight: 700; font-size: 1.2rem;">Level 4 Term 1</p>
                        </div>
                        <p style="color: #6B7280; text-align: center; margin-bottom: 24px; font-size: 0.9rem;">This will archive all current notes to 'Previous Terms' and reset for the new term.</p>
                        <div style="display: flex; gap: 12px;">
                            <button type="button" style="flex: 1; padding: 12px; border: 2px solid #EDE9FE; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6B7280;" id="closeModal">
                                Cancel
                            </button>

                        </div>
                    </div>
                </div>
            `;
            } else if (type === 'ct') {
                inner.innerHTML = `
                <div style="background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                    <div style="background: linear-gradient(135deg, #EF4444, #F87171); padding: 24px 32px; text-align: center;">
                        <h2 style="margin-bottom: 4px; color: white; font-size: 1.4rem;">New Class Test Schedule</h2>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Add a CT schedule for your class</p>
                    </div>
                    <form id="ctForm" style="display: flex; flex-direction: column; gap: 16px; padding: 28px 32px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Select Subject</label>
                            <select id="ctSubjectModal" style="width: 100%; padding: 12px 16px; border: 2px solid #FEE2E2; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; background: white; color: #991B1B;">
                                ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Date</label>
                            <input type="date" id="ctDateModal" style="width: 100%; padding: 12px 16px; border: 2px solid #FEE2E2; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; color: #991B1B;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Time</label>
                            <input type="text" id="ctTimeModal" placeholder="e.g., 10:00 AM - 12:00 PM" style="width: 100%; padding: 12px 16px; border: 2px solid #FEE2E2; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; color: #991B1B;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Venue</label>
                            <input type="text" id="ctVenueModal" placeholder="e.g., LH201" style="width: 100%; padding: 12px 16px; border: 2px solid #FEE2E2; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; color: #991B1B;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Syllabus</label>
                            <input type="text" id="ctSyllabusModal" placeholder="e.g., Ch 1-5" style="width: 100%; padding: 12px 16px; border: 2px solid #FEE2E2; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; color: #991B1B;">
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 8px;">
                            <button type="button" style="flex: 1; padding: 12px; border: 2px solid #FEE2E2; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6B7280;" id="closeModal">
                                Cancel
                            </button>
                            <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #EF4444, #F87171); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);">
                                Add CT
                            </button>
                        </div>
                    </form>
                </div>
            `;
            }
            overlay.style.display = 'grid';

            document.getElementById('closeModal')?.addEventListener('click', (e) => {
                e.preventDefault();
                overlay.style.display = 'none';
            });

            // Handle CT form submission
            document.getElementById('ctForm')?.addEventListener('submit', function (e) {
                e.preventDefault();
                const s = document.getElementById('ctSubjectModal').value;
                const d = document.getElementById('ctDateModal').value;
                const t = document.getElementById('ctTimeModal').value;
                const v = document.getElementById('ctVenueModal').value;
                const sy = document.getElementById('ctSyllabusModal').value;

                if (d && t && v && sy) {
                    const testSchedule = JSON.parse(localStorage.getItem('classTests')) || [];

                    if (window.editingTestIndex !== undefined && window.editingTestIndex !== null) {
                        // Update existing
                        testSchedule[window.editingTestIndex] = { subject: s, date: d, time: t, venue: v, chapters: sy };
                        window.editingTestIndex = null;
                    } else {
                        // Add new
                        testSchedule.push({ subject: s, date: d, time: t, venue: v, chapters: sy });
                    }

                    localStorage.setItem('classTests', JSON.stringify(testSchedule));
                    // Update global classTests array and save to Supabase
                    classTests = testSchedule;
                    saveClassTests();
                    overlay.style.display = 'none';
                    alert(window.editingTestIndex !== null ? 'CT updated!' : 'CT scheduled: ' + s + ' on ' + d);
                    // Refresh the current page
                    location.reload();
                } else {
                    alert('Please fill all fields');
                }
            });

            // Handle Notice form submission
            document.getElementById('noticeForm')?.addEventListener('submit', function (e) {
                e.preventDefault();
                const title = this.querySelector('input[type="text"]').value;
                const description = this.querySelector('textarea').value;
                const priority = this.querySelector('select').value;
                const linkInput = this.querySelector('input[type="url"]');
                const link = linkInput ? linkInput.value : '';
                if (title && description && priority) {
                    const newNotice = {
                        id: Date.now(),
                        title: title,
                        priority: priority,
                        description: description,
                        link: link,
                        expiry: '',
                        pinned: false,
                        read: false
                    };
                    const existingNotices = JSON.parse(localStorage.getItem('notices')) || [];
                    existingNotices.unshift(newNotice);
                    localStorage.setItem('notices', JSON.stringify(existingNotices));
                    notices = existingNotices;
                    overlay.style.display = 'none';
                    alert('Notice posted: ' + title);
                    // Save to Supabase and refresh
                    saveNotices().then(() => location.reload());
                } else {
                    alert('Please fill all fields');
                }
            });

            // Handle Note form submission
            document.getElementById('noteForm')?.addEventListener('submit', function (e) {
                e.preventDefault();
                const subject = document.getElementById('noteSubjectModal').value;
                const title = document.getElementById('noteTitleModal').value;
                const desc = document.getElementById('noteDescModal').value;
                const link = document.getElementById('noteLinkModal').value;
                const type = document.getElementById('noteTypeModal') ? document.getElementById('noteTypeModal').value : 'telegram';

                if (subject && title && desc) {
                    const existingNotes = JSON.parse(localStorage.getItem('notes')) || [];

                    if (window.editingNoteIndex !== undefined && window.editingNoteIndex !== null) {
                        // Update existing note
                        existingNotes[window.editingNoteIndex] = {
                            ...existingNotes[window.editingNoteIndex],
                            subject: subject,
                            title: title,
                            desc: desc,
                            link: link || '#',
                            type: type || 'telegram'
                        };
                        window.editingNoteIndex = null;
                    } else {
                        // Add new note
                        const newNote = {
                            id: Date.now(),
                            subject: subject,
                            title: title,
                            date: new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }),
                            desc: desc,
                            link: link || '#',
                            type: type || 'telegram'
                        };
                        existingNotes.unshift(newNote);
                    }

                    localStorage.setItem('notes', JSON.stringify(existingNotes));
                    notes = existingNotes;
                    overlay.style.display = 'none';
                    alert(window.editingNoteIndex !== null ? 'Note updated!' : 'Note added: ' + title);
                    // Save to Supabase and refresh
                    saveNotes().then(() => location.reload());
                } else {
                    alert('Please fill all required fields');
                }
            });

            // Handle Post Routine button
            document.getElementById('postRoutineBtn')?.addEventListener('click', function () {
                const routine = [];
                for (let i = 1; i <= 9; i++) {
                    const s = document.getElementById('slot' + i + 'subjectModal');
                    const t = document.getElementById('slot' + i + 'timeModal');
                    const v = document.getElementById('slot' + i + 'venueModal');
                    const o = document.getElementById('slot' + i + 'onlineModal');
                    if (s && s.value) {
                        const slotData = {
                            subject: s.value,
                            time: t ? t.value : '--:--',
                            venue: v ? v.value : '',
                            online: o ? o.checked : false
                        };
                        routine.push(slotData);

                        // If online class is checked and venue has a link, auto-generate a notice
                        if (slotData.online && slotData.venue && (slotData.venue.includes('http') || slotData.venue.includes('meet') || slotData.venue.includes('zoom'))) {
                            const teacherMatch = s.value.match(/\(([^)]+)\)$/);
                            const teacherName = teacherMatch ? teacherMatch[1] : 'your teacher';
                            const subjectName = s.value.replace(/\s*\([^)]+\)$/, '').replace(/^[A-Za-z0-9]+\s*-\s*/, '');

                            const newNotice = {
                                id: Date.now() + i, // Unique ID
                                title: subjectName + ' Online Class',
                                priority: 'high',
                                description: 'An online class in ' + subjectName + ' will be held today at ' + slotData.time + ' by ' + teacherName,
                                link: slotData.venue,
                                expiry: '',
                                pinned: true,
                                read: false,
                                created_at: new Date().toISOString()
                            };
                            const existingNotices = JSON.parse(localStorage.getItem('notices')) || [];
                            existingNotices.unshift(newNotice);
                            localStorage.setItem('notices', JSON.stringify(existingNotices));
                            notices = existingNotices;
                            console.log('Auto-created notice for online class:', newNotice);
                        }
                    }
                }
                todaysRoutine = routine;
                localStorage.setItem('todaysRoutine', JSON.stringify(routine));
                document.getElementById('modalOverlay').style.display = 'none';
                alert('Routine posted for today!');
                // Save to Supabase and refresh
                saveTodaysRoutine().then(() => {
                    saveNotices().then(() => location.reload());
                });
            });

            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.style.display = 'none';
            };
        }

        // navigation
        let currentPage = 'dashboard';

        document.querySelectorAll('[data-page]').forEach(el => {
            el.addEventListener('click', (e) => {
                const page = e.currentTarget.dataset.page;
                if (!page) return;

                // Update active states
                document.querySelectorAll('.nav-item, .bottom-nav i').forEach(n => n.classList.remove('active'));
                e.currentTarget.classList.add('active');

                // Track current page
                currentPage = page;

                // Render page
                if (page === 'dashboard') renderDashboard();
                if (page === 'routine') renderRoutine();
                if (page === 'notices') renderNotices();
                if (page === 'notes') renderNotes();
                if (page === 'members') renderMembers();
                if (page === 'syllabus') renderSyllabus();
                if (page === 'cr-mode') renderCRMode();

                // Close modal if open
                document.getElementById('modalOverlay').style.display = 'none';
            });
        });

        // Function to re-render current page
        function reRenderCurrentPage() {
            if (currentPage === 'routine') renderRoutine();
            else if (currentPage === 'notes') renderNotes();
            else if (currentPage === 'notices') renderNotices();
            else if (currentPage === 'dashboard') renderDashboard();
            else if (currentPage === 'members') renderMembers();
            else if (currentPage === 'cr-mode') renderCRMode();
        }

        // FAB only for CR
        const fabElement = document.getElementById('fab');
        if (fabElement && currentUser.role === 'cr') {
            fabElement.style.display = 'flex';
            fabElement.addEventListener('click', () => openModal('note'));
        }

        // Mobile menu toggle
        document.getElementById('menuToggle')?.addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            sidebar.style.display = sidebar.style.display === 'block' ? 'none' : 'block';
        });

        // Notification bell click handler
        document.addEventListener('DOMContentLoaded', function () {
            // Handle online/offline events for polling
            window.addEventListener('online', function () {
                console.log('Back online - resuming polling');
                startPolling();
            });

            window.addEventListener('offline', function () {
                console.log('Gone offline - stopping polling');
                stopPolling();
            });

            // Initialize audio on first user click anywhere
            document.addEventListener('click', function initOnce() {
                initAudioOnInteraction();
                document.removeEventListener('click', initOnce);
            }, { once: true });

            const bell = document.querySelector('.notification-bell');
            if (bell) {
                bell.addEventListener('click', function () {
                    // Add clicked class for animation
                    this.classList.add('clicked');

                    // Remove the class after animation completes
                    setTimeout(() => {
                        this.classList.remove('clicked');
                    }, 500);

                    // Navigate to notices page
                    currentPage = 'notices';
                    renderNotices();

                    // Update active states
                    document.querySelectorAll('.nav-item, .bottom-nav i').forEach(n => n.classList.remove('active'));
                    document.querySelectorAll('[data-page="notices"]').forEach(n => n.classList.add('active'));
                });
            }

            // Handle deep links from notifications
            const urlParams = new URLSearchParams(window.location.search);
            const linkParam = urlParams.get('link');
            const titleParam = urlParams.get('title');

            if (linkParam) {
                // Show confirmation to open link in browser
                const confirmed = confirm(`Open ${titleParam || 'this link'} in browser?`);
                if (confirmed) {
                    window.open(linkParam, '_blank');
                }
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        // Initialize - ALWAYS show login first, then load data after authentication
        function checkAuthAndInitialize() {
            // ALWAYS show the login page first
            var authPage = document.getElementById('authPage');
            if (authPage) {
                authPage.style.display = 'flex';
            }

            // Hide app container initially
            var appContainer = document.getElementById('app');
            if (appContainer) {
                appContainer.style.display = 'none';
            }

            // Check if user is logged in
            var isLoggedIn = false;
            try {
                var savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    var user = JSON.parse(savedUser);
                    if (user && user.studentId) {
                        isLoggedIn = true;
                    }
                }
            } catch (e) {
                console.warn('localStorage not available:', e);
            }

            if (isLoggedIn) {
                // User is logged in - load data and then show dashboard
                initializeData().then(function () {
                    // Initialize data hashes for polling
                    lastDataHash.notices = getDataHash(notices);
                    lastDataHash.notes = getDataHash(notes);
                    lastDataHash.todaysRoutine = getDataHash(todaysRoutine);
                    lastDataHash.classTests = getDataHash(classTests);

                    // Start polling for real-time updates
                    startPolling();

                    // Hide login page and show the app container
                    var authPage = document.getElementById('authPage');
                    if (authPage) {
                        authPage.style.display = 'none';
                    }

                    var appContainer = document.getElementById('app');
                    if (appContainer) {
                        appContainer.style.display = 'flex';
                    }

                    // Update header to show user avatar
                    updateHeaderAuth();

                    // User is logged in - render dashboard
                    renderDashboard();

                    // Check unread notices and update badge
                    if (notices.some(function (n) { return !isNoticeReadByUser(n.id); })) {
                        var badge = document.getElementById('unreadBadge');
                        var dot = document.getElementById('unreadDot');
                        if (badge) {
                            var unreadCount = notices.filter(function (n) { return !isNoticeReadByUser(n.id); }).length;
                            badge.style.display = 'flex';
                            badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                            if (dot) dot.style.display = 'block';
                        }
                    } else {
                        var dot = document.getElementById('unreadDot');
                        if (dot) dot.style.display = 'none';
                    }
                });
            }
        }

        // Start authentication check immediately
        checkAuthAndInitialize();
    </script>

    <!-- Auth Page (Login/Signup) - Full Page View -->
    <div id="authPage"
        style="min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); z-index: 2000; align-items: center; justify-content: center; padding: 20px;">
        <div
            style="background: white; padding: 48px; border-radius: 32px; max-width: 420px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: slideUp 0.4s ease; position: relative;">
            <div id="loginFormContainer">
                <div style="text-align: center; margin-bottom: 32px;">
                    <div
                        style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 24px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 16px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); animation: pulse 2s infinite;">
                        <i class="fas fa-graduation-cap" style="color: white; font-size: 2rem;"></i>
                    </div>
                    <h2
                        style="margin: 0 0 8px 0; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; font-size: 1.8rem;">
                        Welcome Back!</h2>
                    <p class="text-secondary">Sign in to continue</p>
                </div>
                <input type="text" id="loginStudentId" placeholder="Student ID"
                    style="width: 100%; padding: 16px 20px; border: 2px solid #E2E8F0; border-radius: 16px; font-size: 1rem; margin-bottom: 16px; box-sizing: border-box; transition: all 0.3s;">
                <input type="password" id="loginPassword" placeholder="Password"
                    style="width: 100%; padding: 16px 20px; border: 2px solid #E2E8F0; border-radius: 16px; font-size: 1rem; margin-bottom: 16px; box-sizing: border-box; transition: all 0.3s;">
                <div id="loginError"
                    style="display: none; background: #FEF2F2; border: 1px solid #EF4444; color: #DC2626; padding: 12px 16px; border-radius: 12px; margin-bottom: 16px; font-size: 0.9rem; text-align: center;">
                </div>
                <button onclick="handleLogin()"
                    style="width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 16px; cursor: pointer; font-size: 1.1rem; font-weight: 600; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); transition: all 0.3s; margin-bottom: 16px;">Sign
                    In</button>
                <p style="text-align: center; color: #6B7280;">
                    Don't have an account?
                    <span onclick="showSignup()" style="color: #667eea; font-weight: 600; cursor: pointer;">Sign
                        Up</span>
                </p>
            </div>

            <div id="signupFormContainer" style="display: none;">
                <div style="text-align: center; margin-bottom: 32px;">
                    <div
                        style="width: 80px; height: 80px; background: linear-gradient(135deg, #f093fb, #f5576c); border-radius: 24px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 16px; box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4); animation: pulse 2s infinite;">
                        <i class="fas fa-user-plus" style="color: white; font-size: 2rem;"></i>
                    </div>
                    <h2
                        style="margin: 0 0 8px 0; background: linear-gradient(135deg, #f093fb, #f5576c); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; font-size: 1.8rem;">
                        Create Account</h2>
                    <p class="text-secondary">Join your class</p>
                </div>
                <input type="text" id="signupFullName" placeholder="Full Name"
                    style="width: 100%; padding: 16px 20px; border: 2px solid #E2E8F0; border-radius: 16px; font-size: 1rem; margin-bottom: 12px; box-sizing: border-box;">
                <input type="text" id="signupStudentId" placeholder="Student ID (unique)"
                    style="width: 100%; padding: 16px 20px; border: 2px solid #E2E8F0; border-radius: 16px; font-size: 1rem; margin-bottom: 12px; box-sizing: border-box;">
                <input type="password" id="signupPassword" placeholder="Password"
                    style="width: 100%; padding: 16px 20px; border: 2px solid #E2E8F0; border-radius: 16px; font-size: 1rem; margin-bottom: 12px; box-sizing: border-box;">
                <input type="password" id="signupConfirmPassword" placeholder="Confirm Password"
                    style="width: 100%; padding: 16px 20px; border: 2px solid #E2E8F0; border-radius: 16px; font-size: 1rem; margin-bottom: 16px; box-sizing: border-box;">
                <div id="signupError"
                    style="display: none; background: #FEF2F2; border: 1px solid #EF4444; color: #DC2626; padding: 12px 16px; border-radius: 12px; margin-bottom: 16px; font-size: 0.9rem; text-align: center;">
                </div>
                <button onclick="handleSignup()"
                    style="width: 100%; padding: 16px; background: linear-gradient(135deg, #f093fb, #f5576c); color: white; border: none; border-radius: 16px; cursor: pointer; font-size: 1.1rem; font-weight: 600; box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4); transition: all 0.3s; margin-bottom: 16px;">Create
                    Account</button>
                <p style="text-align: center; color: #6B7280;">
                    Already have an account?
                    <span onclick="showLogin()" style="color: #f5576c; font-weight: 600; cursor: pointer;">Sign
                        In</span>
                </p>
            </div>

        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); z-index: 2000; align-items: center; justify-content: center; animation: fadeIn 0.3s ease;">
        <div
            style="background: white; padding: 40px; border-radius: 24px; max-width: 420px; width: 90%; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <button onclick="document.getElementById('profileModal').style.display='none'"
                style="position: absolute; top: 16px; right: 16px; background: #F1F5F9; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1rem; color: #64748B;">✕</button>

            <div style="text-align: center; margin-bottom: 24px;">
                <div
                    style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 16px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);">
                    <i class="fas fa-user" style="color: white; font-size: 2rem;"></i>
                </div>
                <h2 style="margin: 0 0 8px 0; color: #1E293B; font-weight: 700; font-size: 1.5rem;">My Profile</h2>
                <p class="text-secondary">Manage your account</p>
            </div>

            <div style="margin-bottom: 16px;">
                <label
                    style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Student
                    ID</label>
                <input type="text" id="profileStudentId" readonly
                    style="width: 100%; padding: 14px 16px; border: 2px solid #E2E8F0; border-radius: 12px; font-size: 1rem; background: #F8FAFC; color: #64748B; cursor: not-allowed; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 16px;">
                <label
                    style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Full
                    Name</label>
                <input type="text" id="profileFullName"
                    style="width: 100%; padding: 14px 16px; border: 2px solid #E2E8F0; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 20px;">
                <label
                    style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">New
                    Password</label>
                <input type="password" id="profileNewPassword" placeholder="Enter new password"
                    style="width: 100%; padding: 14px 16px; border: 2px solid #E2E8F0; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
            </div>

            <div id="profileError"
                style="display: none; background: #FEF2F2; border: 1px solid #EF4444; color: #DC2626; padding: 12px 16px; border-radius: 12px; margin-bottom: 16px; font-size: 0.9rem; text-align: center;">
            </div>

            <div style="display: flex; gap: 12px;">
                <button onclick="document.getElementById('profileModal').style.display='none'"
                    style="flex: 1; padding: 14px; border: 1px solid #E2E8F0; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6B7280;">Cancel</button>
                <button onclick="updateProfile()"
                    style="flex: 1; padding: 14px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">Save
                    Changes</button>
            </div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #E2E8F0;">
                <button onclick="logout()"
                    style="width: 100%; padding: 14px; background: #FEF2F2; border: 1px solid #EF4444; border-radius: 12px; cursor: pointer; font-weight: 600; color: #DC2626;">
                    <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i>Logout
                </button>
            </div>
        </div>
    </div>

    <script>
        function showSignup() {
            document.getElementById('loginFormContainer').style.display = 'none';
            document.getElementById('signupFormContainer').style.display = 'block';
        }
        function showLogin() {
            document.getElementById('signupFormContainer').style.display = 'none';
            document.getElementById('loginFormContainer').style.display = 'block';
        }
        async function handleLogin() {
            const studentId = document.getElementById('loginStudentId').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!studentId || !password) {
                errorDiv.textContent = 'Please fill in all fields';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.textContent = 'Connecting to server...';
            errorDiv.style.display = 'block';

            try {
                console.log('Attempting login for student ID:', studentId);
                const users = await supabaseClient.getUserByStudentId(studentId);
                console.log('Supabase response:', users);

                errorDiv.style.display = 'none';

                if (!users || !Array.isArray(users) || users.length === 0) {
                    errorDiv.textContent = 'Student ID not found. Please sign up first.';
                    errorDiv.style.display = 'block';
                    return;
                }

                const user = users[0];
                console.log('User data:', user);
                console.log('Stored password:', user.password_hash);
                console.log('Entered password:', password);

                if (user.password_hash !== password) {
                    errorDiv.textContent = 'Invalid Student ID or Password';
                    errorDiv.style.display = 'block';
                    return;
                }

                // Login successful
                currentUser = {
                    id: user.id,
                    name: user.full_name,
                    studentId: user.student_id,
                    role: 'student',
                    avatar: user.full_name.charAt(0).toUpperCase()
                };
                try {
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                } catch (e) {
                    console.warn('localStorage save failed:', e);
                }

                // Hide login page and show dashboard
                document.getElementById('authPage').style.display = 'none';

                // Show the app container using inline style
                var appContainer = document.getElementById('app');
                if (appContainer) {
                    appContainer.style.display = 'flex';
                }

                // Update header to show user avatar
                updateHeaderAuth();

                // Load data and render dashboard
                initializeData().then(() => {
                    lastDataHash.notices = getDataHash(notices);
                    lastDataHash.notes = getDataHash(notes);
                    lastDataHash.todaysRoutine = getDataHash(todaysRoutine);
                    lastDataHash.classTests = getDataHash(classTests);
                    startPolling();
                    renderDashboard();
                });

                showToast({ type: 'success', title: 'Welcome back!', message: 'Logged in successfully' });
            } catch (e) {
                console.error('Login error:', e);
                errorDiv.textContent = 'Login failed: ' + e.message + '. Please try again.';
                errorDiv.style.display = 'block';
                console.error('Login error:', e);
            }
        }

        async function handleSignup() {
            const fullName = document.getElementById('signupFullName').value;
            const studentId = document.getElementById('signupStudentId').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const errorDiv = document.getElementById('signupError');

            if (!fullName || !studentId || !password || !confirmPassword) {
                errorDiv.textContent = 'Please fill in all fields';
                errorDiv.style.display = 'block';
                return;
            }

            if (password !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                console.log('Checking for existing user with ID:', studentId);
                const existing = await supabaseClient.getUserByStudentId(studentId);
                console.log('Existing user check result:', existing);

                if (existing && existing.length > 0) {
                    errorDiv.textContent = 'Student ID already registered';
                    errorDiv.style.display = 'block';
                    return;
                }

                console.log('Creating new user with ID:', studentId);
                const newUser = await supabaseClient.createUser({
                    student_id: studentId,
                    full_name: fullName,
                    password_hash: password
                });
                console.log('User created:', newUser);

                // Handle different response formats (array or object)
                const createdUser = Array.isArray(newUser) ? newUser[0] : newUser;

                if (!createdUser || !createdUser.id) {
                    // User might already exist - check again
                    const checkAgain = await supabaseClient.getUserByStudentId(studentId);
                    if (checkAgain && checkAgain.length > 0) {
                        errorDiv.textContent = 'Student ID already registered';
                        errorDiv.style.display = 'block';
                        return;
                    }
                    throw new Error('Failed to create user');
                }

                currentUser = {
                    id: createdUser.id,
                    name: fullName,
                    studentId: studentId,
                    role: 'student',
                    avatar: fullName.charAt(0).toUpperCase()
                };
                try {
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                } catch (e) {
                    console.warn('localStorage save failed:', e);
                }

                // Hide login page and show dashboard
                document.getElementById('authPage').style.display = 'none';

                // Show the app container
                const appContainer = document.getElementById('app');
                if (appContainer) {
                    appContainer.style.display = 'flex';
                }

                // Update header to show user avatar
                updateHeaderAuth();

                // Load data and render dashboard
                initializeData().then(() => {
                    lastDataHash.notices = getDataHash(notices);
                    lastDataHash.notes = getDataHash(notes);
                    lastDataHash.todaysRoutine = getDataHash(todaysRoutine);
                    lastDataHash.classTests = getDataHash(classTests);
                    startPolling();
                    renderDashboard();
                });

                showToast({ type: 'success', title: 'Welcome!', message: 'Account created successfully' });
            } catch (e) {
                errorDiv.textContent = 'Signup failed. Please try again. Check your internet connection.';
                errorDiv.style.display = 'block';
                console.error('Signup error:', e);
            }
        }

        // Profile Modal Functions
        function showProfileModal() {
            const savedUser = localStorage.getItem('currentUser');
            if (!savedUser) return;

            const user = JSON.parse(savedUser);
            document.getElementById('profileStudentId').value = user.studentId || '';
            document.getElementById('profileFullName').value = user.name || '';
            document.getElementById('profileNewPassword').value = '';
            document.getElementById('profileError').style.display = 'none';
            document.getElementById('profileModal').style.display = 'flex';
        }

        async function updateProfile() {
            const newName = document.getElementById('profileFullName').value.trim();
            const newPassword = document.getElementById('profileNewPassword').value;
            const errorDiv = document.getElementById('profileError');

            if (!newName) {
                errorDiv.textContent = 'Please enter your name';
                errorDiv.style.display = 'block';
                return;
            }

            const savedUser = localStorage.getItem('currentUser');
            if (!savedUser) return;

            const user = JSON.parse(savedUser);

            // Always update localStorage first
            user.name = newName;
            localStorage.setItem('currentUser', JSON.stringify(user));

            // Try to update in Supabase if available
            if (USE_SUPABASE && user.id) {
                try {
                    const updates = { full_name: newName };
                    if (newPassword) {
                        updates.password_hash = newPassword;
                    }
                    await supabaseClient.updateUser(user.id, updates);
                } catch (e) {
                    console.log('Supabase update failed, using localStorage only');
                }
            }

            document.getElementById('profileModal').style.display = 'none';
            showToast({ type: 'success', title: 'Updated!', message: 'Profile updated successfully' });
            setTimeout(() => location.reload(), 1000);
        }

        function logout() {
            stopPolling();
            try {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('crMode');
            } catch (e) {
                console.warn('localStorage remove failed:', e);
            }
            document.getElementById('profileModal').style.display = 'none';

            // Hide app container and show login page
            var appContainer = document.getElementById('app');
            if (appContainer) {
                appContainer.style.display = 'none';
            }
            document.getElementById('authPage').style.display = 'flex';

            showToast({ type: 'info', title: 'Logged out', message: 'You have been logged out' });
        }
    </script>

    <!-- Clear Database Confirmation Modal -->
    <div id="clearDbModal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
        <div
            style="background: white; border-radius: 24px; max-width: 420px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.35); overflow: hidden; animation: slideUp 0.3s ease;">
            <div style="background: linear-gradient(135deg, #EF4444, #F87171); padding: 28px 32px; text-align: center;">
                <div
                    style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                    <i class="fas fa-exclamation-triangle" style="color: white; font-size: 1.8rem;"></i>
                </div>
                <h3 style="margin-bottom: 8px; color: white; font-size: 1.4rem;">Clear Database?</h3>
                <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 0;">This action cannot be undone</p>
            </div>
            <div style="padding: 28px 32px;">
                <div
                    style="background: #FEF2F2; border: 1px solid #FEE2E2; border-radius: 16px; padding: 16px; margin-bottom: 24px;">
                    <div class="flex" style="gap: 12px; align-items: flex-start;">
                        <i class="fas fa-info-circle" style="color: #EF4444; margin-top: 2px;"></i>
                        <span style="color: #991B1B; font-size: 0.9rem; line-height: 1.5;">This will permanently delete
                            all notices, notes, routines, CT schedules, members, and settings.</span>
                    </div>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button onclick="cancelClearDatabase()"
                        style="flex: 1; padding: 14px; background: white; border: 2px solid #E2E8F0; border-radius: 14px; cursor: pointer; font-weight: 600; color: #64748B; font-size: 0.95rem; transition: all 0.2s;">Cancel</button>
                    <button onclick="confirmClearDatabase()"
                        style="flex: 1; padding: 14px; background: linear-gradient(135deg, #EF4444, #F87171); border: none; border-radius: 14px; cursor: pointer; font-weight: 600; color: white; font-size: 0.95rem; transition: all 0.2s; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);">Delete
                        Everything</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>