<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>YE-48 — Class Management</title>
    <!-- Fonts & Icons -->
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900&f[]=inter@400,500,600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        /* ... (keep all your existing styles) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        html {
            overflow-x: hidden;
        }

        body {
            background-color: #F8FAFC;
            background-image:
                linear-gradient(rgba(148, 163, 184, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(148, 163, 184, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            color: #1E293B;
            min-height: 100vh;
            overflow-x: hidden;
        }

        #app {
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* custom scroll - hidden */
        ::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
        }

        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        h1,
        h2,
        h3,
        h4,
        .satoshi {
            font-family: 'Satoshi', sans-serif;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: #0F172A;
        }

        /* clean glass card - light version */
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 28px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.03), 0 2px 8px rgba(0, 0, 0, 0.02);
            transition: all 0.2s ease;
        }

        .glass:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.08), 0 8px 20px rgba(0, 0, 0, 0.02);
            border-color: rgba(99, 102, 241, 0.2);
        }

        /* clean gradient - softer */
        .gradient-bg {
            background: linear-gradient(135deg, #6366F1, #8B5CF6, #EC4899);
            background-size: 200% 200%;
            animation: shimmer 6s ease infinite;
            border: none;
            color: white;
            font-weight: 500;
            transition: all 0.2s;
        }

        .gradient-bg:hover {
            filter: brightness(1.05);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
        }

        /* soft gradient for cards */
        .soft-gradient {
            background: linear-gradient(145deg, #FFFFFF, #F1F5F9);
        }

        @keyframes shimmer {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* subject colors - modern gradient & animated */
        .subject-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 18px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .subject-pill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }

        .subject-pill:hover::before {
            left: 100%;
        }

        .subject-pill:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .subject-physics {
            color: white;
            background: linear-gradient(135deg, #0891B2 0%, #06B6D4 50%, #22D3EE 100%);
            background-size: 200% 200%;
            border: none;
            box-shadow: 0 4px 15px rgba(8, 145, 178, 0.4);
            animation: gradient-shift 3s ease infinite;
        }

        .subject-math {
            color: white;
            background: linear-gradient(135deg, #7C3AED 0%, #8B5CF6 50%, #A78BFA 100%);
            background-size: 200% 200%;
            border: none;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
            animation: gradient-shift 3.5s ease infinite;
        }

        .subject-cse {
            color: white;
            background: linear-gradient(135deg, #059669 0%, #10B981 50%, #34D399 100%);
            background-size: 200% 200%;
            border: none;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
            animation: gradient-shift 4s ease infinite;
        }

        .subject-chemistry {
            color: white;
            background: linear-gradient(135deg, #DC2626 0%, #EF4444 50%, #F87171 100%);
            background-size: 200% 200%;
            border: none;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
            animation: gradient-shift 3.2s ease infinite;
        }

        /* inner gradient shift animation */
        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* floating animation for schedule items */
        @keyframes card-float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .schedule-item {
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .schedule-item:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .subject-english {
            color: #D97706;
            background: #FEF3C7;
            border-left: 4px solid #D97706;
        }

        /* priority badges - cleaner */
        .badge-priority-high {
            background: #FEF2F2;
            color: #DC2626;
            border: 1px solid #FECACA;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-priority-medium {
            background: #FFFBEB;
            color: #D97706;
            border: 1px solid #FDE68A;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-priority-low {
            background: #F0FDF4;
            color: #059669;
            border: 1px solid #BBF7D0;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* layout */
        #app {
            display: flex;
            min-height: 100vh;
        }

        /* sidebar - light & clean */
        .sidebar {
            width: 280px;
            transition: width 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(24px);
            border-right: 1px solid rgba(203, 213, 225, 0.4);
            padding: 28px 20px;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar.collapsed .logo span,
        .sidebar.collapsed .nav-label,
        .sidebar.collapsed .cr-badge {
            display: none;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            margin-bottom: 40px;
            padding-left: 8px;
        }

        .logo i {
            font-size: 2rem;
            background: linear-gradient(135deg, #6366F1, #EC4899);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .logo span {
            color: #0F172A;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 18px;
            border-radius: 20px;
            color: #475569;
            transition: all 0.2s;
            margin: 4px 0;
            cursor: pointer;
            font-weight: 500;
        }

        .nav-item i {
            font-size: 1.3rem;
            width: 24px;
            color: #64748B;
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            color: #4F46E5;
            position: relative;
            overflow: hidden;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #6366F1, #8B5CF6);
            border-radius: 0 4px 4px 0;
        }

        .nav-item.active i {
            color: #4F46E5;
            transform: scale(1.1);
            transition: transform 0.3s ease;
        }

        .nav-item:hover:not(.active) {
            background: rgba(241, 245, 249, 0.8);
            color: #334155;
            transform: translateX(4px);
        }

        .nav-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .cr-section {
            margin-top: auto;
            border-top: 1px solid #E2E8F0;
            padding-top: 20px;
        }

        /* topbar - clean */
        .topbar {
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid #E2E8F0;
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .search-bar {
            background: white;
            border-radius: 60px;
            padding: 10px 24px;
            width: 360px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid #E2E8F0;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.02);
        }

        .search-bar:focus-within {
            border-color: #6366F1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: #1E293B;
            width: 100%;
            outline: none;
            font-size: 0.95rem;
        }

        .search-bar input::placeholder {
            color: #94A3B8;
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 44px;
            background: linear-gradient(145deg, #6366F1, #8B5CF6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            position: relative;
            font-size: 1rem;
        }

        .cr-badge {
            position: absolute;
            bottom: -2px;
            right: -2px;
            background: white;
            color: #8B5CF6;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 40px;
            font-weight: 700;
            border: 2px solid #8B5CF6;
        }

        .logo-mobile {
            display: none;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #F3F4F6, #E5E7EB);
            border-radius: 14px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .notification-bell:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #6366F1, #8B5CF6);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .notification-bell:hover i {
            color: white !important;
        }

        .notification-bell i {
            font-size: 1.3rem;
            color: #4B5563;
            transition: all 0.3s ease;
        }

        .notification-bell:active {
            transform: scale(0.95);
        }

        .notification-bell.clicked {
            animation: bell-ring 0.5s ease;
        }

        @keyframes bell-ring {
            0% {
                transform: rotate(0);
            }

            20% {
                transform: rotate(-15deg);
            }

            40% {
                transform: rotate(15deg);
            }

            60% {
                transform: rotate(-10deg);
            }

            80% {
                transform: rotate(10deg);
            }

            100% {
                transform: rotate(0);
            }
        }

        .red-dot {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, #EF4444, #F97316);
            border-radius: 50%;
            border: 2.5px solid white;
            animation: dot-pulse 1.5s ease-in-out infinite;
            box-shadow: 0 3px 10px rgba(239, 68, 68, 0.6);
            z-index: 10;
        }

        @keyframes dot-pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.4);
                opacity: 0.85;
            }
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #EF4444, #F97316);
            color: white;
            border-radius: 10px;
            border: 2px solid white;
            font-size: 0.7rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
            animation: badge-bounce 2s ease-in-out infinite;
            z-index: 10;
            padding: 0 5px;
        }

        @keyframes badge-bounce {

            0%,
            100% {
                transform: scale(1) translateY(0);
            }

            50% {
                transform: scale(1.15) translateY(-3px);
            }
        }

        /* main content */
        .main-content {
            flex: 1;
            padding: 32px 40px;
            max-width: 1440px;
            margin: 0 0 0 280px;
            width: calc(100% - 280px);
            overflow-y: auto;
        }

        /* grid & cards */
        .grid-dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 28px;
            margin-top: 32px;
        }

        .pulse-card {
            background: white;
            border-radius: 32px;
            padding: 24px;
            border: 1px solid #F1F5F9;
            transition: all 0.25s;
            cursor: pointer;
            animation: fadeUp 0.4s ease forwards;
            opacity: 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
        }

        .pulse-card h3 {
            font-size: 1.2rem;
            margin-bottom: 16px;
            color: #1E293B;
        }

        @keyframes fadeUp {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .live-pulse {
            position: relative;
            color: #059669;
            font-weight: 600;
            font-size: 0.85rem;
            background: #D1FAE5;
            padding: 4px 12px;
            border-radius: 40px;
        }

        .live-pulse::after {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #059669;
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        /* hero - clean */
        .hero-wave {
            background: linear-gradient(145deg, #EEF2FF, #F5F3FF);
            border-radius: 48px;
            padding: 48px 40px;
            margin-bottom: 40px;
            border: 1px solid #E0E7FF;
            position: relative;
            overflow: hidden;
        }

        /* mobile bottom nav */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            backdrop-filter: blur(24px);
            border-top: 1px solid rgba(226, 232, 240, 0.8);
            padding: 16px 24px;
            justify-content: space-around;
            z-index: 100;
            box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.08);
        }

        .bottom-nav i {
            font-size: 1.5rem;
            color: #94A3B8;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            padding: 10px;
            border-radius: 16px;
        }

        .bottom-nav i:hover {
            transform: translateY(-3px);
        }

        .bottom-nav i.active {
            color: #6366F1;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .bottom-nav i.active::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: linear-gradient(135deg, #6366F1, #8B5CF6);
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(99, 102, 241, 0.6);
        }

        /* FAB for CR - clean */
        .fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 56px;
            height: 56px;
            border-radius: 56px;
            background: linear-gradient(145deg, #6366F1, #8B5CF6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
            cursor: pointer;
            transition: all 0.2s;
            z-index: 90;
            border: none;
        }

        .fab:hover {
            transform: scale(1.05) rotate(90deg);
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.4);
        }

        /* mobile */
        @media (max-width: 900px) {
            .sidebar {
                display: none;
            }

            .bottom-nav {
                display: flex;
            }

            .main-content {
                padding: 20px;
                margin-bottom: 80px;
            }

            .grid-dashboard {
                grid-template-columns: 1fr;
            }

            .search-bar {
                width: 200px;
            }

            .topbar {
                padding: 0 16px;
            }
        }

        /* notes masonry */
        .notes-masonry {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .subject-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 700;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }

        .subject-pill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }

        .subject-pill:hover::before {
            left: 100%;
        }

        .subject-pill:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        /* routine table - clean */
        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 16px;
            margin: 24px 0;
        }

        .day-col {
            background: white;
            border-radius: 28px;
            padding: 20px 12px;
            min-height: 400px;
            border: 1px solid #F1F5F9;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.02);
        }

        .today-col {
            border: 2px solid #6366F1;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
        }

        /* modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(6px);
            z-index: 200;
            display: none;
            place-items: center;
        }

        .modal-content {
            max-width: 500px;
            width: 90%;
            padding: 32px;
            background: white;
            border-radius: 40px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.08);
            border: 1px solid #F1F5F9;
        }

        /* Modern Delete Confirmation Popup */
        .delete-confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 300;
            display: none;
            place-items: center;
            animation: fadeIn 0.2s ease;
        }

        .delete-confirm-overlay.show {
            display: grid;
        }

        .delete-confirm-overlay.hiding {
            animation: fadeOut 0.2s ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        @keyframes pulse-alert {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }

        @keyframes pulse-join {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
            }
        }

        .delete-confirm-modal {
            background: white;
            border-radius: 28px;
            padding: 48px;
            max-width: 420px;
            width: 90%;
            text-align: center;
            box-shadow:
                0 25px 50px -12px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(0, 0, 0, 0.05);
            animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .delete-confirm-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #DC2626, #EF4444, #DC2626);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .delete-confirm-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 28px;
            background: linear-gradient(135deg, #FEE2E2, #FECACA);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 30px rgba(220, 38, 38, 0.25);
            position: relative;
        }

        .delete-confirm-icon::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px dashed #DC2626;
            opacity: 0.3;
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .delete-confirm-icon i {
            font-size: 42px;
            color: #DC2626;
            position: relative;
            z-index: 1;
        }

        .delete-confirm-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: #0F172A;
            margin-bottom: 12px;
            font-family: 'Satoshi', sans-serif;
            letter-spacing: -0.02em;
        }

        .delete-confirm-message {
            color: #64748B;
            font-size: 1.05rem;
            line-height: 1.7;
            margin-bottom: 36px;
        }

        .delete-confirm-buttons {
            display: flex;
            gap: 16px;
        }

        .delete-confirm-buttons button {
            flex: 1;
            padding: 16px 28px;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            position: relative;
            overflow: hidden;
        }

        .delete-confirm-cancel {
            background: linear-gradient(135deg, #F8FAFC, #F1F5F9);
            color: #475569;
            border: 2px solid #E2E8F0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .delete-confirm-cancel:hover {
            background: linear-gradient(135deg, #F1F5F9, #E2E8F0);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }

        .delete-confirm-delete {
            background: linear-gradient(135deg, #DC2626 0%, #EF4444 50%, #DC2626 100%);
            background-size: 200% 100%;
            color: white;
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.4);
        }

        .delete-confirm-delete:hover {
            background-position: 100% 0;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(220, 38, 38, 0.5);
        }

        .delete-confirm-delete:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
        }

        /* Modern Toast Notifications */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 400;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            border-radius: 16px;
            background: white;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            max-width: 400px;
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: auto;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.hide {
            transform: translateX(120%);
            opacity: 0;
        }

        .toast-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-icon i {
            font-size: 20px;
            color: white;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 700;
            font-size: 0.95rem;
            color: #0F172A;
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 0.85rem;
            color: #64748B;
        }

        .toast-close {
            background: none;
            border: none;
            color: #94A3B8;
            cursor: pointer;
            padding: 4px;
            font-size: 14px;
            transition: color 0.2s;
            pointer-events: auto;
        }

        .toast-close:hover {
            color: #475569;
        }

        /* Toast types */
        .toast-success .toast-icon {
            background: linear-gradient(135deg, #10B981, #34D399);
        }

        .toast-error .toast-icon {
            background: linear-gradient(135deg, #EF4444, #F87171);
        }

        .toast-warning .toast-icon {
            background: linear-gradient(135deg, #F59E0B, #FBBF24);
        }

        .toast-info .toast-icon {
            background: linear-gradient(135deg, #3B82F6, #60A5FA);
        }

        /* utility */
        .text-secondary {
            color: #64748B;
        }

        .mt-4 {
            margin-top: 20px;
        }

        .mb-2 {
            margin-bottom: 10px;
        }

        .flex {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .font-bold {
            font-weight: 600;
        }

        .text-sm {
            font-size: 0.9rem;
        }

        /* ========== RESPONSIVE STYLES ========== */
        .dashboard-grid {
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr !important;
            }
        }

        .stats-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        @media (max-width: 900px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        @media (max-width: 500px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }

            .stats-grid>div {
                padding: 12px !important;
                border-radius: 16px !important;
            }

            .stats-grid>div>div:first-child {
                font-size: 1.5rem !important;
            }

            .stats-grid>div i {
                font-size: 1.2rem !important;
                margin-bottom: 4px !important;
                display: block !important;
            }

            .stats-grid>div>span:last-child,
            .stats-grid>div .stat-label {
                font-size: 0.65rem !important;
            }
        }

        /* Tablet and below */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px !important;
            }

            .sidebar .logo span,
            .sidebar nav .nav-item span,
            .sidebar .role-badge {
                display: none;
            }

            .sidebar .logo {
                justify-content: center;
            }

            .main-content {
                margin-left: 80px !important;
            }
        }

        /* Fix overflow for medium screens (760px - 1020px) */
        @media (min-width: 761px) and (max-width: 1020px) {

            html,
            body {
                overflow-x: hidden !important;
                max-width: 100vw !important;
            }

            #app {
                max-width: 100% !important;
                overflow-x: hidden !important;
            }

            .main-content {
                overflow-x: hidden !important;
                max-width: 100% !important;
                padding: 16px !important;
            }

            .notice-card,
            .notice-card-vertical,
            [class*="card"] {
                max-width: 100% !important;
                overflow: hidden !important;
                box-sizing: border-box !important;
            }

            .notice-card-vertical {
                min-height: auto !important;
            }
        }

        /* Large mobile and below (max-width: 768px) */
        @media (max-width: 768px) {
            .sidebar {
                width: 100% !important;
                height: auto !important;
                position: fixed !important;
                bottom: 0 !important;
                top: auto !important;
                left: 0 !important;
                flex-direction: row !important;
                justify-content: space-around;
                padding: 10px !important;
                z-index: 1000;
                border-radius: 20px 20px 0 0;
            }

            .sidebar .logo,
            .sidebar .role-badge,
            .sidebar .theme-toggle {
                display: none !important;
            }

            .logo-mobile {
                display: flex !important;
            }

            .sidebar nav {
                flex-direction: row !important;
                gap: 0 !important;
            }

            .sidebar .nav-item {
                padding: 12px !important;
            }

            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                padding: 16px !important;
            }

            .hero-wave,
            [class*="hero"] {
                padding: 24px !important;
            }

            h1,
            .satoshi {
                font-size: 1.5rem !important;
            }

            .grid-dashboard {
                grid-template-columns: 1fr !important;
            }
        }

        /* Small mobile (max-width: 480px) */
        @media (max-width: 480px) {
            .main-content {
                padding: 12px !important;
            }

            .pulse-card,
            [class*="card"] {
                padding: 16px !important;
                border-radius: 16px !important;
            }

            .schedule-item {
                padding: 12px !important;
                border-radius: 12px !important;
            }

            .stats-grid,
            .grid-dashboard,
            [class*="grid"] {
                grid-template-columns: 1fr !important;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .flex {
                flex-direction: column;
                align-items: flex-start;
            }

            .flex[style*="justify-content: space-between"] {
                flex-direction: row !important;
                align-items: center !important;
            }

            .flex[style*="gap:"][style*="align-items: center"] {
                flex-direction: row !important;
            }

            /* Keep filter options in one line on mobile */
            .filter-container {
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 8px;
            }

            .filter-container::-webkit-scrollbar {
                height: 4px;
            }

            .filter-container::-webkit-scrollbar-thumb {
                background: #6366F1;
                border-radius: 4px;
            }

            .filter-container span {
                flex-shrink: 0 !important;
                white-space: nowrap;
                transition: none !important;
            }

            .filter-container span:hover {
                transform: none !important;
                box-shadow: none !important;
            }

            /* Notice card - priority and NEW in one line, mark as read right aligned */
            .notice-card-vertical .badge-row-mobile {
                flex-wrap: nowrap !important;
                display: flex !important;
            }

            .notice-card-vertical .mark-read-mobile {
                margin-left: auto !important;
                display: block !important;
            }

            .mobile-title {
                display: none !important;
            }

            @media (max-width: 480px) {
                .desktop-title {
                    display: none !important;
                }

                .mobile-title {
                    display: inline !important;
                }
            }

            .flex.flex-row {
                flex-direction: row !important;
                align-items: center !important;
            }

            .badge-priority-high,
            [class*="badge"] {
                font-size: 0.7rem !important;
                padding: 4px 8px !important;
            }

            /* Notice cards - smaller on mobile */
            .notice-card {
                padding: 16px !important;
                border-radius: 20px !important;
            }

            .notice-card h3 {
                font-size: 1.1rem !important;
            }

            .notice-card p {
                font-size: 0.85rem !important;
            }

            .modal-content {
                padding: 20px !important;
                border-radius: 20px !important;
            }

            input,
            select,
            textarea {
                font-size: 14px !important;
            }

            button {
                padding: 10px 16px !important;
                font-size: 0.9rem !important;
            }
        }

        /* Extra responsive improvements */
        @media (max-width: 600px) {
            .topbar {
                padding: 8px 12px !important;
                gap: 8px !important;
            }

            .notification-bell {
                width: 38px !important;
                height: 38px !important;
            }

            .notification-bell i {
                font-size: 1rem !important;
            }

            .notification-badge {
                min-width: 18px !important;
                height: 18px !important;
                font-size: 0.6rem !important;
            }

            #authButtonContainer button {
                padding: 6px 12px !important;
                font-size: 0.85rem !important;
            }

            #authButtonContainer>div {
                margin-right: 8px !important;
            }
        }

        @media (max-width: 400px) {
            .logo-mobile span {
                font-size: 1rem !important;
            }

            .notification-bell {
                width: 34px !important;
                height: 34px !important;
                border-radius: 10px !important;
            }
        }

        /* Modal responsive styles */
        @media (max-width: 500px) {

            #profileModal>div {
                padding: 24px !important;
                border-radius: 20px !important;
                width: 95% !important;
                max-width: 95% !important;
            }

            #profileModal h2 {
                font-size: 1.3rem !important;
            }

            #profileModal input {
                padding: 12px 14px !important;
                font-size: 0.9rem !important;
            }

            #profileModal button {
                padding: 12px !important;
                font-size: 0.9rem !important;
            }
        }

        /* Dashboard greeting responsive */
        @media (max-width: 600px) {
            [class*="hero"] {
                padding: 24px !important;
                border-radius: 20px !important;
            }

            [class*="hero"] h1,
            [class*="hero"] .satoshi {
                font-size: 1.5rem !important;
            }

            [class*="hero"] p {
                font-size: 0.95rem !important;
            }
        }

        /* Keep header elements horizontal */
        @media (max-width: 500px) {
            #authButtonContainer {
                flex-direction: row !important;
                align-items: center !important;
                gap: 8px !important;
            }

            #authButtonContainer>* {
                margin-right: 0 !important;
                flex-shrink: 0;
            }
        }

        /* Modern Notice Card Styles */
        .notice-card-modern {
            position: relative;
        }

        .notice-card-modern:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12) !important;
        }

        /* Mobile styles (< 480px) */
        @media (max-width: 480px) {
            .notice-card-modern {
                border-radius: 20px !important;
            }

            .notice-card-modern>div:first-child {
                padding: 12px 16px !important;
                flex-wrap: wrap;
                gap: 8px;
                border-radius: 20px 20px 0 0 !important;
            }

            .notice-card-modern>div:first-child span:first-child {
                font-size: 0.7rem !important;
                padding: 3px 10px !important;
            }

            .notice-card-modern>div:last-child {
                padding: 16px !important;
            }

            .notice-card-modern h3 {
                font-size: 1.1rem !important;
            }

            .notice-card-modern p {
                font-size: 0.9rem !important;
                margin-bottom: 16px !important;
            }

            .notice-card-modern a {
                padding: 10px 20px !important;
                font-size: 0.85rem !important;
            }

            .notice-card-footer {
                flex-direction: column !important;
                gap: 12px;
                align-items: flex-start !important;
            }

            .notice-card-footer .mark-read {
                width: 100%;
                text-align: center;
                background: #EEF2FF;
                padding: 10px;
                border-radius: 12px;
            }
        }

        /* Desktop styles (> 480px) */
        @media (min-width: 481px) {
            .notice-card-modern {
                max-width: 100%;
            }

            .notice-card-modern>div:first-child {
                padding: 16px 24px !important;
            }

            .notice-card-modern>div:last-child {
                padding: 24px !important;
            }

            .notice-card-footer {
                flex-direction: row !important;
            }
        }

        /* Notice cards responsive */
        @media (max-width: 600px) {
            [style*="border-radius: 28px"] {
                padding: 16px !important;
                border-radius: 20px !important;
            }

            [style*="border-radius: 28px"] h3 {
                font-size: 1.1rem !important;
            }
        }

        /* Remove hover animation from filter pills */
        .filter-container span {
            transition: none !important;
        }

        .filter-container span:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* Notice card link button - center on larger screens */
        @media screen and (min-width: 481px) {
            div.notice-link-container {
                text-align: center !important;
                width: 100%;
            }

            div.notice-link-container a {
                margin: 0 auto;
                display: inline-block !important;
            }

            /* Vertical layout for notice cards on larger screens */
            .notice-card-vertical {
                display: flex !important;
                flex-direction: column !important;
                justify-content: space-between !important;
                min-height: 200px;
            }

            .notice-card-vertical .notice-link-container {
                margin-top: auto;
                margin-bottom: auto;
            }
        }

        /* Hide main content until authenticated */
        #mainContent {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Loading Indicator -->
    <div id="loadingIndicator"
        style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column;">
        <div
            style="width: 50px; height: 50px; border: 3px solid #f3f3f3; border-top: 3px solid #6366F1; border-radius: 50%; animation: spin 1s linear infinite;">
        </div>
        <p style="margin-top: 20px; color: #64748B;">Loading your dashboard...</p>
        <p id="offlineMessage" style="margin-top: 10px; color: #EF4444; font-size: 0.9rem; display: none;">
            <i class="fas fa-exclamation-triangle"></i> Using offline mode
        </p>
    </div>

    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <div id="app">
        <!-- SIDEBAR (desktop) - Clean version -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <i class="fas fa-scroll"></i>
                <span class="satoshi">YE-48</span>
            </div>
            <nav>
                <div class="nav-item active" data-page="dashboard"><i class="fas fa-home"></i> <span
                        class="nav-label">Dashboard</span></div>
                <div class="nav-item" data-page="notices"><i class="fas fa-bell"></i> <span
                        class="nav-label">Notices</span></div>
                <div class="nav-item" data-page="notes"><i class="fas fa-folder"></i> <span
                        class="nav-label">Notes</span></div>
                <div class="nav-item" data-page="routine"><i class="fas fa-clipboard-list"></i> <span
                        class="nav-label">Class Test</span></div>
                <div class="nav-item" data-page="members"><i class="fas fa-user-cog"></i> <span
                        class="nav-label">Account</span></div>
            </nav>
            <div class="cr-section">
                <div class="nav-item" data-page="cr-mode"><i class="fas fa-user-cog"></i> <span class="nav-label">CR
                        mode</span></div>
            </div>
        </aside>

        <!-- RIGHT PANEL -->
        <div style="flex:1; display: flex; flex-direction: column; width: 100%;">
            <!-- TOP BAR - Clean -->
            <header class="topbar">
                <div class="flex" style="align-items: center; gap: 16px;">
                    <div class="logo-mobile" style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-scroll" style="font-size: 1.5rem; color: #6366F1;"></i>
                        <span class="satoshi" style="font-size: 1.2rem; font-weight: 700; color: #0F172A;">YE-48</span>
                    </div>
                    <i class="fas fa-bars" style="font-size: 1.5rem; display: none; color: #475569;"
                        id="menuToggle"></i>
                </div>
                <div class="flex" id="authButtonContainer">
                    <!-- Will be populated by JavaScript -->
                </div>
            </header>

            <!-- MAIN DYNAMIC CONTENT -->
            <main class="main-content" id="mainContent">
                <!-- Initially empty - will be populated after login -->
            </main>
        </div>

        <!-- Mobile bottom nav - Clean -->
        <div class="bottom-nav">
            <i class="fas fa-home active" data-page="dashboard"></i>
            <i class="fas fa-calendar-alt" data-page="routine"></i>
            <i class="fas fa-bell" data-page="notices"></i>
            <i class="fas fa-folder" data-page="notes"></i>
            <i class="fas fa-user" data-page="members"></i>
        </div>

        <!-- modal overlay -->
        <div class="modal-overlay" id="modalOverlay">
            <div class="modal-content" id="modalInner">
                <!-- dynamic form -->
            </div>
        </div>

        <!-- Modern Delete Confirmation Popup -->
        <div class="delete-confirm-overlay" id="deleteConfirmOverlay">
            <div class="delete-confirm-modal">
                <div class="delete-confirm-icon">
                    <i class="fas fa-trash-alt"></i>
                </div>
                <h3 class="delete-confirm-title">Delete Forever?</h3>
                <p class="delete-confirm-message" id="deleteConfirmMessage">This action cannot be undone. Once you
                    delete this item, it's gone forever.</p>
                <div class="delete-confirm-buttons">
                    <button class="delete-confirm-cancel" onclick="closeDeleteConfirm()">Keep It</button>
                    <button class="delete-confirm-delete" id="deleteConfirmBtn"><i class="fas fa-trash-alt"></i>
                        Delete</button>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
    </div>

    <script>
        // ==================== GLOBAL ERROR HANDLER ====================
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            console.error('Global Error: ', msg, '\nLine: ' + lineNo, '\nColumn: ' + columnNo);
            return false;
        };

        // Debug logging
        console.log('App starting...');

        // ==================== SUPABASE CLIENT ====================
        const SUPABASE_URL = 'https://igfpnaboighqrivtniji.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnZnBuYWJvaWdocXJpdnRuaWppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NDE1NDcsImV4cCI6MjA4NzExNzU0N30.x214dTL53lmJ15tsKkcKLIdjfbuvJVPkNH_QG4NxhEY';

        function isSupabaseConfigured() {
            return SUPABASE_URL.includes('supabase.co') && SUPABASE_ANON_KEY.startsWith('eyJ');
        }

        const supabaseClient = {
            url: SUPABASE_URL,
            key: SUPABASE_ANON_KEY,

            async request(endpoint, options = {}) {
                const url = `${this.url}/rest/v1/${endpoint}`;
                const headers = {
                    'apikey': this.key,
                    'Authorization': `Bearer ${this.key}`,
                    'Content-Type': 'application/json',
                    'Prefer': options.prefer || 'return=representation'
                };

                // Create an AbortController for timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout

                try {
                    const response = await fetch(url, {
                        method: options.method || 'GET',
                        headers: { ...headers, ...options.headers },
                        body: options.body ? JSON.stringify(options.body) : null,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (options.method === 'DELETE') {
                        if (response.status === 204) return true;
                    }

                    // Check if response is OK before parsing JSON
                    if (!response.ok) {
                        if (response.status === 0) {
                            throw new Error('Network error - possibly offline');
                        }
                        const text = await response.text();
                        throw new Error(text || 'Request failed');
                    }

                    const data = await response.json();
                    return data;
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        console.error('Request timeout:', endpoint);
                        throw new Error('Request timeout');
                    }
                    console.error('Supabase request error:', error);
                    throw error;
                }
            },

            async getSubjects() { return this.request('subjects?order=created_at'); },
            async addSubject(subject) { return this.request('subjects', { method: 'POST', body: subject }); },
            async updateSubject(id, updates) { return this.request(`subjects?id=eq.${id}`, { method: 'PATCH', body: updates }); },
            async deleteSubject(id) { return this.request(`subjects?id=eq.${id}`, { method: 'DELETE' }); },

            async getNotes() { return this.request('notes?order=created_at.desc'); },
            async addNote(note) { return this.request('notes', { method: 'POST', body: note }); },
            async updateNote(id, updates) { return this.request(`notes?id=eq.${id}`, { method: 'PATCH', body: updates }); },
            async deleteNote(id) { return this.request(`notes?id=eq.${id}`, { method: 'DELETE' }); },

            async getNotices() { return this.request('notices?order=created_at.desc'); },
            async addNotice(notice) { return this.request('notices', { method: 'POST', body: notice }); },
            async updateNotice(id, updates) { return this.request(`notices?id=eq.${id}`, { method: 'PATCH', body: updates }); },
            async deleteNotice(id) { return this.request(`notices?id=eq.${id}`, { method: 'DELETE' }); },

            // User authentication methods
            async getUserByStudentId(studentId) { return this.request(`users?student_id=eq.${studentId}&select=*`); },
            async createUser(userData) { return this.request('users', { method: 'POST', body: userData }); },
            async updateUser(id, updates) { return this.request(`users?id=eq.${id}`, { method: 'PATCH', body: updates }); },
            async getNoticeReadStatus(noticeId, userId) {
                if (noticeId) {
                    return this.request(`notice_read_status?notice_id=eq.${noticeId}&user_id=eq.${userId}&select=*`);
                } else {
                    return this.request(`notice_read_status?user_id=eq.${userId}&select=*`);
                }
            },
            async markNoticeRead(noticeId, userId) { return this.request('notice_read_status', { method: 'POST', body: { notice_id: noticeId, user_id: userId } }); },

            async getClassTests() { return this.request('class_tests?order=date'); },
            async addClassTest(test) { return this.request('class_tests', { method: 'POST', body: test }); },
            async updateClassTest(id, updates) { return this.request(`class_tests?id=eq.${id}`, { method: 'PATCH', body: updates }); },
            async deleteClassTest(id) { return this.request(`class_tests?id=eq.${id}`, { method: 'DELETE' }); },

            async getTodaysRoutine() { return this.request('todays_routine?order=slot_number'); },
            async deleteTodaysRoutine(id) { return this.request(`todays_routine?id=eq.${id}`, { method: 'DELETE' }); },

            async getWebsiteSettings() { const settings = await this.request('website_settings?limit=1'); return settings[0] || null; },
            async updateWebsiteSettings(id, updates) { return this.request(`website_settings?id=eq.${id}`, { method: 'PATCH', body: updates }); },

            async getMembers() { return this.request('members?order=created_at'); },
            async addMember(member) { return this.request('members', { method: 'POST', body: member }); },
            async deleteMember(id) { return this.request(`members?id=eq.${id}`, { method: 'DELETE' }); },

            // Clear all data from Supabase
            async clearAllData() {
                const tables = ['notice_read_status', 'subjects', 'notes', 'notices', 'class_tests', 'todays_routine', 'members', 'website_settings', 'users'];
                for (const table of tables) {
                    try {
                        const data = await this.request(`${table}?select=id`);
                        if (data && Array.isArray(data)) {
                            for (const item of data) {
                                try {
                                    await this.request(`${table}?id=eq.${item.id}`, { method: 'DELETE' });
                                } catch (e) {
                                    console.error(`Error deleting ${table} item ${item.id}:`, e);
                                }
                            }
                        }
                    } catch (error) {
                        console.error(`Error clearing ${table}:`, error);
                    }
                }
            }
        };

        window.supabaseClient = supabaseClient;
        window.isSupabaseConfigured = isSupabaseConfigured;
    </script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({ duration: 600, once: true, easing: 'ease-out' });

        // ---------- Modern Delete Confirmation ----------
        let deleteConfirmCallback = null;

        function showDeleteConfirm(message, onConfirm) {
            const overlay = document.getElementById('deleteConfirmOverlay');
            const messageEl = document.getElementById('deleteConfirmMessage');
            const deleteBtn = document.getElementById('deleteConfirmBtn');

            messageEl.textContent = message || 'Are you sure you want to delete this item? This action cannot be undone.';
            deleteConfirmCallback = onConfirm;

            deleteBtn.onclick = null;
            deleteBtn.onclick = () => {
                if (deleteConfirmCallback) {
                    deleteConfirmCallback();
                }
                closeDeleteConfirm();
            };

            overlay.classList.add('show');
        }

        function closeDeleteConfirm() {
            const overlay = document.getElementById('deleteConfirmOverlay');
            overlay.classList.remove('show');
            overlay.classList.add('hiding');
            setTimeout(() => {
                overlay.classList.remove('hiding');
            }, 200);
            deleteConfirmCallback = null;
        }

        document.getElementById('deleteConfirmOverlay').addEventListener('click', function (e) {
            if (e.target === this) {
                closeDeleteConfirm();
            }
        });

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeDeleteConfirm();
            }
        });

        // ---------- Toast Notifications ----------
        function showToast(options) {
            const { type = 'success', title, message, duration = 4000 } = options;
            const container = document.getElementById('toastContainer');

            const icons = {
                success: 'fa-check',
                error: 'fa-times',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${icons[type]}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 400);
            }, duration);
        }

        // ---------- High Alert Notification System ----------
        let notificationPermission = Notification.permission;

        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                notificationPermission = await Notification.requestPermission();
            }
        }

        // ---------- STATE ----------
        const savedCRMode = localStorage.getItem('crMode') === 'true';
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;

        if (savedCRMode && currentUser) {
            currentUser.role = 'cr';
        }

        let userReadNotices = new Set();
        let currentTerm = 'Level 3 Term 2';
        let archivedTerms = [];
        let previousTermSubjects = [];
        let unreadNotices = true;

        let notices = [];
        let notes = [];
        let subjects = [];
        let todaysRoutine = [];
        let classTests = [];
        let websiteSettings = { logoIcon: 'fa-scroll', websiteName: 'YE-48' };
        let members = [];

        function loadTermData() {
            const savedTerm = localStorage.getItem('currentTerm');
            const savedArchived = localStorage.getItem('archivedTerms');
            const savedPrevSubjects = localStorage.getItem('previousTermSubjects');

            if (savedTerm) currentTerm = savedTerm;
            if (savedArchived) archivedTerms = JSON.parse(savedArchived);
            if (savedPrevSubjects) previousTermSubjects = JSON.parse(savedPrevSubjects);
        }

        function saveTermData() {
            localStorage.setItem('currentTerm', currentTerm);
            localStorage.setItem('archivedTerms', JSON.stringify(archivedTerms));
            localStorage.setItem('previousTermSubjects', JSON.stringify(previousTermSubjects));
        }

        // ---------- DATA MANAGEMENT WITH SUPABASE ----------
        const USE_SUPABASE = typeof supabaseClient !== 'undefined' && isSupabaseConfigured && isSupabaseConfigured();

        console.log('Supabase config check:', {
            clientExists: typeof supabaseClient !== 'undefined',
            isConfigured: typeof isSupabaseConfigured !== 'undefined' ? isSupabaseConfigured() : false,
            USE_SUPABASE
        });

        // Load user-specific notice read status from Supabase
        async function loadUserReadNotices() {
            if (!currentUser || !currentUser.id || !USE_SUPABASE) return;
            try {
                const readStatus = await supabaseClient.getNoticeReadStatus(null, currentUser.id);
                userReadNotices.clear();
                if (readStatus && Array.isArray(readStatus)) {
                    readStatus.forEach(status => {
                        userReadNotices.add(status.notice_id);
                    });
                }
                console.log('Loaded read status for user:', userReadNotices.size, 'notices read');
            } catch (e) {
                console.log('Could not load read status:', e);
            }
        }

        function isNoticeReadByUser(noticeId) {
            return userReadNotices.has(noticeId);
        }

        async function markNoticeAsRead(noticeId) {
            if (!currentUser || !currentUser.id) return;
            if (userReadNotices.has(noticeId)) return;
            userReadNotices.add(noticeId);
            if (USE_SUPABASE) {
                try {
                    await supabaseClient.markNoticeRead(noticeId, currentUser.id);
                } catch (e) {
                    if (!e.message.includes('duplicate key')) {
                        console.log('Could not mark as read in Supabase:', e);
                    }
                }
            }
        }

        // Initialize data from Supabase or localStorage (Offline-first approach)
        async function initializeData() {
            // First, load from localStorage immediately (for instant display)
            loadFromLocalStorage();

            // Update loading indicator
            const loadingIndicator = document.getElementById('loadingIndicator');

            // Check if we're offline
            if (!navigator.onLine) {
                if (loadingIndicator) {
                    const offlineMsg = document.getElementById('offlineMessage');
                    if (offlineMsg) offlineMsg.style.display = 'block';
                }
                return;
            }

            if (USE_SUPABASE) {
                // Set a timeout promise that rejects after 3 seconds
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Supabase timeout')), 3000)
                );

                try {
                    // Race between Supabase and timeout
                    const [noticesData, notesData, subjectsData, routineData, testsData, settingsData, membersData] =
                        await Promise.race([
                            Promise.all([
                                supabaseClient.getNotices().catch(e => { console.log('Notices fetch failed'); return null; }),
                                supabaseClient.getNotes().catch(e => { console.log('Notes fetch failed'); return null; }),
                                supabaseClient.getSubjects().catch(e => { console.log('Subjects fetch failed'); return null; }),
                                supabaseClient.getTodaysRoutine().catch(e => { console.log('Routine fetch failed'); return null; }),
                                supabaseClient.getClassTests().catch(e => { console.log('Tests fetch failed'); return null; }),
                                supabaseClient.getWebsiteSettings().catch(e => { console.log('Settings fetch failed'); return null; }),
                                supabaseClient.getMembers().catch(e => { console.log('Members fetch failed'); return null; })
                            ]),
                            timeoutPromise
                        ]);

                    // Only update if we got data (not null)
                    if (noticesData) {
                        notices = noticesData.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                        localStorage.setItem('notices', JSON.stringify(notices));
                    }

                    if (notesData) {
                        notes = notesData;
                        localStorage.setItem('notes', JSON.stringify(notes));
                    }

                    if (subjectsData) {
                        subjects = subjectsData.map(s => {
                            let str = s.name || '';
                            if (s.teacher) str += ' (' + s.teacher + ')';
                            return str;
                        });
                        localStorage.setItem('subjects', JSON.stringify(subjects));
                    }

                    if (routineData) {
                        todaysRoutine = routineData;
                        localStorage.setItem('todaysRoutine', JSON.stringify(todaysRoutine));
                    }

                    if (testsData) {
                        classTests = testsData.map(t => ({
                            id: t.id,
                            subject: t.subject,
                            date: t.date,
                            time: t.time,
                            venue: t.venue,
                            chapters: t.chapter || t.chapters || '',
                            notes: t.notes
                        }));
                        localStorage.setItem('classTests', JSON.stringify(classTests));
                    }

                    if (settingsData) {
                        websiteSettings = settingsData;
                        localStorage.setItem('websiteSettings', JSON.stringify(websiteSettings));
                    }

                    if (membersData) {
                        members = membersData;
                        localStorage.setItem('members', JSON.stringify(members));
                    }

                    console.log('Data loaded from Supabase');

                } catch (error) {
                    console.log('Supabase timeout or error - using cached data');
                }
            }

            // Always ensure we have data (even if empty arrays)
            notices = notices || [];
            notes = notes || [];
            subjects = subjects || [];
            todaysRoutine = todaysRoutine || [];
            classTests = classTests || [];
            websiteSettings = websiteSettings || { logoIcon: 'fa-scroll', websiteName: 'YE-48' };
            members = members || [];

            // Hide loading indicator
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
        }

        function loadFromLocalStorage() {
            try {
                notices = JSON.parse(localStorage.getItem('notices')) || [];
                notes = JSON.parse(localStorage.getItem('notes')) || [];
                subjects = JSON.parse(localStorage.getItem('subjects')) || [];
                todaysRoutine = JSON.parse(localStorage.getItem('todaysRoutine')) || [];
                classTests = JSON.parse(localStorage.getItem('classTests')) || [];
                websiteSettings = JSON.parse(localStorage.getItem('websiteSettings')) || { logoIcon: 'fa-scroll', websiteName: 'YE-48' };
                members = JSON.parse(localStorage.getItem('members')) || ['Aarav Sharma', 'Vivaan Gupta', 'Aditya Kumar', 'Ananya Singh', 'Diya Patel', 'Ishaan Roy', 'Sai Krishna', 'John Mathew', 'Meera Nair', 'Rohan Joshi', 'Priya Shah', 'Karthik Iyer'];
                loadTermData();
                console.log('Data loaded from localStorage');
            } catch (e) {
                console.error('Error loading from localStorage:', e);
                // Set defaults
                notices = [];
                notes = [];
                subjects = [];
                todaysRoutine = [];
                classTests = [];
                websiteSettings = { logoIcon: 'fa-scroll', websiteName: 'YE-48' };
                members = ['Aarav Sharma', 'Vivaan Gupta', 'Aditya Kumar', 'Ananya Singh', 'Diya Patel', 'Ishaan Roy', 'Sai Krishna', 'John Mathew', 'Meera Nair', 'Rohan Joshi', 'Priya Shah', 'Karthik Iyer'];
            }
        }

        // Polling for real-time updates
        let lastDataHash = {
            notices: '',
            notes: '',
            todaysRoutine: '',
            classTests: ''
        };

        function getDataHash(data) {
            return JSON.stringify(data);
        }

        async function pollForUpdates() {
            if (!USE_SUPABASE || !navigator.onLine || !currentUser) return;

            try {
                const [noticesData, notesData, routineData, testsData] = await Promise.all([
                    supabaseClient.getNotices(),
                    supabaseClient.getNotes(),
                    supabaseClient.getTodaysRoutine(),
                    supabaseClient.getClassTests()
                ]);

                const newNotices = (noticesData || []).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                const newNotes = notesData || [];
                const newRoutine = routineData || [];
                const newTests = testsData || [];

                let dataChanged = false;

                if (getDataHash(newNotices) !== lastDataHash.notices) {
                    notices = newNotices;
                    lastDataHash.notices = getDataHash(newNotices);
                    localStorage.setItem('notices', JSON.stringify(notices));
                    dataChanged = true;
                }

                if (getDataHash(newNotes) !== lastDataHash.notes) {
                    notes = newNotes;
                    lastDataHash.notes = getDataHash(newNotes);
                    localStorage.setItem('notes', JSON.stringify(notes));
                    dataChanged = true;
                }

                if (getDataHash(newRoutine) !== lastDataHash.todaysRoutine) {
                    todaysRoutine = newRoutine;
                    lastDataHash.todaysRoutine = getDataHash(newRoutine);
                    localStorage.setItem('todaysRoutine', JSON.stringify(todaysRoutine));
                    dataChanged = true;
                }

                if (getDataHash(newTests) !== lastDataHash.classTests) {
                    classTests = newTests;
                    lastDataHash.classTests = getDataHash(newTests);
                    localStorage.setItem('classTests', JSON.stringify(classTests));
                    dataChanged = true;
                }

                if (currentUser && currentUser.id) {
                    await loadUserReadNotices();
                }

                updateUnreadBadge();

                if (dataChanged && currentPage === 'dashboard') {
                    renderDashboard();
                } else if (dataChanged && currentPage === 'notices') {
                    renderNotices();
                } else if (dataChanged && currentPage === 'notes') {
                    renderNotes();
                } else if (dataChanged && currentPage === 'routine') {
                    renderRoutine();
                }
            } catch (error) {
                console.error('Error polling for updates:', error);
            }
        }

        let pollInterval;
        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(pollForUpdates, 10000);
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        function updateUnreadBadge() {
            if (!currentUser) return;
            const unreadCount = notices.filter(n => !isNoticeReadByUser(n.id)).length;
            const badge = document.getElementById('unreadBadge');
            if (badge) {
                if (unreadCount > 0) {
                    badge.style.display = 'flex';
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Save functions
        async function saveNotices() {
            localStorage.setItem('notices', JSON.stringify(notices));
            if (USE_SUPABASE) {
                try {
                    const existing = await supabaseClient.getNotices();
                    if (existing && existing.length > 0) {
                        for (const n of existing) { await supabaseClient.deleteNotice(n.id); }
                    }
                    for (const n of notices) {
                        await supabaseClient.addNotice({
                            title: n.title, description: n.description, priority: n.priority,
                            link: n.link || '', pinned: n.pinned || false, read: n.read || false, expiry: n.expiry || '',
                            created_at: n.created_at || new Date().toISOString()
                        });
                    }
                    console.log('Notices saved to Supabase');
                } catch (e) {
                    console.error('Error saving notices:', e);
                }
            }
        }

        async function saveNotes() {
            localStorage.setItem('notes', JSON.stringify(notes));
            if (USE_SUPABASE) {
                try {
                    const existing = await supabaseClient.getNotes();
                    if (existing && existing.length > 0) {
                        for (const n of existing) { await supabaseClient.deleteNote(n.id); }
                    }
                    for (const n of notes) {
                        await supabaseClient.addNote({
                            subject: n.subject, title: n.title, description: n.desc || n.description || '',
                            link: n.link || '', type: n.type || 'telegram', date: n.date || ''
                        });
                    }
                    console.log('Notes saved to Supabase');
                } catch (e) { console.error('Error saving notes:', e); }
            }
        }

        async function saveSubjects() {
            localStorage.setItem('subjects', JSON.stringify(subjects));
            if (USE_SUPABASE) {
                try {
                    const existing = await supabaseClient.getSubjects();
                    if (existing && existing.length > 0) {
                        for (const s of existing) { await supabaseClient.deleteSubject(s.id); }
                    }
                    for (const s of subjects) {
                        let name = s, code = '', teacher = '';
                        const codeMatch = s.match(/^([A-Za-z0-9]+)\s*-\s*(.+)$/);
                        if (codeMatch) {
                            code = codeMatch[1];
                            name = codeMatch[2];
                        }
                        const teacherMatch = name.match(/^(.+)\s*\(([^)]+)\)$/);
                        if (teacherMatch) {
                            name = teacherMatch[1];
                            teacher = teacherMatch[2];
                        }
                        if (name) {
                            await supabaseClient.addSubject({ name: name, teacher: teacher || '', color: '' });
                        }
                    }
                    console.log('Subjects saved to Supabase');
                } catch (e) { console.error('Error saving subjects:', e); }
            }
        }

        async function saveTodaysRoutine() {
            localStorage.setItem('todaysRoutine', JSON.stringify(todaysRoutine));
            if (USE_SUPABASE) {
                try {
                    const existing = await supabaseClient.getTodaysRoutine();
                    if (existing && existing.length > 0) {
                        for (const r of existing) { await supabaseClient.deleteTodaysRoutine(r.id); }
                    }
                    for (let i = 0; i < todaysRoutine.length; i++) {
                        const r = todaysRoutine[i];
                        await supabaseClient.request('todays_routine', {
                            method: 'POST',
                            body: { slot_number: i + 1, subject: r.subject, time: r.time || '', venue: r.venue || '', online: r.online || false, meeting_link: r.meetingLink || '' }
                        });
                    }
                    console.log('Routine saved to Supabase');
                } catch (e) { console.error('Error saving routine:', e); }
            }
        }

        async function saveClassTests() {
            localStorage.setItem('classTests', JSON.stringify(classTests));
            if (USE_SUPABASE) {
                try {
                    const existing = await supabaseClient.getClassTests();
                    const existingMap = new Map(existing.map(t => [t.id, t]));
                    const existingKeys = new Set(existing.map(t => `${t.subject}|${t.date}|${t.time || ''}`));
                    const localKeys = new Set(classTests.map(t => `${t.subject}|${t.date}|${t.time || ''}`));

                    for (const t of existing) {
                        const key = `${t.subject}|${t.date}|${t.time || ''}`;
                        if (!localKeys.has(key)) {
                            await supabaseClient.deleteClassTest(t.id);
                        }
                    }

                    for (const t of classTests) {
                        const key = `${t.subject}|${t.date}|${t.time || ''}`;
                        if (t.id && existingMap.has(t.id)) {
                            const remote = existingMap.get(t.id);
                            if (remote && (t.subject !== remote.subject || t.date !== remote.date || t.time !== remote.time || t.venue !== remote.venue || (t.chapters || t.chapter) !== remote.chapter || t.notes !== remote.notes)) {
                                await supabaseClient.updateClassTest(t.id, {
                                    subject: t.subject, date: t.date, time: t.time || '', venue: t.venue || '', chapter: t.chapters || t.chapter || '', notes: t.notes || ''
                                });
                            }
                        } else if (!existingKeys.has(key)) {
                            const result = await supabaseClient.addClassTest({
                                subject: t.subject, date: t.date, time: t.time || '', venue: t.venue || '', chapter: t.chapters || t.chapter || '', notes: t.notes || ''
                            });
                            if (result && result[0] && result[0].id) {
                                t.id = result[0].id;
                            }
                        }
                    }
                    console.log('Class tests saved to Supabase');
                    localStorage.setItem('classTests', JSON.stringify(classTests));
                } catch (e) { console.error('Error saving class tests:', e); }
            }
        }

        async function saveWebsiteSettings() {
            localStorage.setItem('websiteSettings', JSON.stringify(websiteSettings));
            if (USE_SUPABASE) {
                try {
                    const settings = await supabaseClient.getWebsiteSettings();
                    if (settings && settings.id) {
                        await supabaseClient.updateWebsiteSettings(settings.id, websiteSettings);
                    }
                    console.log('Settings saved to Supabase');
                } catch (e) { console.error('Error saving settings:', e); }
            }
        }

        // Visitor tracking
        const today = new Date().toLocaleDateString();
        let visitorData = JSON.parse(localStorage.getItem('visitorData')) || { date: '', count: 0 };
        if (visitorData.date !== today) {
            visitorData = { date: today, count: 1 };
        } else {
            visitorData.count++;
        }
        localStorage.setItem('visitorData', JSON.stringify(visitorData));
        const visitorsToday = visitorData.count;

        // Filter state
        let currentNoteFilter = 'all';
        let currentNoteSearch = '';
        let currentNoticeFilter = 'all';
        let currentPage = 'dashboard';

        function setNoteFilter(subject) {
            currentNoteFilter = subject;
            renderNotes();
        }

        function setNoticeFilter(type) {
            currentNoticeFilter = type;
            renderNotices();
        }

        function searchNotes(query) {
            currentNoteSearch = query.toLowerCase();
            renderNotes();
        }

        function loadTodaysRoutine() {
            if (USE_SUPABASE) {
                // Already loaded
            } else {
                todaysRoutine = JSON.parse(localStorage.getItem('todaysRoutine')) || [];
            }
        }

        const cardColors = [
            { start: '#0891B2', end: '#06B6D4' },
            { start: '#7C3AED', end: '#8B5CF6' },
            { start: '#059669', end: '#10B981' },
            { start: '#DC2626', end: '#EF4444' },
            { start: '#D97706', end: '#F59E0B' },
            { start: '#4F46E5', end: '#6366F1' },
            { start: '#DB2777', end: '#F472B6' },
            { start: '#2563EB', end: '#3B82F6' },
        ];

        function getCardColor(index) {
            return cardColors[index % cardColors.length];
        }

        function getCourseTitle(fullSubject) {
            if (!fullSubject) return '';
            let title = fullSubject.replace(/^[A-Za-z0-9\s]+ - /, '');
            title = title.replace(/ \([^)]+\)$/, '');
            return title;
        }

        function deleteTest(index) {
            showDeleteConfirm(
                'Are you sure you want to delete this class test?',
                () => {
                    const testSchedule = JSON.parse(localStorage.getItem('classTests')) || [];
                    testSchedule.splice(index, 1);
                    localStorage.setItem('classTests', JSON.stringify(testSchedule));
                    classTests = testSchedule;
                    saveClassTests();
                    setTimeout(() => {
                        reRenderCurrentPage();
                    }, 250);
                    showToast({
                        type: 'success',
                        title: 'Deleted!',
                        message: 'Class test has been removed successfully.'
                    });
                }
            );
        }

        function editTest(index) {
            const testSchedule = JSON.parse(localStorage.getItem('classTests')) || [];
            const test = testSchedule[index];
            openModal('ct');
            setTimeout(() => {
                document.getElementById('ctSubjectModal').value = test.subject;
                document.getElementById('ctDateModal').value = test.date;
                document.getElementById('ctTimeModal').value = test.time;
                document.getElementById('ctVenueModal').value = test.venue;
                document.getElementById('ctSyllabusModal').value = test.chapters;
                const btn = document.querySelector('#ctForm button[type=\"submit\"]');
                if (btn) btn.innerHTML = '<i class="fas fa-save"></i> Update CT';
                window.editingTestIndex = index;
            }, 100);
        }

        function deleteNote(index) {
            showDeleteConfirm(
                'Are you sure you want to delete this note?',
                () => {
                    const noteToDelete = notes[index];
                    notes.splice(index, 1);
                    localStorage.setItem('notes', JSON.stringify(notes));
                    if (USE_SUPABASE && noteToDelete && noteToDelete.id && String(noteToDelete.id).includes('-')) {
                        supabaseClient.deleteNote(noteToDelete.id).catch(e => console.error('Error deleting from Supabase:', e));
                    }
                    setTimeout(() => {
                        reRenderCurrentPage();
                    }, 250);
                    showToast({
                        type: 'success',
                        title: 'Deleted!',
                        message: 'Note has been removed successfully.'
                    });
                }
            );
        }

        function deleteNoticeItem(noticeId) {
            showDeleteConfirm(
                'Are you sure you want to delete this notice?',
                () => {
                    const idStr = String(noticeId);
                    notices = notices.filter(n => String(n.id) !== idStr);
                    localStorage.setItem('notices', JSON.stringify(notices));
                    if (USE_SUPABASE && noticeId.toString().includes('-')) {
                        supabaseClient.deleteNotice(noticeId).catch(e => console.error('Error deleting from Supabase:', e));
                    }
                    setTimeout(() => {
                        reRenderCurrentPage();
                    }, 250);
                    showToast({
                        type: 'success',
                        title: 'Deleted!',
                        message: 'Notice has been removed successfully.'
                    });
                }
            );
        }

        async function clearAllDatabase() {
            document.getElementById('clearDbModal').style.display = 'flex';
        }

        function confirmClearDatabase() {
            document.getElementById('clearDbModal').style.display = 'none';
            showToast({
                type: 'info',
                title: 'Clearing...',
                message: 'Deleting all data'
            });

            (async () => {
                try {
                    if (USE_SUPABASE) {
                        await supabaseClient.clearAllData();
                    }
                    localStorage.clear();
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                    showToast({
                        type: 'success',
                        title: 'Cleared!',
                        message: 'All data has been deleted'
                    });
                } catch (error) {
                    console.error('Error clearing database:', error);
                    localStorage.clear();
                    location.reload();
                }
            })();
        }

        function cancelClearDatabase() {
            document.getElementById('clearDbModal').style.display = 'none';
        }

        function copyNoticeLink(noticeId, noticeTitle) {
            const notice = notices.find(n => n.id === noticeId);
            if (notice && notice.link) {
                const baseUrl = window.location.href.split('?')[0];
                const shareUrl = `${baseUrl}?link=${encodeURIComponent(notice.link)}&title=${encodeURIComponent(noticeTitle)}`;

                navigator.clipboard.writeText(shareUrl).then(() => {
                    showToast({
                        type: 'success',
                        title: 'Link Copied!',
                        message: 'Share this link with others.'
                    });
                }).catch(() => {
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast({
                        type: 'success',
                        title: 'Link Copied!',
                        message: 'Share this link with others.'
                    });
                });
            }
        }

        function editNote(index) {
            const note = notes[index];
            openModal('note');
            setTimeout(() => {
                document.getElementById('noteSubjectModal').value = note.subject;
                document.getElementById('noteTitleModal').value = note.title;
                document.getElementById('noteDescModal').value = note.desc;
                const btn = document.querySelector('#noteForm button[type=\"submit\"]');
                if (btn) btn.innerHTML = '<i class="fas fa-save"></i> Update Note';
                window.editingNoteIndex = index;
            }, 100);
        }

        function editSubject(index) {
            const subject = subjects[index];
            if (!subject) return;

            let name = subject, code = '', teacher = '';
            const codeMatch = subject.match(/^([A-Za-z0-9]+)\s*-\s*(.+)$/);
            if (codeMatch) {
                code = codeMatch[1];
                name = codeMatch[2];
            }
            const teacherMatch = name.match(/^(.+)\s*\(([^)]+)\)$/);
            if (teacherMatch) {
                name = teacherMatch[1];
                teacher = teacherMatch[2];
            }

            window.editingSubjectIndex = index;
            openModal('subject');
            setTimeout(() => {
                document.getElementById('newSubjectCodeModal').value = code;
                document.getElementById('newSubjectNameModal').value = name;
                document.getElementById('newSubjectTeacherModal').value = teacher;
                const btn = document.querySelector('#subjectModal button[type=\"submit\"]');
                if (btn) btn.textContent = 'Update Subject';
            }, 100);
        }

        function deleteSubject(index) {
            showDeleteConfirm(
                'Are you sure you want to delete this subject?',
                () => {
                    subjects.splice(index, 1);
                    saveSubjects();
                    localStorage.setItem('subjects', JSON.stringify(subjects));
                    renderMembers();
                    showToast({ type: 'success', title: 'Deleted!', message: 'Subject has been removed.' });
                }
            );
        }

        // ---------- RENDER FUNCTIONS ----------
        function renderDashboard() {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            const now = new Date();
            const hour = now.getHours();
            const greeting = hour < 12 ? 'Morning' : hour < 18 ? 'Afternoon' : 'Evening';
            const userName = currentUser && currentUser.name ? currentUser.name : '';
            const unreadNoticesCount = notices ? notices.filter(n => !isNoticeReadByUser(n.id)).length : 0;
            const isCR = currentUser.role === 'cr';

            const html = `
            <!-- Hero Section -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 30px; padding: 40px; margin-bottom: 40px; position: relative; overflow: hidden; box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);">
                <div style="position: absolute; top: -50%; right: -10%; width: 300px; height: 300px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                <div style="position: absolute; bottom: -30%; left: -5%; width: 200px; height: 200px; background: rgba(255,255,255,0.08); border-radius: 50%;"></div>
                <div style="position: relative; z-index: 1;">
                    <h1 class="satoshi" style="font-size: 2.5rem; color: white; margin-bottom: 10px; animation: fadeInUp 0.8s ease;">Good ${greeting}, ${userName}! <i class="fas fa-sun" style="color: #FFD700;"></i></h1>
                    <p style="font-size: 1.2rem; color: rgba(255,255,255,0.9); margin-bottom: 0;">Here's what's happening in our class today.</p>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px;" class="stats-grid">
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 24px; border-radius: 24px; color: white; box-shadow: 0 10px 30px rgba(245, 87, 108, 0.3); animation: fadeInUp 0.5s ease forwards; animation-delay: 0.1s; opacity: 0; text-align: center;">
                    <i class="fas fa-book-open" style="font-size: 2.5rem; margin-bottom: 10px; display: block;"></i>
                    <div style="font-size: 3rem; font-weight: 700;">${notes.length}</div>
                    <div style="font-size: 1rem; opacity: 0.9;">Study Notes</div>
                </div>
                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 24px; border-radius: 24px; color: white; box-shadow: 0 10px 30px rgba(0, 242, 254, 0.3); animation: fadeInUp 0.5s ease forwards; animation-delay: 0.2s; opacity: 0; text-align: center;">
                    <i class="fas fa-bell" style="font-size: 2.5rem; margin-bottom: 10px; display: block;"></i>
                    <div style="font-size: 3rem; font-weight: 700;">${unreadNoticesCount}</div>
                    <div style="font-size: 1rem; opacity: 0.9;">Unread Notices</div>
                </div>
                <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 24px; border-radius: 24px; color: white; box-shadow: 0 10px 30px rgba(56, 249, 215, 0.3); animation: fadeInUp 0.5s ease forwards; animation-delay: 0.3s; opacity: 0; text-align: center;">
                    <i class="fas fa-calendar-alt" style="font-size: 2.5rem; margin-bottom: 10px; display: block;"></i>
                    <div style="font-size: 3rem; font-weight: 700;">${todaysRoutine.length}</div>
                    <div style="font-size: 1rem; opacity: 0.9;">Today's Classes</div>
                </div>
                <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 24px; border-radius: 24px; color: white; box-shadow: 0 10px 30px rgba(250, 112, 154, 0.3); animation: fadeInUp 0.5s ease forwards; animation-delay: 0.4s; opacity: 0; text-align: center;">
                    <i class="fas fa-users" style="font-size: 2.5rem; margin-bottom: 10px; display: block;"></i>
                    <div style="font-size: 3rem; font-weight: 700;">${visitorsToday}</div>
                    <div style="font-size: 1rem; opacity: 0.9;">Visitors Today</div>
                </div>
            </div>
            
            <!-- Main Content Grid -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;" class="dashboard-grid">
                
                <!-- Left Column -->
                <div style="display: flex; flex-direction: column; gap: 30px;">
                    
                    <!-- Today's Schedule -->
                    <div style="background: white; border-radius: 30px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); animation: fadeInUp 0.6s ease forwards; animation-delay: 0.2s; opacity: 0;">
                        <div class="flex" style="justify-content: space-between; margin-bottom: 24px;">
                            <h3 style="font-size: 1.4rem; color: #1E293B; margin: 0;"><span style="background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;"><i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>Today's Schedule</span></h3>
                            <span style="background: #EEF2FF; color: #6366F1; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">${todaysRoutine.length} classes</span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            ${todaysRoutine.length === 0 ? `
                            <div style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <i class="fas fa-calendar-plus" style="font-size: 3rem; color: #94A3B8; margin-bottom: 12px;"></i>
                                <span style="color: #94A3B8; font-size: 1.1rem;">No routine posted yet</span>
                            </div>
                            ` : todaysRoutine.slice(0, 4).map((cls, i) => {
                const colors = [['#667eea', '#764ba2'], ['#f093fb', '#f5576c'], ['#4facfe', '#00f2fe'], ['#43e97b', '#38f9d7']];
                const c = colors[i % 4];

                const now = new Date();
                const [startTime] = (cls.time || '').split(' - ');
                let isJoinable = false;
                let meetingLink = '';

                if (cls.online && startTime) {
                    const [hours, minutes] = startTime.split(':').map(Number);
                    const classTime = new Date();
                    classTime.setHours(hours, minutes, 0, 0);
                    const diffMinutes = (classTime - now) / (1000 * 60);
                    isJoinable = diffMinutes <= 5 && diffMinutes >= -10;
                    meetingLink = cls.meetingLink || '';
                }

                return `
                            <div style="padding: 18px 22px; border-radius: 20px; background: linear-gradient(135deg, ${c[0]}, ${c[1]}); color: white; position: relative; overflow: hidden; animation: slideIn 0.5s ease forwards; animation-delay: ${0.3 + i * 0.1}s; opacity: 0; transform: translateX(-20px);">
                                <div style="position: absolute; top: -15px; right: -15px; width: 60px; height: 60px; background: rgba(255,255,255,0.15); border-radius: 50%;"></div>
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 14px; align-items: center;">
                                        <div style="background: rgba(255,255,255,0.25); padding: 12px; border-radius: 14px;"><i class="fas fa-book" style="font-size: 1.2rem;"></i></div>
                                        <div>
                                            <span style="font-weight: 700; font-size: 1.05rem; display: block;">${getCourseTitle(cls.subject) || 'Class ' + (i + 1)}</span>
                                            <span style="opacity: 0.85; font-size: 0.9rem;"><i class="far fa-clock" style="margin-right: 5px;"></i>${cls.time || 'Time not set'}</span>
                                        </div>
                                    </div>
                                    ${isJoinable && meetingLink ? `
                                    <a href="${meetingLink}" target="_blank" style="background: linear-gradient(135deg, #10B981, #34D399); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; text-decoration: none; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); animation: pulse-join 1.5s infinite;">
                                        <i class="fas fa-video" style="margin-right: 6px;"></i>Join Now
                                    </a>
                                    ` : `
                                    <span style="background: rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; white-space: nowrap; min-width: 120px; text-align: center; display: inline-flex; align-items: center; justify-content: center;">${cls.online ? '<i class="fas fa-laptop" style="margin-right:5px;"></i>Online' : (cls.venue ? '<i class="fas fa-building" style="margin-right:5px;"></i>' + cls.venue : '')}</span>
                                    `}
                                </div>
                            </div>
                            `;
            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Upcoming Class Tests -->
                    ${(() => {
                    const testSchedule = JSON.parse(localStorage.getItem('classTests')) || [];
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const upcomingTests = testSchedule
                        .map((test, idx) => ({
                            ...test,
                            originalIndex: idx,
                            testDate: new Date(test.date.split('/').reverse().join('-'))
                        }))
                        .filter(t => t.testDate >= today)
                        .sort((a, b) => a.testDate - b.testDate)
                        .slice(0, 3);

                    if (upcomingTests.length === 0) return '';

                    return `
                    <div style="background: white; border-radius: 30px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); animation: fadeInUp 0.6s ease forwards; animation-delay: 0.25s; opacity: 0;">
                        <div class="flex" style="justify-content: space-between; margin-bottom: 24px;">
                            <h3 style="font-size: 1.4rem; color: #1E293B; margin: 0;"><span style="background: linear-gradient(135deg, #EF4444, #F97316); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;"><i class="fas fa-file-alt" style="margin-right: 8px;"></i><span class="desktop-title">Upcoming Class Tests</span><span class="mobile-title" style="display:none;">Upcoming CT</span></span></h3>
                            <span style="background: #FEE2E2; color: #EF4444; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">${upcomingTests.length} upcoming</span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 14px;">
                            ${upcomingTests.map((test, i) => {
                        const daysUntil = Math.ceil((test.testDate - today) / (1000 * 60 * 60 * 24));
                        const isUrgent = daysUntil <= 3;
                        return `
                            <div style="padding: 18px 22px; border-radius: 20px; background: ${isUrgent ? 'linear-gradient(135deg, #FEE2E2, #FECACA)' : 'linear-gradient(135deg, #FEF3C7, #FDE68A)'}; border: 1px solid ${isUrgent ? '#FECACA' : '#FDE68A'}; position: relative; overflow: hidden;">
                                ${isUrgent ? `
                                <div style="position: absolute; top: 8px; right: 8px; width: 12px; height: 12px; background: #EF4444; border-radius: 50%; animation: pulse 1.5s infinite;"></div>
                                ` : ''}
                                <div class="flex" style="justify-content: space-between; align-items: center;">
                                    <div class="flex" style="gap: 14px; align-items: center;">
                                        <div style="background: ${isUrgent ? 'rgba(239, 68, 68, 0.2)' : 'rgba(217, 119, 6, 0.2)'}; padding: 12px; border-radius: 14px;"><i class="fas fa-file-alt" style="font-size: 1.2rem; color: ${isUrgent ? '#EF4444' : '#D97706'};"></i></div>
                                        <div>
                                            <span style="font-weight: 700; font-size: 1.05rem; display: block; color: #1E293B;">${getCourseTitle(test.subject)}</span>
                                            <span style="opacity: 0.7; font-size: 0.9rem; color: #64748B;"><i class="far fa-calendar-alt" style="margin-right: 5px;"></i>${test.date} at ${test.time.split(' - ')[0]}</span>
                                        </div>
                                    </div>
                                    <span style="background: ${isUrgent ? '#EF4444' : '#D97706'}; color: white; padding: 8px 16px; border-radius: 16px; font-size: 0.8rem; font-weight: 600; white-space: nowrap; min-width: 85px; text-align: center; display: inline-flex; align-items: center; justify-content: center;">${daysUntil === 0 ? 'Today' : daysUntil === 1 ? 'Tomorrow' : daysUntil + ' days'}</span>
                                </div>
                            </div>
                                `;
                    }).join('')}
                        </div>
                    </div>
                        `;
                })()}
                    
                    <!-- Notices -->
                    <div style="background: white; border-radius: 30px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); animation: fadeInUp 0.6s ease forwards; animation-delay: 0.3s; opacity: 0;">
                        <div class="flex" style="justify-content: space-between; margin-bottom: 24px;">
                            <h3 style="font-size: 1.4rem; color: #1E293B; margin: 0;"><span style="background: linear-gradient(135deg, #f093fb, #f5576c); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;"><i class="fas fa-bullhorn" style="margin-right: 8px;"></i>Recent Notices</span></h3>
                            ${unreadNoticesCount > 0 ? `<span style="background: linear-gradient(135deg, #f5576c, #fa709a); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">${unreadNoticesCount} new</span>` : ''}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 14px;">
                            ${notices.length === 0 ? `
                            <div style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <i class="fas fa-bullhorn" style="font-size: 3rem; color: #94A3B8; margin-bottom: 12px;"></i>
                                <span style="color: #94A3B8; font-size: 1.1rem;">No notices yet</span>
                            </div>
                            ` : notices.slice(0, 3).map(n => `
                            <div style="padding: 18px; border-radius: 20px; background: ${n.priority === 'high' ? 'linear-gradient(135deg, #FEF2F2, #FEE2E2)' : 'linear-gradient(135deg, #f8fafc, #f1f5f9)'}; border-left: 4px solid ${n.priority === 'high' ? '#EF4444' : '#6366F1'}; animation: fadeInUp 0.5s ease forwards;">
                                <div class="flex" style="justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 600; color: #1E293B; font-size: 1rem;">${n.title}</span>
                                    ${n.priority === 'high' ? `<span style="background: #EF4444; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">URGENT</span>` : ''}
                                </div>
                                <p style="color: #64748B; font-size: 0.9rem; margin: 0; line-height: 1.5;">${n.description || n.desc || ''}</p>
                            </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Right Column -->
                <div style="display: flex; flex-direction: column; gap: 30px;">
                    
                    <!-- Recent Notes -->
                    <div style="background: white; border-radius: 30px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); animation: fadeInUp 0.6s ease forwards; animation-delay: 0.4s; opacity: 0;">
                        <div class="flex" style="justify-content: space-between; margin-bottom: 24px;">
                            <h3 style="font-size: 1.4rem; color: #1E293B; margin: 0;"><span style="background: linear-gradient(135deg, #43e97b, #38f9d7); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;"><i class="fas fa-sticky-note" style="margin-right: 8px;"></i>Recent Notes</span></h3>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${notes.length === 0 ? `
                            <div style="text-align: center; padding: 30px 20px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <i class="fas fa-file-alt" style="font-size: 2.5rem; color: #94A3B8; margin-bottom: 8px;"></i>
                                <span style="color: #94A3B8; font-size: 1rem;">No notes yet</span>
                            </div>
                            ` : notes.slice(0, 5).map(n => `
                            <div class="flex" onclick="currentPage='notes'; renderNotes(); setTimeout(() => { const el = document.getElementById('note-${n.id}'); if(el) el.scrollIntoView({behavior: 'smooth', block: 'center'}); }, 100);" style="justify-content: space-between; align-items: center; padding: 14px 16px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 16px; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateX(5px)';this.style.boxShadow='0 4px 15px rgba(0,0,0,0.1)'">
                                <div class="flex" style="gap: 12px; align-items: center;">
                                    <span style="background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; padding: 8px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: 600;">${getCourseTitle(n.subject)}</span>
                                    <span style="color: #1E293B; font-weight: 500; font-size: 0.95rem;">${n.title}</span>
                                </div>
                                <i class="fas fa-chevron-right" style="color: #94A3B8; font-size: 0.8rem;"></i>
                            </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    ${isCR ? `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 30px; padding: 30px; color: white; box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4); animation: fadeInUp 0.6s ease forwards; animation-delay: 0.5s; opacity: 0;">
                        <h3 style="font-size: 1.3rem; margin-bottom: 20px;"><i class="fas fa-bolt" style="margin-right: 8px;"></i>Quick Actions</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <button onclick="openModal('ct')" style="background: rgba(255,255,255,0.2); border: none; padding: 14px 20px; border-radius: 16px; color: white; font-size: 1rem; font-weight: 500; cursor: pointer; text-align: left; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)';this.style.transform='scale(1.02)'">
                                <i class="fas fa-file-alt" style="margin-right: 10px;"></i> Add Class Test
                            </button>
                            <button onclick="openModal('note')" style="background: rgba(255,255,255,0.2); border: none; padding: 14px 20px; border-radius: 16px; color: white; font-size: 1rem; font-weight: 500; cursor: pointer; text-align: left; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)';this.style.transform='scale(1.02)'">
                                <i class="fas fa-book" style="margin-right: 10px;"></i> Add Study Note
                            </button>
                            <button onclick="openModal('routine')" style="background: rgba(255,255,255,0.2); border: none; padding: 14px 20px; border-radius: 16px; color: white; font-size: 1rem; font-weight: 500; cursor: pointer; text-align: left; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)';this.style.transform='scale(1.02)'">
                                <i class="fas fa-calendar" style="margin-right: 10px;"></i> Post Today's Routine
                            </button>
                            <button onclick="openModal('notice')" style="background: rgba(255,255,255,0.2); border: none; padding: 14px 20px; border-radius: 16px; color: white; font-size: 1rem; font-weight: 500; cursor: pointer; text-align: left; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)';this.style.transform='scale(1.02)'">
                                <i class="fas fa-bullhorn" style="margin-right: 10px;"></i> Post Notice
                            </button>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
            
            <style>
                @keyframes fadeInUp {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                @keyframes slideIn {
                    from { opacity: 0; transform: translateX(-20px); }
                    to { opacity: 1; transform: translateX(0); }
                }
            </style>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }

        function renderRoutine() {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            let testSchedule = JSON.parse(localStorage.getItem('classTests')) || [];

            testSchedule.sort((a, b) => {
                const dateA = new Date(a.date.split('/').reverse().join('-'));
                const dateB = new Date(b.date.split('/').reverse().join('-'));
                return dateA - dateB;
            });

            if (testSchedule.length === 0) {
                document.getElementById('mainContent').innerHTML = `
                <div style="margin-bottom: 32px;">
                    <div style="margin-bottom: 32px;">
                        <h1 class="satoshi" style="font-size: 2rem; margin-bottom: 8px;">Class Test Schedule</h1>
                        <p class="text-secondary">Upcoming class tests and exam schedule</p>
                    </div>
                    
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 24px; border: 1px solid #F1F5F9;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #FEE2E2, #FECACA); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                            <i class="fas fa-calendar-times" style="font-size: 2rem; color: #EF4444;"></i>
                        </div>
                        <h3 style="margin-bottom: 8px; color: #1E293B;">No Class Tests Scheduled</h3>
                        <p class="text-secondary" style="margin-bottom: 24px;">No upcoming class tests. CR can add new schedules.</p>
                    </div>
                </div>
                `;
                return;
            }

            document.getElementById('mainContent').innerHTML = `
            <div style="margin-bottom: 32px;">
                <div style="margin-bottom: 32px;">
                    <h1 class="satoshi" style="font-size: 2rem; margin-bottom: 8px;">Class Test Schedule</h1>
                    <p class="text-secondary">Upcoming class tests and exam schedule</p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px;">
                    ${testSchedule.map((test, index) => {
                const testDate = new Date(test.date.split('/').reverse().join('-'));
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const daysUntil = Math.ceil((testDate - today) / (1000 * 60 * 60 * 24));
                const isUpcoming = daysUntil >= 0 && daysUntil <= 3;
                return `
                        <div style="background: white; border-radius: 24px; overflow: hidden; border: ${isUpcoming ? '2px solid #EF4444' : '1px solid #F1F5F9'}; transition: all 0.3s; ${isUpcoming ? 'box-shadow: 0 8px 30px rgba(239, 68, 68, 0.25);' : ''}" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(0,0,0,0.1)'">
                            <div style="background: linear-gradient(135deg, ${getCardColor(index).start}, ${getCardColor(index).end}); padding: 28px; padding-top: 36px; color: white; position: relative;">
                                ${isUpcoming ? `
                                <div style="position: absolute; top: 8px; left: 8px; width: 32px; height: 32px; background: #EF4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: pulse-alert 1.5s ease-in-out infinite; box-shadow: 0 2px 10px rgba(239, 68, 68, 0.6); z-index: 10;">
                                    <i class="fas fa-bell" style="font-size: 14px; color: white;"></i>
                                </div>
                                ` : ''}
                                <div style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.25); padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; backdrop-filter: blur(4px);">
                                    TEST #${index + 1}
                                </div>
                                <span style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 30px; font-weight: 700; font-size: 1.1rem; backdrop-filter: blur(4px);">${getCourseTitle(test.subject)}</span>
                            </div>
                            
                            <div style="padding: 24px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div style="background: linear-gradient(135deg, #EEF2FF, #E0E7FF); padding: 16px; border-radius: 16px;">
                                        <i class="fas fa-calendar-alt" style="color: #4F46E5; font-size: 1.2rem; margin-bottom: 8px; display: block;"></i>
                                        <span style="color: #64748B; font-size: 0.75rem; display: block; margin-bottom: 4px;">DATE</span>
                                        <span style="font-weight: 700; color: #1E293B;">${test.date}</span>
                                    </div>
                                    <div style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); padding: 16px; border-radius: 16px;">
                                        <i class="fas fa-clock" style="color: #D97706; font-size: 1.2rem; margin-bottom: 8px; display: block;"></i>
                                        <span style="color: #64748B; font-size: 0.75rem; display: block; margin-bottom: 4px;">TIME</span>
                                        <span style="font-weight: 700; color: #1E293B;">${test.time.split(' - ')[0]}</span>
                                    </div>
                                    <div style="background: linear-gradient(135deg, #D1FAE5, #A7F3D0); padding: 16px; border-radius: 16px;">
                                        <i class="fas fa-map-marker-alt" style="color: #059669; font-size: 1.2rem; margin-bottom: 8px; display: block;"></i>
                                        <span style="color: #64748B; font-size: 0.75rem; display: block; margin-bottom: 4px;">VENUE</span>
                                        <span style="font-weight: 700; color: #1E293B;">${test.venue}</span>
                                    </div>
                                    <div style="background: linear-gradient(135deg, #EDE9FE, #DDD6FE); padding: 16px; border-radius: 16px;">
                                        <i class="fas fa-book" style="color: #7C3AED; font-size: 1.2rem; margin-bottom: 8px; display: block;"></i>
                                        <span style="color: #64748B; font-size: 0.75rem; display: block; margin-bottom: 4px;">SYLLABUS</span>
                                        <span style="font-weight: 700; color: #1E293B;">${test.chapters}</span>
                                    </div>
                                </div>
                                ${currentUser && currentUser.role === 'cr' ? `
                                <div style="padding-top: 20px; display: flex; gap: 12px;">
                                    <button onclick="editTest(${index})" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;"><i class="fas fa-edit"></i> Edit</button>
                                    <button onclick="deleteTest(${index})" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #DC2626, #EF4444); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;"><i class="fas fa-trash"></i> Delete</button>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `}).join('')}
                </div>
            </div>
        `;
        }

        function renderNotices() {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            const unreadCount = notices.filter(n => !isNoticeReadByUser(n.id)).length;
            const badge = document.getElementById('unreadBadge');
            if (badge) {
                if (unreadCount > 0) {
                    badge.style.display = 'flex';
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                } else {
                    badge.style.display = 'none';
                }
            }

            if (notices.length === 0) {
                document.getElementById('mainContent').innerHTML = `
                <div style="margin-bottom: 32px;">
                    <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h1 class="satoshi" style="font-size: 2rem;">Notices & Announcements</h1>
                    </div>
                    
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 24px; border: 1px solid #F1F5F9;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #E0E7FF, #C7D2FE); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                            <i class="fas fa-bullhorn" style="font-size: 2rem; color: #6366F1;"></i>
                        </div>
                        <h3 style="margin-bottom: 8px; color: #1E293B;">No Notices Posted</h3>
                        <p class="text-secondary" style="margin-bottom: 24px;">No notices yet. CR can post new announcements.</p>
                    </div>
                </div>
                `;
                return;
            }

            document.getElementById('mainContent').innerHTML = `
            <div style="margin-bottom: 32px;">
                <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h1 class="satoshi" style="font-size: 2rem;">Notices & Announcements</h1>
                </div>
                
                <div class="flex flex-row filter-container" style="gap: 16px; margin: 24px 0; flex-wrap: wrap; flex-direction: row;">
                    <span class="gradient-bg" onclick="setNoticeFilter('all')" style="padding: 8px 16px; border-radius: 40px; cursor: pointer; background: ${currentNoticeFilter === 'all' ? 'linear-gradient(135deg, #6366F1, #8B5CF6)' : 'linear-gradient(135deg, #E0E7FF, #C7D2FE)'}; color: ${currentNoticeFilter === 'all' ? 'white' : '#6366F1'}; font-size: 0.85rem;">All (${notices.length})</span>
                    <span onclick="setNoticeFilter('high')" style="padding: 8px 16px; border-radius: 40px; background: ${currentNoticeFilter === 'high' ? 'linear-gradient(135deg, #DC2626, #EF4444)' : 'white'}; border: 1px solid ${currentNoticeFilter === 'high' ? '#DC2626' : '#E2E8F0'}; color: ${currentNoticeFilter === 'high' ? 'white' : '#6B7280'}; cursor: pointer; font-size: 0.85rem;">Urgent (${notices.filter(n => n.priority === 'high').length})</span>
                    <span onclick="setNoticeFilter('unread')" style="padding: 8px 16px; border-radius: 40px; background: ${currentNoticeFilter === 'unread' ? 'linear-gradient(135deg, #059669, #10B981)' : 'white'}; border: 1px solid ${currentNoticeFilter === 'unread' ? '#059669' : '#E2E8F0'}; color: ${currentNoticeFilter === 'unread' ? 'white' : '#6B7280'}; cursor: pointer; font-size: 0.85rem;">Unread (${notices.filter(n => !isNoticeReadByUser(n.id)).length})</span>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    ${(currentNoticeFilter === 'all' ? notices : currentNoticeFilter === 'unread' ? notices.filter(n => !isNoticeReadByUser(n.id)) : notices.filter(n => n.priority === currentNoticeFilter)).sort((a, b) => b.id - a.id).map(n => `
                        <div class="notice-card-modern" style="background: white; border-radius: 24px; overflow: hidden; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); transition: all 0.3s ease; ${!isNoticeReadByUser(n.id) ? 'transform: translateY(-2px);' : ''}">
                            <div style="background: ${n.priority === 'high' ? 'linear-gradient(135deg, #EF4444, #F87171)' : n.priority === 'medium' ? 'linear-gradient(135deg, #F59E0B, #FBBF24)' : 'linear-gradient(135deg, #10B981, #34D399)'}; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center;">
                                <div class="flex" style="gap: 10px; align-items: center;">
                                    <span style="background: rgba(255,255,255,0.25); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; color: white; backdrop-filter: blur(4px);">
                                        <i class="fas fa-exclamation-triangle" style="margin-right: 6px;"></i>${n.priority} priority
                                    </span>
                                    ${!isNoticeReadByUser(n.id) ? '<span style="background: white; color: #EF4444; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;">NEW</span>' : ''}
                                </div>
                                ${currentUser && currentUser.role === 'cr' ? `
                                <span style="color: white; cursor: pointer; opacity: 0.9;" onclick="deleteNoticeItem('${n.id}')">
                                    <i class="fas fa-trash"></i>
                                </span>
                                ` : ''}
                            </div>
                            
                            <div style="padding: 24px;">
                                <h3 style="margin-bottom: 12px; font-size: 1.25rem; font-weight: 700; color: #1E293B; line-height: 1.4;">${n.title}</h3>
                                <p style="color: #64748B; margin-bottom: 20px; line-height: 1.6; font-size: 0.95rem;">${n.description || n.desc || ''}</p>
                                
                                ${n.link ? `
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <a href="${n.link}" target="_blank" style="display: inline-flex; align-items: center; gap: 10px; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; padding: 12px 28px; border-radius: 25px; text-decoration: none; font-weight: 600; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); transition: all 0.3s ease;">
                                        <i class="fas fa-external-link-alt"></i> Open Link
                                    </a>
                                </div>
                                ` : ''}
                                
                                <div class="notice-card-footer flex" style="justify-content: space-between; padding-top: 12px; border-top: 1px solid #F1F5F9;">
                                    <div class="flex" style="gap: 8px; align-items: center;">
                                        <i class="far fa-bell" style="color: #94A3B8; font-size: 0.85rem;"></i>
                                        <span style="color: #94A3B8; font-size: 0.8rem;">Posted by CR</span>
                                    </div>
                                    ${!isNoticeReadByUser(n.id) ? `
                                        <span style="color: #6366F1; cursor: pointer; font-size: 0.9rem; font-weight: 600;" class="mark-read" data-id="${n.id}">
                                            <i class="far fa-check-circle" style="margin-right: 6px;"></i>Mark as read
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

            document.querySelectorAll('.mark-read').forEach(el => {
                const handleMarkAsRead = function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const noticeId = this.getAttribute('data-id');
                    if (noticeId) {
                        markNoticeAsRead(noticeId);
                        renderNotices();
                    }
                };
                el.addEventListener('click', handleMarkAsRead);
                el.addEventListener('touchend', handleMarkAsRead);
            });
        }

        function renderNotes() {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            const subjectCounts = subjects.map(s => ({
                name: s,
                count: notes.filter(n => n.subject === s).length
            })).filter(s => s.count > 0);

            if (notes.length === 0) {
                document.getElementById('mainContent').innerHTML = `
                <div style="margin-bottom: 32px;">
                    <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h1 class="satoshi" style="font-size: 2rem;">Study Notes</h1>
                        </div>
                        ${currentUser && currentUser.role === 'cr' ? `
                            <button class="gradient-bg" style="padding: 12px 28px; border-radius: 40px; border: none; display: flex; align-items: center; gap: 8px;" id="addNoteBtn">
                                <i class="fas fa-plus"></i> Add note
                            </button>
                        ` : ''}
                    </div>
                    
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 24px; border: 1px solid #F1F5F9;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #EDE9FE, #DDD6FE); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                            <i class="fas fa-book-open" style="font-size: 2rem; color: #8B5CF6;"></i>
                        </div>
                        <h3 style="margin-bottom: 8px; color: #1E293B;">No Study Notes</h3>
                        <p class="text-secondary" style="margin-bottom: 24px;">No notes shared yet. CR can add new study materials.</p>
                    </div>
                </div>
                `;
                return;
            }

            document.getElementById('mainContent').innerHTML = `
            <div style="margin-bottom: 32px;">
                <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h1 class="satoshi" style="font-size: 2rem;">Study Notes</h1>
                    </div>
                    ${currentUser && currentUser.role === 'cr' ? `
                        <button class="gradient-bg" style="padding: 12px 28px; border-radius: 40px; border: none; display: flex; align-items: center; gap: 8px;" id="addNoteBtn">
                            <i class="fas fa-plus"></i> Add note
                        </button>
                    ` : ''}
                </div>
                
                ${archivedTerms.length > 0 ? `
                <div style="margin-bottom: 24px;">
                    <h4 style="margin-bottom: 12px; color: #64748B; font-size: 0.9rem;">Previous Terms</h4>
                    <div class="flex" style="gap: 12px; flex-wrap: wrap;">
                        ${archivedTerms.map(t => `
                            <span onclick="alert('Viewing archived notes from ${t}')" style="background: #F1F5F9; color: #64748B; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid #E2E8F0;">${t}</span>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <div class="flex flex-row filter-container" style="gap: 8px; flex-wrap: wrap; margin-bottom: 32px; flex-direction: row;">
                    <span class="subject-pill subject-all" onclick="setNoteFilter('all')" style="padding: 8px 16px; background: ${currentNoteFilter === 'all' ? 'linear-gradient(135deg, #6366F1, #8B5CF6)' : 'white'}; color: ${currentNoteFilter === 'all' ? 'white' : '#6366F1'}; border: 2px solid #6366F1; cursor: pointer; border-radius: 30px; font-size: 0.85rem;">All</span>
                    ${subjectCounts.map(s => `
                        <span class="subject-pill subject-${getCourseTitle(s.name).toLowerCase()}" onclick="setNoteFilter('${s.name}')" style="padding: 8px 16px; background: ${currentNoteFilter === s.name ? 'linear-gradient(135deg, #6366F1, #8B5CF6)' : 'white'}; color: ${currentNoteFilter === s.name ? 'white' : '#6366F1'}; border: 2px solid #6366F1; cursor: pointer; border-radius: 30px; font-size: 0.85rem;">${getCourseTitle(s.name)} <span style="opacity: 0.8; font-size: 0.8em;">(${s.count})</span></span>
                    `).join('')}
                </div>
                
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px;">
                ${((currentNoteFilter === 'all' ? notes : notes.filter(n => n.subject === currentNoteFilter)).filter(n => !currentNoteSearch || n.title.toLowerCase().includes(currentNoteSearch) || (n.description && n.description.toLowerCase().includes(currentNoteSearch)))).map((n, index) => `
                    <div id="note-${n.id}" style="background: white; border-radius: 24px; overflow: hidden; border: 1px solid #F1F5F9; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-8px)';this.style.boxShadow='0 20px 40px rgba(0,0,0,0.1)'">
                        <div style="background: linear-gradient(135deg, ${getCardColor(index).start}, ${getCardColor(index).end}); padding: 50px 28px 28px; color: white; position: relative;">
                            <div style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.25); padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; backdrop-filter: blur(4px);">
                                ${getCourseTitle(n.subject)}
                            </div>
                            <h4 style="margin-bottom: 8px; font-size: 1.3rem; font-weight: 700; color: white;">${n.title}</h4>
                        </div>
                        
                        <div style="padding: 24px;">
                            <p class="text-secondary" style="font-size:0.95rem; margin-bottom: 20px; line-height: 1.6;">${n.desc || n.description || ''}</p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div style="background: linear-gradient(135deg, #EEF2FF, #E0E7FF); padding: 14px; border-radius: 14px;">
                                    <i class="fas fa-calendar-alt" style="color: #4F46E5; font-size: 1rem; margin-bottom: 6px; display: block;"></i>
                                    <span style="color: #64748B; font-size: 0.7rem; display: block;">DATE</span>
                                    <span style="font-weight: 700; color: #1E293B; font-size: 0.9rem;">${n.date}</span>
                                </div>
                                <div style="background: linear-gradient(135deg, #D1FAE5, #A7F3D0); padding: 14px; border-radius: 14px;">
                                    <i class="fas fa-link" style="color: #059669; font-size: 1rem; margin-bottom: 6px; display: block;"></i>
                                    <span style="color: #64748B; font-size: 0.7rem; display: block;">SOURCE</span>
                                    <span style="font-weight: 700; color: #1E293B; font-size: 0.9rem;">${n.type === 'telegram' ? 'Telegram' : 'Drive'}</span>
                                </div>
                            </div>
                            
                            <a href="${n.link}" target="_blank" style="display: block; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; padding: 14px; border-radius: 16px; text-decoration: none; font-weight: 600; text-align: center; margin-top: 20px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'">
                                Open Note <i class="fas fa-external-link-alt" style="margin-left: 8px;"></i>
                            </a>
                            ${currentUser && currentUser.role === 'cr' ? `
                            <div style="display: flex; gap: 12px; margin-top: 16px;">
                                <button onclick="editNote(${index})" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;"><i class="fas fa-edit"></i> Edit</button>
                                <button onclick="deleteNote(${index})" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #DC2626, #EF4444); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;"><i class="fas fa-trash"></i> Delete</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

            if (currentUser && currentUser.role === 'cr') {
                document.getElementById('addNoteBtn')?.addEventListener('click', () => openModal('note'));
            }
        }

        function renderMembers() {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            const isCR = currentUser.role === 'cr';
            document.getElementById('mainContent').innerHTML = `
            <div style="margin-bottom: 32px;">
                <h1 class="satoshi" style="font-size: 2rem; margin-bottom: 8px;">Account & Settings</h1>
                <p class="text-secondary">Switch between modes</p>
            </div>
            
            <div style="background: white; border-radius: 24px; padding: 32px; border: 1px solid #F1F5F9;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background: linear-gradient(135deg, #EEF2FF, #E0E7FF); border-radius: 16px;">
                    <div class="flex" style="gap: 16px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #6366F1, #8B5CF6); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user-cog" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 4px;">CR Mode</h4>
                            <span class="text-secondary" style="font-size: 0.9rem;">${isCR ? 'Currently active' : 'Enable to manage class'}</span>
                        </div>
                    </div>
                    <div onclick="if(!${isCR}) { document.getElementById('authModal').style.display='flex'; } else { currentUser.role='student'; localStorage.setItem('crMode', 'false'); renderMembers(); }" style="width: 60px; height: 32px; background: ${isCR ? 'linear-gradient(135deg, #6366F1, #8B5CF6)' : '#E2E8F0'}; border-radius: 20px; position: relative; cursor: pointer; transition: all 0.3s;">
                        <div style="width: 26px; height: 26px; background: white; border-radius: 50%; position: absolute; top: 3px; ${isCR ? 'right: 3px' : 'left: 3px'}; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                    </div>
                </div>
            </div>

            ${isCR ? `
            <div style="background: white; border-radius: 24px; padding: 32px; border: 1px solid #F1F5F9; margin-top: 24px;">
                <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 1.2rem;">Current Subjects</h3>
                    <button onclick="window.editingSubjectIndex = null; openModal('subject')" style="padding: 8px 16px; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; border: none; border-radius: 20px; font-size: 0.85rem; cursor: pointer; font-weight: 600;"><i class="fas fa-plus" style="margin-right: 6px;"></i>Add</button>
                </div>
                <div id="subjectsList" style="display: flex; flex-direction: column; gap: 12px;">
                    ${subjects.length === 0 ? '<p class="text-secondary" style="text-align: center; padding: 20px;">No subjects added yet</p>' : subjects.map((s, i) => `
                    <div class="flex" style="justify-content: space-between; align-items: center; padding: 16px; background: #F8FAFC; border-radius: 12px;">
                        <div>
                            <span style="font-weight: 600; color: #1E293B;">${getCourseTitle(s)}</span>
                            ${s.includes('(') ? `<span class="text-secondary" style="font-size: 0.85rem; display: block;">${s.match(/\(([^)]+)\)$/)[1]}</span>` : ''}
                        </div>
                        <div class="flex" style="gap: 8px;">
                            <button onclick="editSubject(${i})" style="padding: 8px 12px; background: white; border: 1px solid #E2E8F0; border-radius: 8px; cursor: pointer; color: #6366F1;"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteSubject(${i})" style="padding: 8px 12px; background: white; border: 1px solid #E2E8F0; border-radius: 8px; cursor: pointer; color: #EF4444;"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            ${isCR ? `
            <div style="margin-top: 32px;">
                <h3 style="margin-bottom: 20px; font-size: 1.2rem;">CR Controls</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                    <div onclick="openModal('note')" style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #F1F5F9; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #10B981, #34D399); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <i class="fas fa-plus" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <h4 style="margin-bottom: 4px;">Add Study Notes</h4>
                        <span class="text-secondary" style="font-size: 0.9rem;">Upload new study materials</span>
                    </div>
                    
                    <div onclick="openModal('notice')" style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #F1F5F9; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #F59E0B, #FBBF24); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <i class="fas fa-bullhorn" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <h4 style="margin-bottom: 4px;">Post Notice</h4>
                        <span class="text-secondary" style="font-size: 0.9rem;">Create class announcements</span>
                    </div>
                    
                    <div onclick="openModal('subject')" style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #F1F5F9; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #06B6D4, #22D3EE); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <i class="fas fa-book-medical" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <h4 style="margin-bottom: 4px;">Add New Subjects</h4>
                        <span class="text-secondary" style="font-size: 0.9rem;">Create new subject cards</span>
                    </div>
                    
                    <div onclick="openModal('routine')" style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #F1F5F9; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #F97316, #FB923C); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <i class="fas fa-calendar-plus" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <h4 style="margin-bottom: 4px;">Post Today's Routine</h4>
                        <span class="text-secondary" style="font-size: 0.9rem;">Update class schedule</span>
                    </div>
                    
                    <div onclick="openModal('ct')" style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #F1F5F9; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #EF4444, #F87171); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <i class="fas fa-file-alt" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <h4 style="margin-bottom: 4px;">New Class Test Schedule</h4>
                        <span class="text-secondary" style="font-size: 0.9rem;">Add CT schedule</span>
                    </div>
                    
                    <div onclick="clearAllDatabase()" style="background: white; border-radius: 20px; padding: 24px; border: 1px solid #FEE2E2; cursor: pointer; transition: all 0.2s; text-align: center;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #DC2626, #EF4444); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <i class="fas fa-trash-alt" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <h4 style="margin-bottom: 4px; color: #DC2626;">Clear Database</h4>
                        <span class="text-secondary" style="font-size: 0.9rem;">Erase all data</span>
                    </div>
                </div>
            </div>
            ` : ''}
        `;
        }

        function renderSyllabus() {
            document.getElementById('mainContent').innerHTML = `
            <h1 class="satoshi" style="font-size: 2rem; margin-bottom: 24px;">Course Syllabus</h1>
            <div style="background: white; border-radius: 32px; padding: 32px; border: 1px solid #F1F5F9;">
                <div style="margin-bottom: 20px;">
                    <div class="flex" style="justify-content: space-between; padding: 20px; background: #F8FAFC; border-radius: 24px; margin-bottom: 12px;">
                        <div><span style="font-weight: 600;">Physics (PHY101)</span><br><span class="text-secondary">Units 1-5</span></div>
                        <i class="fas fa-chevron-down" style="color: #94A3B8;"></i>
                    </div>
                    <div class="flex" style="justify-content: space-between; padding: 20px; background: #F8FAFC; border-radius: 24px; margin-bottom: 12px;">
                        <div><span style="font-weight: 600;">Mathematics (MTH101)</span><br><span class="text-secondary">Calculus & Algebra</span></div>
                        <i class="fas fa-chevron-down" style="color: #94A3B8;"></i>
                    </div>
                    <div class="flex" style="justify-content: space-between; padding: 20px; background: #F8FAFC; border-radius: 24px;">
                        <div><span style="font-weight: 600;">CSE (CSE101)</span><br><span class="text-secondary">Programming Fundamentals</span></div>
                        <i class="fas fa-chevron-down" style="color: #94A3B8;"></i>
                    </div>
                </div>
                <div style="margin-top: 24px; text-align: center;">
                    <a href="#" style="color: #4F46E5; text-decoration: none;">Download complete syllabus PDF →</a>
                </div>
            </div>
        `;
        }

        function renderCalendar() {
            document.getElementById('mainContent').innerHTML = `
            <h1 class="satoshi" style="font-size: 2rem; margin-bottom: 24px;">Exam Calendar</h1>
            <div style="display: grid; grid-template-columns: 1fr 300px; gap: 24px;">
                <div style="background: white; border-radius: 32px; padding: 32px; border: 1px solid #F1F5F9;">
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 16px;">
                        ${['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(d => `<div style="text-align: center; font-weight: 600; color: #64748B;">${d}</div>`).join('')}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
                        ${Array.from({ length: 35 }, (_, i) => `
                            <div style="aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 20px; ${i === 15 ? 'background: #EEF2FF; color: #4F46E5; font-weight:600;' : ''}">
                                ${i + 1}
                                ${i === 15 ? '<div style="width: 6px; height: 6px; background: #4F46E5; border-radius: 6px; margin-top: 2px;"></div>' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div style="background: white; border-radius: 32px; padding: 24px; border: 1px solid #F1F5F9;">
                    <h3 style="margin-bottom: 20px;">Upcoming Exams</h3>
                    <div style="padding: 16px; background: #F8FAFC; border-radius: 20px; margin-bottom: 12px;">
                        <span style="font-weight: 600;">Physics Mid-term</span>
                        <div class="flex" style="justify-content: space-between; margin-top: 8px;">
                            <span class="text-secondary">Mar 15</span>
                            <span style="color: #DC2626;">in 5 days</span>
                        </div>
                    </div>
                    <div style="padding: 16px; background: #F8FAFC; border-radius: 20px;">
                        <span style="font-weight: 600;">Math Quiz</span>
                        <div class="flex" style="justify-content: space-between; margin-top: 8px;">
                            <span class="text-secondary">Mar 18</span>
                            <span style="color: #D97706;">in 8 days</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        }

        function renderCRMode() {
            if (!currentUser || currentUser.role !== 'cr') {
                document.getElementById('mainContent').innerHTML = `
                <div style="margin-bottom: 32px;">
                    <h1 class="satoshi" style="font-size: 2rem; margin-bottom: 8px;">CR Mode</h1>
                    <p class="text-secondary">Authentication required to access CR settings</p>
                </div>

                <div style="background: white; border-radius: 28px; padding: 40px; border: 1px solid #F1F5F9; max-width: 400px; margin: 0 auto; text-align: center;">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #FEE2E2, #FECACA); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                        <i class="fas fa-lock" style="font-size: 2rem; color: #DC2626;"></i>
                    </div>
                    <h3 style="margin-bottom: 12px; color: #1E293B;">Authentication Required</h3>
                    <p class="text-secondary" style="margin-bottom: 24px;">Enter CR password to access settings</p>
                    <input type="password" id="crPasswordInput" oninput="document.getElementById('crAuthError').style.display='none'" placeholder="Enter password" style="width: 100%; padding: 14px 18px; border: 2px solid #E2E8F0; border-radius: 12px; font-size: 1rem; margin-bottom: 16px; box-sizing: border-box;">
                    <div id="crAuthError" style="display: none; background: #FEF2F2; border: 1px solid #EF4444; color: #DC2626; padding: 10px 14px; border-radius: 8px; margin-bottom: 16px; font-size: 0.85rem; text-align: center;">
                        Incorrect password. Please try again.
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="document.getElementById('crPasswordInput').value='';currentPage='dashboard';renderDashboard();" style="flex: 1; padding: 14px; border: 1px solid #E2E8F0; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6B7280;">Cancel</button>
                        <button onclick="const p=document.getElementById('crPasswordInput').value; if(p==='admin123'){currentUser.role='cr';localStorage.setItem('crMode', 'true');document.getElementById('crAuthError').style.display='none';renderCRMode();showToast({type:'success',title:'Welcome!',message:'CR mode enabled'});}else{document.getElementById('crAuthError').style.display='block';}" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-sign-in-alt" style="margin-right: 8px;"></i>Login
                        </button>
                    </div>
                </div>
                `;
                return;
            }

            const iconOptions = [
                { value: 'fa-scroll', label: 'Scroll' },
                { value: 'fa-book', label: 'Book' },
                { value: 'fa-graduation-cap', label: 'Graduation' },
                { value: 'fa-school', label: 'School' },
                { value: 'fa-university', label: 'University' },
                { value: 'fa-users', label: 'Users' },
                { value: 'fa-layer-group', label: 'Layer' },
                { value: 'fa-star', label: 'Star' },
                { value: 'fa-heart', label: 'Heart' },
                { value: 'fa-gem', label: 'Gem' }
            ];

            document.getElementById('mainContent').innerHTML = `
            <div style="margin-bottom: 32px;">
                <div class="flex" style="justify-content: space-between; align-items: center;">
                    <div>
                        <h1 class="satoshi" style="font-size: 2rem; margin-bottom: 8px;">CR Mode Settings</h1>
                        <p class="text-secondary">Manage your class website settings</p>
                    </div>
                    <button onclick="currentUser.role='student';renderCRMode();showToast({type:'info',title:'Logged out',message:'CR mode disabled'});" style="padding: 10px 20px; background: #F1F5F9; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; color: #64748B;">
                        <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i>Logout
                    </button>
                </div>
            </div>

            <div style="background: white; border-radius: 28px; padding: 32px; border: 1px solid #F1F5F9; margin-bottom: 24px;">
                <h3 style="font-size: 1.3rem; margin-bottom: 20px; color: #1E293B;"><i class="fas fa-palette" style="margin-right: 10px; color: #6366F1;"></i>Website Branding</h3>
                
                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Website Name</label>
                    <input type="text" id="websiteNameInput" value="${websiteSettings.websiteName}" 
                        style="width: 100%; padding: 14px 18px; border: 2px solid #E2E8F0; border-radius: 14px; font-size: 1rem; transition: all 0.2s;"
                        onfocus="this.style.borderColor='#6366F1';this.style.boxShadow='0 0 0 4px rgba(99,102,241,0.1)'"
                        onblur="this.style.borderColor='#E2E8F0';this.style.boxShadow='none'">
                </div>

                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #374151;">Logo Icon</label>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
                        ${iconOptions.map(icon => `
                            <div onclick="selectLogoIcon('${icon.value}')" 
                                style="padding: 16px; border-radius: 16px; cursor: pointer; text-align: center; border: 2px solid ${websiteSettings.logoIcon === icon.value ? '#6366F1' : '#E2E8F0'}; background: ${websiteSettings.logoIcon === icon.value ? '#EEF2FF' : '#F8FAFC'}; transition: all 0.2s;"
                                onmouseover="this.style.borderColor='#6366F1'"
                                onmouseout="this.style.borderColor='${websiteSettings.logoIcon === icon.value ? '#6366F1' : '#E2E8F0'}'">
                                <i class="fas ${icon.value}" style="font-size: 1.5rem; color: ${websiteSettings.logoIcon === icon.value ? '#6366F1' : '#64748B'};"></i>
                                <div style="font-size: 0.75rem; margin-top: 6px; color: #64748B;">${icon.label}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <button onclick="saveWebsiteSettings()" 
                    style="padding: 14px 32px; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; border: none; border-radius: 14px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 20px rgba(99,102,241,0.4)'"
                    onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
                    <i class="fas fa-save" style="margin-right: 8px;"></i>Save Changes
                </button>
            </div>

            <div style="background: white; border-radius: 28px; padding: 32px; border: 1px solid #F1F5F9;">
                <h3 style="font-size: 1.3rem; margin-bottom: 20px; color: #1E293B;"><i class="fas fa-eye" style="margin-right: 10px; color: #6366F1;"></i>Preview</h3>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 24px; display: flex; align-items: center; gap: 16px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 14px; border-radius: 14px;">
                        <i class="fas ${websiteSettings.logoIcon}" style="font-size: 1.8rem; color: white;"></i>
                    </div>
                    <span class="satoshi" style="font-size: 1.5rem; font-weight: 700; color: white;">${websiteSettings.websiteName}</span>
                </div>
            </div>
            `;
        }

        function selectLogoIcon(icon) {
            websiteSettings.logoIcon = icon;
            renderCRMode();
        }

        function saveWebsiteSettings() {
            const newName = document.getElementById('websiteNameInput').value.trim();
            if (newName) {
                websiteSettings.websiteName = newName;
                localStorage.setItem('websiteSettings', JSON.stringify(websiteSettings));
                updateLogoDisplay();
                showToast({
                    type: 'success',
                    title: 'Saved!',
                    message: 'Website branding has been updated.'
                });
            }
        }

        function updateLogoDisplay() {
            const sidebarLogo = document.querySelector('.sidebar .logo i');
            const sidebarLogoText = document.querySelector('.sidebar .logo span');
            if (sidebarLogo) sidebarLogo.className = `fas ${websiteSettings.logoIcon}`;
            if (sidebarLogoText) sidebarLogoText.textContent = websiteSettings.websiteName;

            const mobileLogo = document.querySelector('.logo-mobile i');
            const mobileLogoText = document.querySelector('.logo-mobile span');
            if (mobileLogo) mobileLogo.className = `fas ${websiteSettings.logoIcon}`;
            if (mobileLogoText) mobileLogoText.textContent = websiteSettings.websiteName;

            document.title = `${websiteSettings.websiteName} — Class Management`;
        }

        // Auth Modal Functions
        function showAuthModal() {
            // Clear any invalid data and redirect to login
            localStorage.removeItem('currentUser');
            localStorage.removeItem('crMode');
            currentUser = null;
            stopPolling();
            window.location.href = 'login.html';
        }

        function showProfileModal() {
            const savedUser = localStorage.getItem('currentUser');
            if (!savedUser) return;

            const user = JSON.parse(savedUser);
            document.getElementById('profileStudentId').value = user.studentId || '';
            document.getElementById('profileFullName').value = user.name || '';
            document.getElementById('profileNewPassword').value = '';
            document.getElementById('profileError').style.display = 'none';
            document.getElementById('profileModal').style.display = 'flex';
        }

        async function updateProfile() {
            const newName = document.getElementById('profileFullName').value.trim();
            const newPassword = document.getElementById('profileNewPassword').value;
            const errorDiv = document.getElementById('profileError');

            if (!newName) {
                errorDiv.textContent = 'Please enter your name';
                errorDiv.style.display = 'block';
                return;
            }

            const savedUser = localStorage.getItem('currentUser');
            if (!savedUser) return;

            const user = JSON.parse(savedUser);
            user.name = newName;
            localStorage.setItem('currentUser', JSON.stringify(user));
            currentUser = user;

            if (USE_SUPABASE && user.id) {
                try {
                    const updates = { full_name: newName };
                    if (newPassword) {
                        updates.password_hash = newPassword;
                    }
                    await supabaseClient.updateUser(user.id, updates);
                } catch (e) {
                    console.log('Supabase update failed, using localStorage only');
                }
            }

            document.getElementById('profileModal').style.display = 'none';
            updateAuthButton();
            showToast({ type: 'success', title: 'Updated!', message: 'Profile updated successfully' });
        }

        function logout() {
            stopPolling();
            localStorage.removeItem('currentUser');
            localStorage.removeItem('crMode');
            currentUser = null;
            document.getElementById('profileModal').style.display = 'none';
            updateAuthButton();
            document.getElementById('mainContent').innerHTML = '';
            // Redirect to login.html instead of showing auth modal
            window.location.href = 'login.html';
        }

        function updateAuthButton() {
            const container = document.getElementById('authButtonContainer');
            if (currentUser) {
                const initial = currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U';
                container.innerHTML = `
                    <div class="notification-bell" onclick="currentPage='notices';renderNotices();">
                        <i class="far fa-bell"></i>
                        <span class="notification-badge" id="unreadBadge" style="display: none;">0</span>
                    </div>
                    <div onclick="showProfileModal()"
                        style="width: 44px; height: 44px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.1rem; cursor: pointer; margin-right: 12px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s ease;">
                        ${initial}
                    </div>`;
            } else {
                container.innerHTML = `
                    <div class="notification-bell" onclick="currentPage='notices';renderNotices();">
                        <i class="far fa-bell"></i>
                        <span class="notification-badge" id="unreadBadge" style="display: none;">0</span>
                    </div>
                    <button onclick="showAuthModal()"
                        style="background: linear-gradient(135deg, #667eea, #764ba2); border: none; padding: 8px 16px; border-radius: 20px; color: white; cursor: pointer; font-weight: 600; margin-right: 12px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>`;
            }
            updateUnreadBadge();
        }

        function toggleOnlineLink(checkbox, venueId) {
            const venueInput = document.getElementById(venueId);
            if (checkbox.checked) {
                venueInput.setAttribute('data-placeholder', venueInput.getAttribute('placeholder') || 'Room');
                venueInput.setAttribute('placeholder', 'Meeting Link (e.g., meet.google.com/...)');
                venueInput.style.borderColor = '#8B5CF6';
                venueInput.style.background = '#F5F3FF';
            } else {
                const placeholder = venueInput.getAttribute('data-placeholder') || 'Room';
                venueInput.setAttribute('placeholder', placeholder);
                venueInput.style.borderColor = '';
                venueInput.style.background = '';
            }
        }

        function openModal(type) {
            const overlay = document.getElementById('modalOverlay');
            const inner = document.getElementById('modalInner');
            if (type === 'note') {
                inner.innerHTML = `
                <div style="background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                    <div style="background: linear-gradient(135deg, #10B981, #34D399); padding: 24px 32px; text-align: center;">
                        <h2 style="margin-bottom: 4px; color: white; font-size: 1.4rem;">Add New Note</h2>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Upload study materials for your class</p>
                    </div>
                    <form id="noteForm" style="display: flex; flex-direction: column; gap: 16px; padding: 28px 32px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Select Subject</label>
                            <select id="noteSubjectModal" style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; background: white; color: #065F46; font-size: 0.95rem; outline: none;">
                                <option value="">Choose a subject</option>
                                ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Note Title</label>
                            <input type="text" id="noteTitleModal" placeholder="e.g., Chapter 1 Summary" 
                                style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; background: white; color: #1E293B; font-size: 0.95rem; outline: none; box-sizing: border-box;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Short Description</label>
                            <textarea id="noteDescModal" placeholder="Brief description of the note content" rows="3"
                                style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; background: white; color: #1E293B; font-size: 0.95rem; outline: none; resize: none; box-sizing: border-box;"></textarea>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Share Link</label>
                            <input type="text" id="noteLinkModal" placeholder="Telegram or Google Drive link" 
                                style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; background: white; color: #1E293B; font-size: 0.95rem; outline: none; box-sizing: border-box;">
                        </div>
                        
                        <div style="display: flex; gap: 12px; margin-top: 8px;">
                            <button type="button" style="flex: 1; padding: 12px; border: 2px solid #E2E8F0; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6B7280;" id="closeModal">
                                Cancel
                            </button>
                            <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10B981, #34D399); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);">
                                Publish Note
                            </button>
                        </div>
                    </form>
                </div>
            `;
            } else if (type === 'notice') {
                inner.innerHTML = `
                <div style="background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                    <div style="background: linear-gradient(135deg, #F59E0B, #FBBF24); padding: 24px 32px; text-align: center;">
                        <h2 style="margin-bottom: 4px; color: white; font-size: 1.4rem;">Post Notice</h2>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Create class announcements</p>
                    </div>
                    <form id="noticeForm" style="display: flex; flex-direction: column; gap: 16px; padding: 28px 32px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Notice Title</label>
                            <input type="text" id="noticeTitleModal" placeholder="e.g., Exam Schedule, Class Cancelled" 
                                style="width: 100%; padding: 12px 16px; border: 2px solid #FEF3C7; border-radius: 12px; background: white; color: #1E293B; font-size: 0.95rem; outline: none; box-sizing: border-box;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Notice Content</label>
                            <textarea id="noticeDescModal" placeholder="Write your notice message here..." rows="4"
                                style="width: 100%; padding: 12px 16px; border: 2px solid #FEF3C7; border-radius: 12px; background: white; color: #1E293B; font-size: 0.95rem; outline: none; resize: none; box-sizing: border-box;"></textarea>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Priority</label>
                            <select id="noticePriorityModal" style="width: 100%; padding: 12px 16px; border: 2px solid #FEF3C7; border-radius: 12px; background: white; color: #92400E; font-size: 0.95rem; outline: none;">
                                <option value="">Select priority</option>
                                <option value="high">🔴 High Priority</option>
                                <option value="medium">🟡 Medium Priority</option>
                                <option value="low">🟢 Low Priority</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Link (Optional)</label>
                            <input type="url" id="noticeLinkModal" placeholder="https://zoom.us/j/..." 
                                style="width: 100%; padding: 12px 16px; border: 2px solid #FEF3C7; border-radius: 12px; background: white; color: #1E293B; font-size: 0.95rem; outline: none; box-sizing: border-box;">
                        </div>
                        
                        <div style="display: flex; gap: 12px; margin-top: 8px;">
                            <button type="button" style="flex: 1; padding: 12px; border: 2px solid #E2E8F0; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6B7280;" id="closeModal">
                                Cancel
                            </button>
                            <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #F59E0B, #FBBF24); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3);">
                                Post Notice
                            </button>
                        </div>
                    </form>
                </div>
            `;
            } else if (type === 'routine') {
                inner.innerHTML = `
                <div style="background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #6366F1, #8B5CF6); padding: 24px 32px; border-radius: 24px 24px 0 0;">
                        <h3 style="margin-bottom: 4px; text-align: center; color: white; font-size: 1.5rem;">Post Today's Routine</h3>
                        <p style="text-align: center; margin-bottom: 0; color: rgba(255,255,255,0.9); font-size: 0.9rem;">Classes: 8:00 AM - 2:50 PM (50 min each)</p>
                    </div>
                    
                    <div style="padding: 24px;">
                    <div id="routineSlots" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                        ${Array.from({ length: 9 }, (_, i) => {
                    const slotNum = i + 1;
                    const colors = [
                        ['#3B82F6', '#60A5FA'],
                        ['#8B5CF6', '#A78BFA'],
                        ['#F59E0B', '#FBBF24'],
                        ['#10B981', '#34D399'],
                        ['#EF4444', '#F87171'],
                        ['#22C55E', '#4ADE80'],
                        ['#F59E0B', '#FBBF24'],
                        ['#EAB308', '#FACC15'],
                        ['#A855F7', '#C084FC']
                    ];
                    const c = colors[i];
                    const times = ['08:00', '08:50', '09:50', '10:40', '11:30', '12:20', '13:10', '14:00', '14:50'];
                    return `
                                <div style="background: white; padding: 0; border-radius: 18px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #E0E7FF;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 24px rgba(59, 130, 246, 0.15)';this.style.borderColor='#3B82F6'">
                                    <div style="background: linear-gradient(90deg, ${c[0]}, ${c[1]}); padding: 12px 18px;">
                                        <div class="flex" style="justify-content: space-between; align-items: center;">
                                            <div class="flex" style="gap: 12px; align-items: center;">
                                                <span style="background: white; color: ${c[0]}; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">${slotNum}</span>
                                                <span style="color: white; font-weight: 600; font-size: 0.95rem;">${['First', 'Second', 'Third', 'Fourth', 'Fifth', 'Sixth', 'Seventh', 'Eighth', 'Ninth'][i]} Class</span>
                                            </div>
                                            <input type="time" id="slot${slotNum}timeModal" value="${times[i]}" style="padding: 5px 10px; border: none; border-radius: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #1E40AF; font-weight: 600; width: 85px; text-align: center; cursor: pointer;">
                                        </div>
                                    </div>
                                    <div style="padding: 16px;">
                                        <div class="flex" style="gap: 10px;">
                                            <select id="slot${slotNum}subjectModal" style="flex: 1; padding: 10px 12px; border: 1.5px solid #E0E7FF; border-radius: 10px; font-size: 0.85rem; background: #F8FAFC; color: #1E40AF; font-weight: 500;">
                                                <option value="">Select Subject</option>
                                                ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                                            </select>
                                            <input type="text" id="slot${slotNum}venueModal" placeholder="Room" style="width: 80px; padding: 10px 12px; border: 1.5px solid #E0E7FF; border-radius: 10px; font-size: 0.85rem; background: #F8FAFC; color: #1E40AF; font-weight: 500;">
                                            <label class="flex" style="gap: 5px; cursor: pointer; background: #EFF6FF; padding: 8px 12px; border-radius: 10px; border: 1.5px solid #BFDBFE;">
                                                <input type="checkbox" id="slot${slotNum}onlineModal" onchange="toggleOnlineLink(this, 'slot${slotNum}venueModal')" style="accent-color: #3B82F6; width: 16px; height: 16px;"> <span style="font-size: 0.75rem; color: #3B82F6; font-weight: 600;">Online</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button type="button" style="flex: 1; padding: 14px; border: 1px solid #E2E8F0; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #64748B;" id="closeModal">
                            Cancel
                        </button>
                        <button type="button" id="postRoutineBtn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #F97316, #FB923C); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 14px rgba(249, 115, 22, 0.4);">
                            Post Routine
                        </button>
                    </div>
                    </div>
                </div>
            `;
            } else if (type === 'subject') {
                inner.innerHTML = `
                <div style="background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                    <div style="background: linear-gradient(135deg, #10B981, #34D399); padding: 24px 32px; text-align: center;">
                        <h2 style="margin-bottom: 4px; color: white; font-size: 1.4rem;">Add New Subject</h2>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Create a new subject card</p>
                    </div>
                    <div style="padding: 28px 32px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Course Title</label>
                            <input type="text" id="newSubjectNameModal" placeholder="e.g., Physics, Mathematics" style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Course Code</label>
                            <input type="text" id="newSubjectCodeModal" placeholder="e.g., PHY101" style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Course Teacher</label>
                            <input type="text" id="newSubjectTeacherModal" placeholder="e.g., Dr. Rahman" style="width: 100%; padding: 12px 16px; border: 2px solid #D1FAE5; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box;">
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button type="button" onclick="document.getElementById('modalOverlay').style.display='none'" style="flex: 1; padding: 12px; border: 2px solid #D1FAE5; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6B7280;">
                                Cancel
                            </button>
                            <button type="button" onclick="const s=document.getElementById('newSubjectNameModal').value; const c=document.getElementById('newSubjectCodeModal').value; const t=document.getElementById('newSubjectTeacherModal').value; if(s){const fullName = c ? c + ' - ' + s : s; if(window.editingSubjectIndex !== null && window.editingSubjectIndex !== undefined) { subjects[window.editingSubjectIndex] = fullName + (t ? ' (' + t + ')' : ''); window.editingSubjectIndex = null; } else { subjects.push(fullName + (t ? ' (' + t + ')' : '')); } saveSubjects(); document.getElementById('modalOverlay').style.display='none'; showToast({type:'success',title:window.editingSubjectIndex !== null ? 'Updated!' : 'Added!',message:'Subject ' + (window.editingSubjectIndex !== null ? 'updated' : 'added')}); renderMembers();}else{alert('Please enter a subject name');}" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10B981, #34D399); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);">
                                Add Subject
                            </button>
                        </div>
                    </div>
                </div>
            `;
            } else if (type === 'ct') {
                inner.innerHTML = `
                <div style="background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                    <div style="background: linear-gradient(135deg, #EF4444, #F87171); padding: 24px 32px; text-align: center;">
                        <h2 style="margin-bottom: 4px; color: white; font-size: 1.4rem;">New Class Test Schedule</h2>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Add a CT schedule for your class</p>
                    </div>
                    <form id="ctForm" style="display: flex; flex-direction: column; gap: 16px; padding: 28px 32px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Select Subject</label>
                            <select id="ctSubjectModal" style="width: 100%; padding: 12px 16px; border: 2px solid #FEE2E2; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; background: white; color: #991B1B;">
                                ${subjects.map(s => `<option value="${s}">${getCourseTitle(s)}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Date</label>
                            <input type="date" id="ctDateModal" style="width: 100%; padding: 12px 16px; border: 2px solid #FEE2E2; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; color: #991B1B;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Time</label>
                            <input type="text" id="ctTimeModal" placeholder="e.g., 10:00 AM - 12:00 PM" style="width: 100%; padding: 12px 16px; border: 2px solid #FEE2E2; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; color: #991B1B;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Venue</label>
                            <input type="text" id="ctVenueModal" placeholder="e.g., LH201" style="width: 100%; padding: 12px 16px; border: 2px solid #FEE2E2; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; color: #991B1B;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Syllabus</label>
                            <input type="text" id="ctSyllabusModal" placeholder="e.g., Ch 1-5" style="width: 100%; padding: 12px 16px; border: 2px solid #FEE2E2; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; color: #991B1B;">
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 8px;">
                            <button type="button" style="flex: 1; padding: 12px; border: 2px solid #FEE2E2; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6B7280;" id="closeModal">
                                Cancel
                            </button>
                            <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #EF4444, #F87171); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);">
                                Add CT
                            </button>
                        </div>
                    </form>
                </div>
            `;
            }
            overlay.style.display = 'grid';

            document.getElementById('closeModal')?.addEventListener('click', (e) => {
                e.preventDefault();
                overlay.style.display = 'none';
            });

            // Handle CT form submission
            document.getElementById('ctForm')?.addEventListener('submit', function (e) {
                e.preventDefault();
                const s = document.getElementById('ctSubjectModal').value;
                const d = document.getElementById('ctDateModal').value;
                const t = document.getElementById('ctTimeModal').value;
                const v = document.getElementById('ctVenueModal').value;
                const sy = document.getElementById('ctSyllabusModal').value;

                if (d && t && v && sy) {
                    const testSchedule = JSON.parse(localStorage.getItem('classTests')) || [];

                    if (window.editingTestIndex !== undefined && window.editingTestIndex !== null) {
                        testSchedule[window.editingTestIndex] = { subject: s, date: d, time: t, venue: v, chapters: sy };
                        window.editingTestIndex = null;
                    } else {
                        testSchedule.push({ subject: s, date: d, time: t, venue: v, chapters: sy });
                    }

                    localStorage.setItem('classTests', JSON.stringify(testSchedule));
                    classTests = testSchedule;
                    saveClassTests();
                    overlay.style.display = 'none';
                    showToast({ type: 'success', title: window.editingTestIndex !== null ? 'Updated!' : 'Added!', message: 'Class test ' + (window.editingTestIndex !== null ? 'updated' : 'scheduled') });
                    reRenderCurrentPage();
                } else {
                    alert('Please fill all fields');
                }
            });

            // Handle Notice form submission
            document.getElementById('noticeForm')?.addEventListener('submit', function (e) {
                e.preventDefault();
                const title = document.getElementById('noticeTitleModal').value;
                const description = document.getElementById('noticeDescModal').value;
                const priority = document.getElementById('noticePriorityModal').value;
                const link = document.getElementById('noticeLinkModal').value;

                if (title && description && priority) {
                    const newNotice = {
                        id: Date.now(),
                        title: title,
                        priority: priority,
                        description: description,
                        link: link,
                        expiry: '',
                        pinned: false,
                        read: false,
                        created_at: new Date().toISOString()
                    };
                    const existingNotices = JSON.parse(localStorage.getItem('notices')) || [];
                    existingNotices.unshift(newNotice);
                    localStorage.setItem('notices', JSON.stringify(existingNotices));
                    notices = existingNotices;
                    overlay.style.display = 'none';
                    showToast({ type: 'success', title: 'Posted!', message: 'Notice has been published' });
                    saveNotices().then(() => reRenderCurrentPage());
                } else {
                    alert('Please fill all fields');
                }
            });

            // Handle Note form submission
            document.getElementById('noteForm')?.addEventListener('submit', function (e) {
                e.preventDefault();
                const subject = document.getElementById('noteSubjectModal').value;
                const title = document.getElementById('noteTitleModal').value;
                const desc = document.getElementById('noteDescModal').value;
                const link = document.getElementById('noteLinkModal').value;

                if (subject && title && desc) {
                    const existingNotes = JSON.parse(localStorage.getItem('notes')) || [];

                    if (window.editingNoteIndex !== undefined && window.editingNoteIndex !== null) {
                        existingNotes[window.editingNoteIndex] = {
                            ...existingNotes[window.editingNoteIndex],
                            subject: subject,
                            title: title,
                            desc: desc,
                            link: link || '#'
                        };
                        window.editingNoteIndex = null;
                    } else {
                        const newNote = {
                            id: Date.now(),
                            subject: subject,
                            title: title,
                            date: new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }),
                            desc: desc,
                            link: link || '#',
                            type: 'telegram'
                        };
                        existingNotes.unshift(newNote);
                    }

                    localStorage.setItem('notes', JSON.stringify(existingNotes));
                    notes = existingNotes;
                    overlay.style.display = 'none';
                    showToast({ type: 'success', title: window.editingNoteIndex !== null ? 'Updated!' : 'Added!', message: 'Note ' + (window.editingNoteIndex !== null ? 'updated' : 'saved') });
                    saveNotes().then(() => reRenderCurrentPage());
                } else {
                    alert('Please fill all required fields');
                }
            });

            // Handle Post Routine button
            document.getElementById('postRoutineBtn')?.addEventListener('click', function () {
                const routine = [];
                for (let i = 1; i <= 9; i++) {
                    const s = document.getElementById('slot' + i + 'subjectModal');
                    const t = document.getElementById('slot' + i + 'timeModal');
                    const v = document.getElementById('slot' + i + 'venueModal');
                    const o = document.getElementById('slot' + i + 'onlineModal');
                    if (s && s.value) {
                        routine.push({
                            subject: s.value,
                            time: t ? t.value : '--:--',
                            venue: v ? v.value : '',
                            online: o ? o.checked : false
                        });
                    }
                }
                todaysRoutine = routine;
                localStorage.setItem('todaysRoutine', JSON.stringify(routine));
                document.getElementById('modalOverlay').style.display = 'none';
                showToast({ type: 'success', title: 'Posted!', message: 'Routine posted for today' });
                saveTodaysRoutine().then(() => reRenderCurrentPage());
            });

            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.style.display = 'none';
            };
        }

        // navigation
        document.querySelectorAll('[data-page]').forEach(el => {
            el.addEventListener('click', (e) => {
                if (!currentUser) {
                    showAuthModal();
                    return;
                }

                const page = e.currentTarget.dataset.page;
                if (!page) return;

                document.querySelectorAll('.nav-item, .bottom-nav i').forEach(n => n.classList.remove('active'));
                e.currentTarget.classList.add('active');

                currentPage = page;

                if (page === 'dashboard') renderDashboard();
                if (page === 'routine') renderRoutine();
                if (page === 'notices') renderNotices();
                if (page === 'notes') renderNotes();
                if (page === 'members') renderMembers();
                if (page === 'syllabus') renderSyllabus();
                if (page === 'cr-mode') renderCRMode();

                document.getElementById('modalOverlay').style.display = 'none';
            });
        });

        function reRenderCurrentPage() {
            if (currentPage === 'routine') renderRoutine();
            else if (currentPage === 'notes') renderNotes();
            else if (currentPage === 'notices') renderNotices();
            else if (currentPage === 'dashboard') renderDashboard();
            else if (currentPage === 'members') renderMembers();
            else if (currentPage === 'cr-mode') renderCRMode();
        }

        // Initialize - Simplified without awaiting Supabase
        window.addEventListener('DOMContentLoaded', async function () {
            console.log('DOM Content Loaded - Starting initialization');

            try {
                // Initialize AOS
                if (typeof AOS !== 'undefined') {
                    AOS.init({ duration: 600, once: true, easing: 'ease-out' });
                    console.log('AOS initialized');
                }

                // Check localStorage
                console.log('Checking localStorage...');
                const savedUser = localStorage.getItem('currentUser');
                console.log('Saved user exists:', !!savedUser);

                if (!savedUser) {
                    console.log('No user found, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }

                // Parse user
                try {
                    currentUser = JSON.parse(savedUser);
                    console.log('User parsed:', currentUser.name);

                    const savedCRMode = localStorage.getItem('crMode') === 'true';
                    if (savedCRMode) {
                        currentUser.role = 'cr';
                        console.log('CR mode enabled');
                    }
                } catch (e) {
                    console.log('Error parsing user:', e);
                    localStorage.removeItem('currentUser');
                    window.location.href = 'login.html';
                    return;
                }

                // Load from localStorage immediately (synchronously)
                console.log('Loading from localStorage...');
                try {
                    notices = JSON.parse(localStorage.getItem('notices')) || [];
                    notes = JSON.parse(localStorage.getItem('notes')) || [];
                    subjects = JSON.parse(localStorage.getItem('subjects')) || [];
                    todaysRoutine = JSON.parse(localStorage.getItem('todaysRoutine')) || [];
                    classTests = JSON.parse(localStorage.getItem('classTests')) || [];
                    websiteSettings = JSON.parse(localStorage.getItem('websiteSettings')) || { logoIcon: 'fa-scroll', websiteName: 'YE-48' };
                    members = JSON.parse(localStorage.getItem('members')) || ['Aarav Sharma', 'Vivaan Gupta', 'Aditya Kumar', 'Ananya Singh', 'Diya Patel', 'Ishaan Roy', 'Sai Krishna', 'John Mathew', 'Meera Nair', 'Rohan Joshi', 'Priya Shah', 'Karthik Iyer'];
                    loadTermData();

                    console.log('LocalStorage loaded - notices:', notices.length, 'notes:', notes.length);
                } catch (e) {
                    console.log('Error loading from localStorage:', e);
                }

                // Update UI
                console.log('Updating auth button...');
                updateAuthButton();

                // Set current page
                currentPage = 'dashboard';
                console.log('Current page set to:', currentPage);

                // Render dashboard
                console.log('Rendering dashboard...');
                try {
                    renderDashboard();
                    console.log('Dashboard rendered successfully');
                } catch (e) {
                    console.log('Error rendering dashboard:', e);
                    // Fallback simple render
                    const mainContent = document.getElementById('mainContent');
                    if (mainContent) {
                        mainContent.innerHTML = '<div style="padding: 40px; text-align: center;"><h1>Welcome ' + (currentUser.name || 'User') + '!</h1><p>Dashboard is loading...</p></div>';
                    }
                }

                // Hide loading indicator
                const loader = document.getElementById('loadingIndicator');
                if (loader) {
                    loader.style.display = 'none';
                    console.log('Loading indicator hidden');
                }

                // Try to load from Supabase in background ( DON'T await - fire and forget)
                if (USE_SUPABASE) {
                    console.log('Attempting Supabase connection in background...');
                    // Use setTimeout to not block UI
                    setTimeout(function () {
                        initializeData().then(function () {
                            console.log('Supabase background load complete');
                            // Re-render if needed
                            if (currentPage === 'dashboard') {
                                try { renderDashboard(); } catch (e) { }
                            }
                        }).catch(function (e) {
                            console.log('Supabase background load failed:', e);
                        });
                    }, 100);
                }

                console.log('Initialization complete');

            } catch (error) {
                console.log('FATAL ERROR:', error);
                // Show error on screen
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.innerHTML = '<div style="padding: 40px; text-align: center; color: #DC2626;"><h2>Error Loading App</h2><p>' + error.message + '</p><button onclick="window.location.href=\'login.html\'" style="margin-top: 20px; padding: 10px 20px; background: #6366F1; color: white; border: none; border-radius: 8px; cursor: pointer;">Go to Login</button></div>';
                }

                // Hide loader
                const loader = document.getElementById('loadingIndicator');
                if (loader) loader.style.display = 'none';
            }
        });

        window.addEventListener('online', function () {
            console.log('App is online');
            if (currentUser) {
                // Refresh data when back online
                initializeData().then(() => {
                    if (currentPage === 'dashboard') renderDashboard();
                    else if (currentPage === 'notices') renderNotices();
                    else if (currentPage === 'routine') renderRoutine();
                    else if (currentPage === 'notes') renderNotes();
                });
            }
            startPolling();
        });
        window.addEventListener('offline', function () {
            console.log('App is offline');
            stopPolling();
        });

        const bell = document.querySelector('.notification-bell');
        if (bell) {
            bell.addEventListener('click', function () {
                this.classList.add('clicked');
                setTimeout(() => this.classList.remove('clicked'), 500);
                if (currentUser) {
                    currentPage = 'notices';
                    renderNotices();
                    document.querySelectorAll('.nav-item, .bottom-nav i').forEach(n => n.classList.remove('active'));
                    document.querySelectorAll('[data-page="notices"]').forEach(n => n.classList.add('active'));
                } else {
                    showAuthModal();
                }
            });
        }

        const urlParams = new URLSearchParams(window.location.search);
        const linkParam = urlParams.get('link');
        const titleParam = urlParams.get('title');

        if (linkParam) {
            const confirmed = confirm(`Open ${titleParam || 'this link'} in browser?`);
            if (confirmed) {
                window.open(linkParam, '_blank');
            }
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // Expose functions globally
        window.showDeleteConfirm = showDeleteConfirm;
        window.closeDeleteConfirm = closeDeleteConfirm;
        window.showAuthModal = showAuthModal;
        window.showProfileModal = showProfileModal;
        window.updateProfile = updateProfile;
        window.logout = logout;
        window.setNoteFilter = setNoteFilter;
        window.setNoticeFilter = setNoticeFilter;
        window.searchNotes = searchNotes;
        window.openModal = openModal;
        window.editSubject = editSubject;
        window.deleteSubject = deleteSubject;
        window.deleteTest = deleteTest;
        window.editTest = editTest;
        window.deleteNote = deleteNote;
        window.editNote = editNote;
        window.deleteNoticeItem = deleteNoticeItem;
        window.clearAllDatabase = clearAllDatabase;
        window.cancelClearDatabase = cancelClearDatabase;
        window.confirmClearDatabase = confirmClearDatabase;
        window.copyNoticeLink = copyNoticeLink;
        window.toggleOnlineLink = toggleOnlineLink;
        window.selectLogoIcon = selectLogoIcon;
        window.saveWebsiteSettings = saveWebsiteSettings;
        window.reRenderCurrentPage = reRenderCurrentPage;
    </script>

    <!-- Profile Modal -->
    <div id="profileModal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); z-index: 2000; align-items: center; justify-content: center; animation: fadeIn 0.3s ease;">
        <div
            style="background: white; padding: 40px; border-radius: 24px; max-width: 420px; width: 90%; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <button onclick="document.getElementById('profileModal').style.display='none'"
                style="position: absolute; top: 16px; right: 16px; background: #F1F5F9; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1rem; color: #64748B;">✕</button>

            <div style="text-align: center; margin-bottom: 24px;">
                <div
                    style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 16px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);">
                    <i class="fas fa-user" style="color: white; font-size: 2rem;"></i>
                </div>
                <h2 style="margin: 0 0 8px 0; color: #1E293B; font-weight: 700; font-size: 1.5rem;">My Profile</h2>
                <p class="text-secondary">Manage your account</p>
            </div>

            <div style="margin-bottom: 16px;">
                <label
                    style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Student
                    ID</label>
                <input type="text" id="profileStudentId" readonly
                    style="width: 100%; padding: 14px 16px; border: 2px solid #E2E8F0; border-radius: 12px; font-size: 1rem; background: #F8FAFC; color: #64748B; cursor: not-allowed; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 16px;">
                <label
                    style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">Full
                    Name</label>
                <input type="text" id="profileFullName"
                    style="width: 100%; padding: 14px 16px; border: 2px solid #E2E8F0; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 20px;">
                <label
                    style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.9rem;">New
                    Password</label>
                <input type="password" id="profileNewPassword" placeholder="Enter new password"
                    style="width: 100%; padding: 14px 16px; border: 2px solid #E2E8F0; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
            </div>

            <div id="profileError"
                style="display: none; background: #FEF2F2; border: 1px solid #EF4444; color: #DC2626; padding: 12px 16px; border-radius: 12px; margin-bottom: 16px; font-size: 0.9rem; text-align: center;">
            </div>

            <div style="display: flex; gap: 12px;">
                <button onclick="document.getElementById('profileModal').style.display='none'"
                    style="flex: 1; padding: 14px; border: 1px solid #E2E8F0; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6B7280;">Cancel</button>
                <button onclick="updateProfile()"
                    style="flex: 1; padding: 14px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">Save
                    Changes</button>
            </div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #E2E8F0;">
                <button onclick="logout()"
                    style="width: 100%; padding: 14px; background: #FEF2F2; border: 1px solid #EF4444; border-radius: 12px; cursor: pointer; font-weight: 600; color: #DC2626;">
                    <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i>Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Clear Database Confirmation Modal -->
    <div id="clearDbModal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
        <div
            style="background: white; border-radius: 24px; max-width: 420px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.35); overflow: hidden; animation: slideUp 0.3s ease;">
            <div style="background: linear-gradient(135deg, #EF4444, #F87171); padding: 28px 32px; text-align: center;">
                <div
                    style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                    <i class="fas fa-exclamation-triangle" style="color: white; font-size: 1.8rem;"></i>
                </div>
                <h3 style="margin-bottom: 8px; color: white; font-size: 1.4rem;">Clear Database?</h3>
                <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 0;">This action cannot be undone</p>
            </div>
            <div style="padding: 28px 32px;">
                <div
                    style="background: #FEF2F2; border: 1px solid #FEE2E2; border-radius: 16px; padding: 16px; margin-bottom: 24px;">
                    <div class="flex" style="gap: 12px; align-items: flex-start;">
                        <i class="fas fa-info-circle" style="color: #EF4444; margin-top: 2px;"></i>
                        <span style="color: #991B1B; font-size: 0.9rem; line-height: 1.5;">This will permanently delete
                            all notices, notes, routines, CT schedules, members, and settings.</span>
                    </div>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button onclick="cancelClearDatabase()"
                        style="flex: 1; padding: 14px; background: white; border: 2px solid #E2E8F0; border-radius: 14px; cursor: pointer; font-weight: 600; color: #64748B; font-size: 0.95rem; transition: all 0.2s;">Cancel</button>
                    <button onclick="confirmClearDatabase()"
                        style="flex: 1; padding: 14px; background: linear-gradient(135deg, #EF4444, #F87171); border: none; border-radius: 14px; cursor: pointer; font-weight: 600; color: white; font-size: 0.95rem; transition: all 0.2s; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);">Delete
                        Everything</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>